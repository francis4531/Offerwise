<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OfferWise AI - Property Analysis</title>
    <link rel="icon" type="image/svg+xml" href="/logo-icon-only.svg">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF.js for client-side PDF parsing (privacy-first!) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- ğŸ§ª TURK TESTING MODE v5.54.11 - Pure JavaScript, NO React state! -->
    <script>
        window.turkTracker = {
            sessionToken: null,
            isActive: false,
            turkId: null,
            taskId: null,
            
            // Initialize on page load - checks URL params
            init: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const turkId = urlParams.get('turk_id') || urlParams.get('workerId');
                const taskId = urlParams.get('task_id') || urlParams.get('hitId');
                
                if (turkId || taskId) {
                    console.log('ğŸ§ª [TURK] Mode detected:', { turkId, taskId });
                    this.isActive = true;
                    this.turkId = turkId || 'anonymous';
                    this.taskId = taskId || 'unknown';
                    
                    // Show turk banner
                    this.showBanner();
                    
                    // Start session
                    fetch('/api/turk/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            turk_id: this.turkId,
                            task_id: this.taskId,
                            screen_width: window.innerWidth,
                            screen_height: window.innerHeight
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        console.log('ğŸ§ª [TURK] Session started:', data);
                        this.sessionToken = data.session_token;
                    })
                    .catch(err => console.error('ğŸ§ª [TURK] Session error:', err));
                }
            },
            
            // Fire-and-forget tracking - never blocks, never causes re-renders
            track: function(action) {
                if (!this.isActive || !this.sessionToken) return;
                
                console.log('ğŸ§ª [TURK] Track:', action);
                
                // Fire and forget - don't await, don't care about response
                fetch('/api/turk/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_token: this.sessionToken,
                        action: action
                    })
                }).catch(() => {}); // Silently ignore errors
            },
            
            // Show testing banner at top of page
            showBanner: function() {
                const banner = document.createElement('div');
                banner.id = 'turk-banner';
                banner.innerHTML = 'ğŸ§ª <strong>Testing Mode Active</strong> - Your actions are being recorded for quality assurance';
                banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;padding:8px 16px;text-align:center;font-size:14px;z-index:99999;font-family:system-ui,sans-serif;';
                document.body.insertBefore(banner, document.body.firstChild);
            },
            
            // Complete session and show completion code
            complete: function() {
                if (!this.isActive || !this.sessionToken) {
                    alert('No active test session found.');
                    return;
                }
                
                fetch('/api/turk/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_token: this.sessionToken })
                })
                .then(res => res.json())
                .then(data => {
                    this.showCompletionModal(data.completion_code);
                })
                .catch(err => {
                    console.error('ğŸ§ª [TURK] Complete error:', err);
                    alert('Error completing session. Please contact support.');
                });
            },
            
            // Show completion modal - pure HTML, outside React
            showCompletionModal: function(code) {
                const modal = document.createElement('div');
                modal.id = 'turk-completion-modal';
                modal.innerHTML = `
                    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:100000;font-family:system-ui,sans-serif;">
                        <div style="background:#1e293b;border-radius:24px;padding:48px;text-align:center;max-width:500px;border:3px solid #22c55e;">
                            <div style="font-size:64px;margin-bottom:24px;">ğŸ‰</div>
                            <h2 style="font-size:28px;font-weight:800;color:#22c55e;margin:0 0 16px 0;">Test Complete!</h2>
                            <p style="color:#94a3b8;margin-bottom:32px;line-height:1.6;">
                                Thank you for testing OfferWise! Copy this code and paste it into Mechanical Turk to receive payment.
                            </p>
                            <div style="background:#0f172a;padding:24px;border-radius:12px;margin-bottom:24px;border:2px dashed #22c55e;">
                                <div style="color:#64748b;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">
                                    Your Completion Code
                                </div>
                                <div id="turk-code" style="font-size:32px;font-weight:900;color:#22c55e;font-family:monospace;letter-spacing:2px;">
                                    ${code}
                                </div>
                            </div>
                            <button onclick="navigator.clipboard.writeText('${code}');alert('Code copied!');" style="padding:14px 32px;background:#22c55e;color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;margin-right:12px;">
                                ğŸ“‹ Copy Code
                            </button>
                            <button onclick="document.getElementById('turk-completion-modal').remove();" style="padding:14px 32px;background:transparent;color:#94a3b8;border:1px solid #475569;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Hide the banner
                const banner = document.getElementById('turk-banner');
                if (banner) banner.style.display = 'none';
            },
            
            // Rate experience (optional)
            rate: function(stars) {
                if (!this.sessionToken) return;
                fetch('/api/turk/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_token: this.sessionToken, rating: stars })
                }).catch(() => {});
            }
        };
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.turkTracker.init();
        });
    </script>
    
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      @keyframes shine {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, sans-serif;
        background-color: #0f172a;
        color: #e2e8f0;
      }
      
      /* Mobile Responsiveness - Added for Launch */
      @media (max-width: 768px) {
        /* Reduce padding on mobile */
        body {
          font-size: var(--text-body-sm);
        }
        
        /* Make containers full width with less padding */
        [style*="max-width: 600px"],
        [style*="max-width: 800px"],
        [style*="max-width: 1200px"] {
          max-width: 100% !important;
          padding-left: 12px !important;
          padding-right: 12px !important;
        }
        
        /* Make buttons full width on mobile */
        button {
          width: 100% !important;
          padding: 14px !important;
          font-size: var(--text-body) !important;
        }
        
        /* Make input fields full width */
        input[type="text"],
        input[type="file"] {
          width: 100% !important;
          font-size: var(--text-body) !important; /* Prevents zoom on iOS */
        }
        
        /* Adjust title sizes */
        h1 {
          font-size: var(--text-h2) !important;
        }
        
        h2 {
          font-size: var(--text-h3) !important;
        }
        
        h3 {
          font-size: var(--text-body-lg) !important;
        }
        
        /* Make progress bars more touch-friendly */
        [style*="height: '24px'"] {
          height: 32px !important;
        }
        
        /* Reduce margins on mobile */
        [style*="margin-bottom: '40px'"] {
          margin-bottom: 20px !important;
        }
        
        /* Make cards stack on mobile */
        [style*="display: 'flex'"][style*="gap"] {
          flex-direction: column !important;
        }
        
        /* Adjust debug panel on mobile */
        [style*="backgroundColor: '#fef3c7'"] {
          font-size: var(--text-caption-sm) !important;
          padding: 8px !important;
        }
      }
      
      /* Tablet adjustments */
      @media (min-width: 769px) and (max-width: 1024px) {
        [style*="max-width: 1200px"] {
          max-width: 900px !important;
        }
      }
      
      /* Ensure touch targets are large enough */
      @media (hover: none) and (pointer: coarse) {
        button, input, select, textarea {
          min-height: 44px !important;
        }
      }
      
      /* ğŸ¯ Summary Card responsive grid (v5.56) */
      .summary-card-grid {
        display: grid;
        grid-template-columns: auto 1px 1fr 1px 1fr;
        gap: 0;
        padding: 32px;
        align-items: start;
      }
      @media (max-width: 768px) {
        .summary-card-grid {
          grid-template-columns: 1fr !important;
          gap: 24px !important;
          padding: 24px 20px !important;
        }
        .summary-card-grid > .summary-card-divider {
          display: none !important;
        }
        .summary-card-grid > div {
          padding: 0 !important;
        }
        .summary-card-score-col {
          flex-direction: row !important;
          gap: 20px !important;
        }
      }
      @media (min-width: 769px) and (max-width: 1024px) {
        .summary-card-grid {
          padding: 24px !important;
        }
      }
      
      /* ğŸ¨ UI ENHANCEMENT ANIMATIONS (v5.54.0) */
      @keyframes countUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideInFromTop {
        from { transform: translateY(-100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
      }
      
      @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
        50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.5); }
      }
      
      @keyframes drawLine {
        from { width: 0; }
        to { width: 100%; }
      }
      
      .animate-count-up {
        animation: countUp 0.6s ease-out forwards;
      }
      
      .animate-slide-in {
        animation: slideInFromTop 0.4s ease-out forwards;
      }
      
      .animate-fade-scale {
        animation: fadeInScale 0.5s ease-out forwards;
      }
      
      .pulse-glow {
        animation: pulseGlow 2s ease-in-out infinite;
      }
      
      /* Sticky Bar Styles */
      .sticky-summary-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        padding: 12px 24px;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }
      
      .sticky-summary-bar.visible {
        transform: translateY(0);
      }
      
      /* Section Navigation */
      .section-nav {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        padding: 16px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 16px;
        margin-bottom: 32px;
      }
      
      .section-nav-pill {
        padding: 10px 20px;
        border-radius: 25px;
        border: 1px solid rgba(100, 116, 139, 0.3);
        background: transparent;
        color: #94a3b8;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .section-nav-pill:hover {
        background: rgba(96, 165, 250, 0.1);
        border-color: rgba(96, 165, 250, 0.3);
        color: #60a5fa;
      }
      
      .section-nav-pill.active {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border-color: transparent;
        color: white;
      }
      
      /* Tooltip Styles */
      .tooltip-trigger {
        position: relative;
        cursor: help;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      
      .tooltip-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: rgba(100, 116, 139, 0.3);
        color: #94a3b8;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      
      .tooltip-trigger:hover .tooltip-icon {
        background: rgba(96, 165, 250, 0.3);
        color: #60a5fa;
      }
      
      .tooltip-content {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 12px 16px;
        min-width: 250px;
        max-width: 350px;
        z-index: 100;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
      }
      
      .tooltip-trigger:hover .tooltip-content {
        opacity: 1;
        visibility: visible;
      }
      
      /* Collapsible Section Styles */
      .collapsible-header {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-radius: 12px;
        transition: background 0.2s;
      }
      
      .collapsible-header:hover {
        background: rgba(96, 165, 250, 0.05);
      }
      
      .collapsible-icon {
        transition: transform 0.3s ease;
      }
      
      .collapsible-icon.expanded {
        transform: rotate(180deg);
      }
      
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, padding 0.3s ease;
      }
      
      .collapsible-content.expanded {
        max-height: 5000px;
        padding-top: 16px;
      }
      
      /* Print styles for professional PDF reports (Enhanced v5.54.0) */
      @media print {
        /* Hide unnecessary UI elements */
        body {
          background: white !important;
          color: black !important;
        }
        
        /* Hide buttons, navigation, sticky bar */
        button, .nav-button, #upload-container, .sticky-summary-bar, .section-nav, .tooltip-content {
          display: none !important;
        }
        
        /* Show all collapsed sections */
        .collapsible-content {
          max-height: none !important;
          overflow: visible !important;
        }
        
        /* Clean page layout */
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        
        /* Break pages properly */
        .results-section {
          page-break-inside: avoid;
        }
        
        /* Ensure colors print correctly */
        .risk-card, .offer-card {
          border: 2px solid #000 !important;
        }
        
        /* Add page headers */
        @page {
          margin: 1in;
        }
      }
    </style>
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KXYFZ5BYPL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag("js", new Date());
        gtag("config", "G-KXYFZ5BYPL");
    </script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        const OfferWise = () => {
          const [currentStep, setCurrentStep] = useState('loading'); // Start with loading
          const [propertyData, setPropertyData] = useState({});
          const [buyerProfile, setBuyerProfile] = useState({});
          const [result, setResult] = useState(null);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');
          const [hasProfile, setHasProfile] = useState(false);
          // const [showRepairCalculation, setShowRepairCalculation] = useState(false); // Removed for IP protection
          
          // Screenshot Evidence Modal (v5.51.0)
          const [showScreenshotModal, setShowScreenshotModal] = useState(false);
          const [screenshotLoading, setScreenshotLoading] = useState(false);
          const [screenshotImage, setScreenshotImage] = useState(null);
          const [screenshotError, setScreenshotError] = useState('');
          const [screenshotInfo, setScreenshotInfo] = useState({ docType: '', pageNum: 0, title: '', quote: '' });
          const [screenshotZoom, setScreenshotZoom] = useState(1); // 1 = 100%
          
          // File objects for View Source are stored in propertyData (v5.51.5)
          // - propertyData.disclosureFileObj
          // - propertyData.inspectionFileObj
          
          // Analysis progress state (shared between PropertyDocumentsStep and AnalyzeStep)
          const [analysisProgress, setAnalysisProgress] = useState({ current: 0, total: 0, message: '' });
          
          // ğŸ¤– Property Research Agent state
          const [researchData, setResearchData] = useState(null);
          
          // Collapsible section states for patent explanations
          const [showRepairExplanation, setShowRepairExplanation] = useState(false);
          const [showRiskPremiumExplanation, setShowRiskPremiumExplanation] = useState(false);
          const [showTransparencyExplanation, setShowTransparencyExplanation] = useState(false);
          const [showDocumentExtracts, setShowDocumentExtracts] = useState(false); // v5.55.8 - Credibility
          
          // ğŸ›¡ï¸ Consent management state
          const [showConsentModal, setShowConsentModal] = useState(false);
          const [showCredibilityTooltip, setShowCredibilityTooltip] = useState(false);
          const [consentType, setConsentType] = useState('analysis_disclaimer');
          const [consentText, setConsentText] = useState('');
          const [consentVersion, setConsentVersion] = useState('');
          const [consentPending, setConsentPending] = useState(false);
          const [hasAnalysisConsent, setHasAnalysisConsent] = useState(false);
          const [needsConsent, setNeedsConsent] = useState(false);
          const [consentStatuses, setConsentStatuses] = useState([]);
          const [consentCheckComplete, setConsentCheckComplete] = useState(false); // v5.54.10: Gate for upload
          
          // ğŸ¨ UI ENHANCEMENT STATE (v5.54.0)
          // v5.54.10: Use ref for sticky bar to prevent re-renders during upload
          const stickyBarRef = React.useRef(null);
          const [activeSection, setActiveSection] = useState('summary');
          const [collapsedSections, setCollapsedSections] = useState({
            riskDna: true,
            transparency: true,
            predicted: true,
            decisionPath: false
          });
          const [activeTooltip, setActiveTooltip] = useState(null);
          const [animatedScores, setAnimatedScores] = useState(false);
          
          // ğŸ¯ PMF SURVEY STATE (v5.54.50)
          const [showPMFToast, setShowPMFToast] = useState(false);
          const [showPMFModal, setShowPMFModal] = useState(false);
          const [pmfResponse, setPMFResponse] = useState(null);
          
          // PMF Survey: Check if we should show survey after analysis completes
          useEffect(() => {
            if (result && currentStep === 'results') {
              // Get survey status from localStorage
              const surveyData = JSON.parse(localStorage.getItem('pmf_survey') || '{}');
              const analysesCount = (surveyData.analyses_count || 0) + 1;
              
              // Update count
              localStorage.setItem('pmf_survey', JSON.stringify({
                ...surveyData,
                analyses_count: analysesCount
              }));
              
              // Don't show if already responded
              if (surveyData.responded) return;
              
              // Show toast after 1st analysis (delay 3 seconds for them to see results)
              if (analysesCount === 1 && !surveyData.toast_shown) {
                setTimeout(() => {
                  setShowPMFToast(true);
                  localStorage.setItem('pmf_survey', JSON.stringify({
                    ...JSON.parse(localStorage.getItem('pmf_survey') || '{}'),
                    toast_shown: true
                  }));
                }, 3000);
              }
              
              // Show modal after 3rd analysis (delay 2 seconds)
              if (analysesCount === 3 && !surveyData.modal_shown) {
                setTimeout(() => {
                  setShowPMFModal(true);
                  localStorage.setItem('pmf_survey', JSON.stringify({
                    ...JSON.parse(localStorage.getItem('pmf_survey') || '{}'),
                    modal_shown: true
                  }));
                }, 2000);
              }
            }
          }, [result, currentStep]);
          
          // Submit PMF survey response
          const submitPMFSurvey = async (disappointment, extras = {}) => {
            try {
              await fetch('/api/survey/pmf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  disappointment,
                  trigger: extras.trigger || 'in_app',
                  main_benefit: extras.main_benefit || '',
                  improvement: extras.improvement || ''
                })
              });
              
              // Mark as responded
              localStorage.setItem('pmf_survey', JSON.stringify({
                ...JSON.parse(localStorage.getItem('pmf_survey') || '{}'),
                responded: true,
                response: disappointment,
                responded_at: new Date().toISOString()
              }));
              
              setPMFResponse(disappointment);
              setShowPMFToast(false);
              setShowPMFModal(false);
            } catch (err) {
              console.error('PMF survey error:', err);
            }
          };
          
          // PMF Toast Component (subtle, bottom of screen)
          const PMFToast = () => {
            if (!showPMFToast) return null;
            
            return (
              <div style={{
                position: 'fixed',
                bottom: '24px',
                left: '50%',
                transform: 'translateX(-50%)',
                backgroundColor: '#1e293b',
                borderRadius: '16px',
                padding: '16px 24px',
                boxShadow: '0 8px 32px rgba(0,0,0,0.4)',
                border: '1px solid #334155',
                zIndex: 9998,
                maxWidth: '420px',
                width: '90%',
                animation: 'slideUp 0.3s ease-out'
              }}>
                <style>{`
                  @keyframes slideUp {
                    from { transform: translateX(-50%) translateY(100px); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                  }
                `}</style>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                  <div style={{ color: '#e2e8f0', fontSize: '14px', fontWeight: '500' }}>
                    Quick question from the founder ğŸ‘‹
                  </div>
                  <button 
                    onClick={() => setShowPMFToast(false)}
                    style={{ 
                      background: 'none', 
                      border: 'none', 
                      color: '#64748b', 
                      cursor: 'pointer',
                      fontSize: '18px',
                      padding: '0',
                      lineHeight: 1
                    }}
                  >Ã—</button>
                </div>
                
                <div style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '14px' }}>
                  How valuable is OfferWise to your home buying journey?
                </div>
                
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button 
                    onClick={() => submitPMFSurvey('very', { trigger: 'toast_1st' })}
                    style={{
                      flex: 1,
                      padding: '10px',
                      borderRadius: '8px',
                      border: '1px solid #334155',
                      background: '#0f172a',
                      color: '#e2e8f0',
                      cursor: 'pointer',
                      fontSize: '13px',
                      transition: 'all 0.2s'
                    }}
                    onMouseOver={e => e.target.style.borderColor = '#22c55e'}
                    onMouseOut={e => e.target.style.borderColor = '#334155'}
                  >
                    ğŸŒŸ Essential
                  </button>
                  <button 
                    onClick={() => submitPMFSurvey('somewhat', { trigger: 'toast_1st' })}
                    style={{
                      flex: 1,
                      padding: '10px',
                      borderRadius: '8px',
                      border: '1px solid #334155',
                      background: '#0f172a',
                      color: '#e2e8f0',
                      cursor: 'pointer',
                      fontSize: '13px',
                      transition: 'all 0.2s'
                    }}
                    onMouseOver={e => e.target.style.borderColor = '#f59e0b'}
                    onMouseOut={e => e.target.style.borderColor = '#334155'}
                  >
                    ğŸ‘ Helpful
                  </button>
                  <button 
                    onClick={() => submitPMFSurvey('not', { trigger: 'toast_1st' })}
                    style={{
                      flex: 1,
                      padding: '10px',
                      borderRadius: '8px',
                      border: '1px solid #334155',
                      background: '#0f172a',
                      color: '#e2e8f0',
                      cursor: 'pointer',
                      fontSize: '13px',
                      transition: 'all 0.2s'
                    }}
                    onMouseOver={e => e.target.style.borderColor = '#64748b'}
                    onMouseOut={e => e.target.style.borderColor = '#334155'}
                  >
                    ğŸ¤· Nice to have
                  </button>
                </div>
              </div>
            );
          };
          
          // PMF Modal Component (for 3rd analysis - slightly more detailed)
          const PMFModal = () => {
            const [selectedDisappointment, setSelectedDisappointment] = useState(null);
            const [mainBenefit, setMainBenefit] = useState('');
            const [improvement, setImprovement] = useState('');
            const [step, setStep] = useState(1);
            
            if (!showPMFModal) return null;
            
            return (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(0,0,0,0.7)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 9999,
                padding: '20px'
              }}>
                <div style={{
                  backgroundColor: '#1e293b',
                  borderRadius: '20px',
                  padding: '28px',
                  maxWidth: '440px',
                  width: '100%',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.5)',
                  border: '1px solid #334155'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <div style={{ color: '#e2e8f0', fontSize: '18px', fontWeight: '600' }}>
                      {step === 1 ? 'ğŸ¯ Quick feedback' : 'ğŸ’¬ Almost done!'}
                    </div>
                    <button 
                      onClick={() => setShowPMFModal(false)}
                      style={{ 
                        background: 'none', 
                        border: 'none', 
                        color: '#64748b', 
                        cursor: 'pointer',
                        fontSize: '24px',
                        padding: '0',
                        lineHeight: 1
                      }}
                    >Ã—</button>
                  </div>
                  
                  {step === 1 && (
                    <>
                      <div style={{ color: '#94a3b8', fontSize: '14px', marginBottom: '20px' }}>
                        You've analyzed 3 properties! Help us make OfferWise better.
                      </div>
                      
                      <div style={{ color: '#e2e8f0', fontSize: '14px', marginBottom: '14px', fontWeight: '500' }}>
                        How valuable is OfferWise to your home buying journey?
                      </div>
                      
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
                        {[
                          { value: 'very', emoji: 'ğŸŒŸ', label: 'Essential - can\'t imagine buying without it', color: '#22c55e' },
                          { value: 'somewhat', emoji: 'ğŸ‘', label: 'Very helpful - makes the process easier', color: '#f59e0b' },
                          { value: 'not', emoji: 'ğŸ¤·', label: 'Nice to have - useful but not critical', color: '#64748b' }
                        ].map(opt => (
                          <button 
                            key={opt.value}
                            onClick={() => setSelectedDisappointment(opt.value)}
                            style={{
                              padding: '12px 16px',
                              borderRadius: '10px',
                              border: selectedDisappointment === opt.value ? `2px solid ${opt.color}` : '1px solid #334155',
                              background: selectedDisappointment === opt.value ? `${opt.color}15` : '#0f172a',
                              color: '#e2e8f0',
                              cursor: 'pointer',
                              fontSize: '14px',
                              textAlign: 'left',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '12px',
                              transition: 'all 0.2s'
                            }}
                          >
                            <span style={{ fontSize: '20px' }}>{opt.emoji}</span>
                            {opt.label}
                          </button>
                        ))}
                      </div>
                      
                      <button 
                        onClick={() => selectedDisappointment && setStep(2)}
                        disabled={!selectedDisappointment}
                        style={{
                          width: '100%',
                          padding: '12px',
                          borderRadius: '10px',
                          border: 'none',
                          background: selectedDisappointment ? 'linear-gradient(135deg, #3b82f6, #8b5cf6)' : '#334155',
                          color: 'white',
                          cursor: selectedDisappointment ? 'pointer' : 'not-allowed',
                          fontSize: '14px',
                          fontWeight: '600'
                        }}
                      >
                        Continue â†’
                      </button>
                    </>
                  )}
                  
                  {step === 2 && (
                    <>
                      <div style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '16px' }}>
                        Optional - share a bit more (or skip)
                      </div>
                      
                      <div style={{ marginBottom: '16px' }}>
                        <label style={{ color: '#94a3b8', fontSize: '12px', display: 'block', marginBottom: '6px' }}>
                          What's the main benefit you get from OfferWise?
                        </label>
                        <textarea 
                          value={mainBenefit}
                          onChange={e => setMainBenefit(e.target.value)}
                          placeholder="e.g., Saves time, helps me negotiate..."
                          style={{
                            width: '100%',
                            padding: '10px',
                            borderRadius: '8px',
                            border: '1px solid #334155',
                            background: '#0f172a',
                            color: '#e2e8f0',
                            fontSize: '13px',
                            resize: 'none',
                            height: '60px'
                          }}
                        />
                      </div>
                      
                      <div style={{ marginBottom: '20px' }}>
                        <label style={{ color: '#94a3b8', fontSize: '12px', display: 'block', marginBottom: '6px' }}>
                          How could we make it better?
                        </label>
                        <textarea 
                          value={improvement}
                          onChange={e => setImprovement(e.target.value)}
                          placeholder="Any features or improvements..."
                          style={{
                            width: '100%',
                            padding: '10px',
                            borderRadius: '8px',
                            border: '1px solid #334155',
                            background: '#0f172a',
                            color: '#e2e8f0',
                            fontSize: '13px',
                            resize: 'none',
                            height: '60px'
                          }}
                        />
                      </div>
                      
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                          onClick={() => submitPMFSurvey(selectedDisappointment, { 
                            trigger: 'modal_3rd',
                            main_benefit: mainBenefit,
                            improvement: improvement
                          })}
                          style={{
                            flex: 1,
                            padding: '12px',
                            borderRadius: '10px',
                            border: 'none',
                            background: 'linear-gradient(135deg, #3b82f6, #8b5cf6)',
                            color: 'white',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                          }}
                        >
                          Submit
                        </button>
                        <button 
                          onClick={() => submitPMFSurvey(selectedDisappointment, { trigger: 'modal_3rd_skip' })}
                          style={{
                            padding: '12px 20px',
                            borderRadius: '10px',
                            border: '1px solid #334155',
                            background: 'transparent',
                            color: '#64748b',
                            cursor: 'pointer',
                            fontSize: '14px'
                          }}
                        >
                          Skip
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          };
          
          // Track scroll for sticky bar - use DOM manipulation, not state
          // v5.54.51: Only attach when on results step and ref is available
          useEffect(() => {
            if (currentStep !== 'results') return;
            
            const handleScroll = () => {
              if (stickyBarRef.current) {
                if (window.scrollY > 400) {
                  stickyBarRef.current.classList.add('visible');
                } else {
                  stickyBarRef.current.classList.remove('visible');
                }
              }
            };
            
            // Initial check
            handleScroll();
            
            window.addEventListener('scroll', handleScroll);
            return () => window.removeEventListener('scroll', handleScroll);
          }, [currentStep]);
          
          // Trigger score animations when results load
          useEffect(() => {
            if (result && currentStep === 'results') {
              setTimeout(() => setAnimatedScores(true), 300);
            }
          }, [result, currentStep]);
          
          // ğŸ§ª TURK TESTING MODE (v5.54.11)
          // Now implemented as pure JavaScript in window.turkTracker (outside React)
          // No React state = no re-renders = no broken uploads!
          
          // Check consent status on mount
          useEffect(() => {
            console.log('ğŸ” [APP.HTML] Checking consent status...');
            
            // Check consent status from backend (includes analysis history check)
            fetch('/api/consent/status', { credentials: 'include' })
              .then(res => res.json())
              .then(data => {
                console.log('ğŸ“Š [APP.HTML] Consent status response:', data);
                console.log('   - needs_onboarding:', data.needs_onboarding);
                console.log('   - has_preferences:', data.has_preferences);
                console.log('   - all_consented:', data.all_consented);
                
                if (data.needs_onboarding) {
                  // Double-check: Maybe user has analyses in localStorage but not in backend yet?
                  const localAnalyses = JSON.parse(localStorage.getItem('analysis_history') || '[]');
                  const hasLocalAnalyses = localAnalyses.some(a => a.full_result);
                  
                  if (hasLocalAnalyses) {
                    console.log('âœ… [APP.HTML] User has local analyses - treating as returning user');
                    setNeedsConsent(false);
                    setConsentCheckComplete(true); // v5.54.10
                    return;
                  }
                  
                  // User genuinely needs onboarding
                  console.log('ğŸ¯ [APP.HTML] User needs onboarding - redirecting to Settings Legal tab');
                  console.log('âŒ [APP.HTML] REDIRECT TRIGGERED!');
                  window.location.href = '/settings?tab=legal';
                  return;
                }
                
                // User has completed onboarding - show main app
                console.log('âœ… [APP.HTML] Onboarding complete! Showing main app.');
                setNeedsConsent(false);
                setConsentStatuses(data.statuses || []);
                setConsentCheckComplete(true); // v5.54.10
              })
              .catch(err => {
                console.error('âŒ [APP.HTML] Error checking consent:', err);
                // On error, check localStorage as fallback
                const localAnalyses = JSON.parse(localStorage.getItem('analysis_history') || '[]');
                const hasLocalAnalyses = localAnalyses.some(a => a.full_result);
                if (hasLocalAnalyses) {
                  console.log('âœ… [APP.HTML] Using localStorage fallback - user has analyses');
                  setNeedsConsent(false);
                }
                setConsentCheckComplete(true); // v5.54.10: Complete even on error
              });
          }, []);
          
          // Check credits before allowing analysis to start
          const checkCreditsAndStartAnalysis = async () => {
            console.log("");
            console.log("ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³");
            console.log("ğŸ’³ FRONTEND: Checking credits before analysis");
            console.log("ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³");
            
            try {
              console.log("ğŸ“¡ Fetching credits from /api/user/credits...");
              const response = await fetch('/api/user/credits');
              
              console.log(`ğŸ“Š Response status: ${response.status} ${response.statusText}`);
              console.log(`ğŸ“Š Response ok: ${response.ok}`);
              
              if (!response.ok) {
                console.error('âŒ Response not OK!');
                throw new Error('Failed to fetch credits');
              }
              
              const data = await response.json();
              console.log("ğŸ“¦ Response data received:", JSON.stringify(data, null, 2));
              
              const credits = data.credits || 0;
              console.log(`ğŸ’° Credits extracted: ${credits}`);
              console.log(`ğŸ’° Credits type: ${typeof credits}`);
              console.log(`ğŸ’° Raw credits value: ${data.credits}`);
              console.log(`ğŸ” Checking: credits === 0 â†’ ${credits === 0}`);
              console.log(`ğŸ” Checking: credits == 0 â†’ ${credits == 0}`);
              console.log(`ğŸ” Checking: credits <= 0 â†’ ${credits <= 0}`);
              
              if (credits === 0) {
                // No credits - redirect to pricing
                console.error('ğŸš«ğŸš«ğŸš« NO CREDITS AVAILABLE!');
                console.error('ğŸš« Redirecting to pricing page...');
                console.log("ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³");
                console.log("");
                window.location.href = '/pricing?message=' + encodeURIComponent('You need to purchase credits before starting a new analysis.');
                return false;
              }
              
              // Has credits - allow to continue
              console.log(`âœ…âœ…âœ… USER HAS ${credits} CREDITS!`);
              console.log('âœ… Allowing analysis to proceed...');
              console.log("ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³");
              console.log("");
              setCurrentStep('property');
              return true;
            } catch (error) {
              console.error('âŒâŒâŒ ERROR CHECKING CREDITS!');
              console.error('âŒ Error details:', error);
              console.error('âŒ Error message:', error.message);
              console.error('âŒ Error stack:', error.stack);
              console.log("ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³ğŸ’³");
              console.log("");
              // On error, still allow (fail open)
              setCurrentStep('property');
              return true;
            }
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // SCREENSHOT EVIDENCE FEATURE (v5.51.5) - CLIENT-SIDE RENDERING
          // Privacy: PDF never leaves the browser - rendered locally with PDF.js
          // Uses File object from propertyData - passed up from upload step
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          const viewSourceScreenshot = async (docType, pageNum, title, quote = '') => {
            console.log(`ğŸ“¸ VIEW SOURCE CALLED:`, { docType, pageNum, title });
            console.log(`ğŸ“¸ propertyData state:`, propertyData);
            console.log(`ğŸ“¸ disclosureFileObj:`, propertyData?.disclosureFileObj);
            console.log(`ğŸ“¸ inspectionFileObj:`, propertyData?.inspectionFileObj);
            
            // Get the appropriate File object from propertyData
            const pdfFile = docType === 'disclosure' ? propertyData?.disclosureFileObj : propertyData?.inspectionFileObj;
            
            console.log(`ğŸ“¸ Selected pdfFile:`, pdfFile);
            
            if (!pdfFile) {
              console.error(`âŒ PDF FILE NOT FOUND for ${docType}`);
              setScreenshotError(`PDF not available for this analysis.\n\nView Source only works for analyses created in the current browser session. If you're viewing a saved analysis from "My Analyses", the original PDF files are not stored for privacy reasons.`);
              setScreenshotInfo({ docType, pageNum: pageNum || 1, title: title || 'Document Source', quote: quote || '' });
              setShowScreenshotModal(true);
              return;
            }
            
            setScreenshotLoading(true);
            setScreenshotError('');
            setScreenshotImage(null);
            setScreenshotInfo({ docType, pageNum, title, quote: quote || '' });
            setShowScreenshotModal(true);
            
            try {
              // Read File object as ArrayBuffer
              const arrayBuffer = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(pdfFile);
              });
              
              // Load PDF with PDF.js (runs in browser!)
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              
              if (pageNum < 1 || pageNum > pdf.numPages) {
                throw new Error(`Invalid page number. Document has ${pdf.numPages} pages.`);
              }
              
              // Get the specific page
              const page = await pdf.getPage(pageNum);
              
              // Set up canvas for rendering
              const scale = 2.0; // Higher quality for highlighting
              const viewport = page.getViewport({ scale });
              
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              
              // Render the page to canvas
              await page.render({
                canvasContext: context,
                viewport: viewport
              }).promise;
              
              // If we have a quote, try to highlight it
              if (quote && quote.length > 10) {
                try {
                  const textContent = await page.getTextContent();
                  const textItems = textContent.items;
                  
                  // Normalize quote for matching
                  const normalizedQuote = quote.toLowerCase().replace(/\s+/g, ' ').trim();
                  const searchTerms = normalizedQuote.split(' ').filter(t => t.length > 3).slice(0, 5);
                  
                  // Find matching text items
                  let matchedItems = [];
                  let fullText = '';
                  let itemPositions = [];
                  
                  // Build full text and track positions
                  textItems.forEach((item, idx) => {
                    if (item.str) {
                      itemPositions.push({ start: fullText.length, end: fullText.length + item.str.length, idx });
                      fullText += item.str + ' ';
                    }
                  });
                  
                  const normalizedFullText = fullText.toLowerCase();
                  
                  // Find where search terms appear
                  searchTerms.forEach(term => {
                    let pos = normalizedFullText.indexOf(term);
                    while (pos !== -1) {
                      // Find which text item this belongs to
                      itemPositions.forEach(ip => {
                        if (pos >= ip.start && pos < ip.end) {
                          if (!matchedItems.includes(ip.idx)) {
                            matchedItems.push(ip.idx);
                          }
                        }
                      });
                      pos = normalizedFullText.indexOf(term, pos + 1);
                    }
                  });
                  
                  // Draw highlights on matched items
                  if (matchedItems.length > 0) {
                    context.save();
                    context.globalAlpha = 0.35;
                    context.fillStyle = '#fbbf24'; // Yellow highlight
                    
                    matchedItems.forEach(idx => {
                      const item = textItems[idx];
                      if (item && item.transform) {
                        const tx = item.transform;
                        // PDF.js transform: [scaleX, skewX, skewY, scaleY, translateX, translateY]
                        const x = tx[4] * scale;
                        const y = canvas.height - (tx[5] * scale) - (item.height || 12) * scale;
                        const width = item.width ? item.width * scale : item.str.length * 8 * scale;
                        const height = (item.height || 14) * scale;
                        
                        context.fillRect(x - 2, y - 2, width + 4, height + 4);
                      }
                    });
                    
                    context.restore();
                    console.log(`âœ… Highlighted ${matchedItems.length} text regions`);
                  } else {
                    console.log('âš ï¸ Could not find text to highlight');
                  }
                } catch (highlightErr) {
                  console.warn('Could not highlight text:', highlightErr);
                  // Continue without highlighting
                }
              }
              
              // Convert canvas to data URL (image)
              const imageDataUrl = canvas.toDataURL('image/png');
              
              setScreenshotImage(imageDataUrl);
              console.log(`âœ… Screenshot rendered CLIENT-SIDE: page ${pageNum}/${pdf.numPages}`);
              console.log(`ğŸ”’ PRIVACY: PDF never left your browser!`);
              
            } catch (error) {
              console.error('Screenshot error:', error);
              setScreenshotError(error.message || 'Failed to render page. Please try again.');
            } finally {
              setScreenshotLoading(false);
            }
          };
          
          // Check for profile and determine initial step on mount
          useEffect(() => {
            const checkProfileAndLoadData = async () => {
              // Check for ?analysis=<property_id> URL param (e.g. from email link)
              const urlParams = new URLSearchParams(window.location.search);
              const analysisParam = urlParams.get('analysis');
              if (analysisParam) {
                try {
                  console.log('ğŸ“§ Loading analysis from URL param:', analysisParam);
                  const resp = await fetch('/api/user/analyses', { credentials: 'include' });
                  if (resp.ok) {
                    const data = await resp.json();
                    const match = (data.analyses || []).find(a => String(a.property_id) === String(analysisParam));
                    if (match && match.full_result) {
                      setPropertyData({ address: match.property_address, price: match.asking_price });
                      setResult(match.full_result);
                      window.currentAnalysisResult = match.full_result;
                      setCurrentStep('results');
                      // Clean URL without reload
                      window.history.replaceState({}, '', '/app');
                      return;
                    }
                  }
                  console.warn('Analysis not found for property_id:', analysisParam);
                  window.history.replaceState({}, '', '/app');
                } catch (e) {
                  console.error('Error loading analysis from URL:', e);
                }
              }
              
              // Check for loaded analysis from dashboard first
              const loadedAnalysis = sessionStorage.getItem('loaded_analysis');
              if (loadedAnalysis) {
                try {
                  const analysisData = JSON.parse(loadedAnalysis);
                  
                  console.log('Loading analysis from dashboard:', analysisData);
                  
                  // Set property data
                  if (analysisData.property_address && analysisData.property_price) {
                    setPropertyData({
                      address: analysisData.property_address,
                      price: analysisData.property_price
                    });
                  }
                  
                  // Set result to display the analysis
                  setResult(analysisData);
                  window.currentAnalysisResult = analysisData; // For share modal (v5.52.7)
                  setCurrentStep('results');
                  
                  // Clear from sessionStorage
                  sessionStorage.removeItem('loaded_analysis');
                  return;
                } catch (e) {
                  console.error('Error loading saved analysis:', e);
                }
              }
              
              // Check for temp property data (saved when user went to update preferences)
              const tempPropertyData = localStorage.getItem('temp_property_data');
              if (tempPropertyData) {
                try {
                  const restored = JSON.parse(tempPropertyData);
                  console.log('Restoring property data after profile update:', restored);
                  setPropertyData(restored);
                  // Clear temp data
                  localStorage.removeItem('temp_property_data');
                  
                  // CRITICAL FIX: Also load the buyer profile from localStorage
                  const savedProfile = localStorage.getItem('buyer_profile');
                  if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    console.log('âœ… Loading buyer profile after returning from profile page:', profile);
                    const maxBudget = profile.max_budget ? parseInt(profile.max_budget) : 0;
                    setBuyerProfile({
                      max_budget: maxBudget,
                      repair_tolerance: profile.repair_tolerance || 'moderate',
                      biggest_regret: profile.biggest_regret || ''
                    });
                  }
                  
                  // ğŸ›¡ï¸ SAFETY: Check credits before allowing analysis
                  // Set to analysis step so user can continue where they left off
                  // But don't auto-start - they still need to click Analyze button
                  setCurrentStep('analysis');
                  setHasProfile(true);
                  return;
                } catch (e) {
                  console.error('Error restoring temp property data:', e);
                }
              }
              
              // Check if buyer profile exists - fetch from API instead of localStorage
              console.log('ğŸ” [APP] Fetching buyer preferences from API...');
              try {
                const prefResponse = await fetch('/api/user/preferences', { credentials: 'include' });
                const prefData = await prefResponse.json();
                
                console.log('ğŸ“Š [APP] Preferences from API:', prefData);
                
                // Check if preferences exist
                if (prefData.max_budget !== null || prefData.repair_tolerance !== null || prefData.biggest_regret !== null) {
                  // Preferences exist - use them!
                  console.log('âœ… [APP] Preferences found! Loading profile...');
                  
                  const maxBudget = prefData.max_budget ? parseInt(prefData.max_budget) : 0;
                  
                  setBuyerProfile({
                    max_budget: maxBudget,
                    repair_tolerance: prefData.repair_tolerance || 'moderate',
                    biggest_regret: prefData.biggest_regret || ''
                  });
                  setHasProfile(true);
                  console.log('âœ… [APP] Loaded buyer profile from API');
                  setCurrentStep('property'); // Go to property step
                } else {
                  // No preferences - redirect to Settings Legal tab
                  console.log('âš ï¸ [APP] No preferences found - redirecting to Settings Legal');
                  setHasProfile(false);
                  window.location.href = '/settings?tab=legal';
                  return;
                }
              } catch (e) {
                console.error('âŒ [APP] Error fetching preferences:', e);
                setHasProfile(false);
                // On error, redirect to Settings Legal tab
                console.log('ğŸš€ [APP] Error fetching preferences - redirecting to Settings Legal');
                window.location.href = '/settings?tab=legal';
                return;
              }
            };
            
            checkProfileAndLoadData();
          }, []);
          
          // Combined Property & Documents Step
          
          // Function to save completed analysis to localStorage
          const saveAnalysisToHistory = async (analysisResult, propertyData, buyerProfile) => {
            try {
              // Get existing history
              const history = JSON.parse(localStorage.getItem('analysis_history') || '[]');
              
              // Extract risk score - it might be an object with overall_risk_score property
              const riskScore = typeof analysisResult.risk_score === 'object' 
                ? (analysisResult.risk_score.overall_risk_score || analysisResult.risk_score.buyer_adjusted_score || 0)
                : analysisResult.risk_score;
              
              // Extract risk level/tier
              const riskLevel = typeof analysisResult.risk_score === 'object'
                ? (analysisResult.risk_score.risk_tier || analysisResult.risk_level || 'UNKNOWN')
                : (analysisResult.risk_level || 'UNKNOWN');
              
              // Create analysis record
              const analysisRecord = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                analyzed_at: new Date().toISOString(),
                property_address: propertyData.address,
                asking_price: parseFloat(propertyData.price),
                risk_score: Math.round(parseFloat(riskScore)),  // Round to whole number
                // Extract recommended_offer from nested offer_strategy object
                recommended_offer: analysisResult.offer_strategy?.recommended_offer || 
                                   analysisResult.recommended_offer ||
                                   parseFloat(propertyData.price),
                // Calculate potential savings correctly
                potential_savings: parseFloat(propertyData.price) - 
                                   (analysisResult.offer_strategy?.recommended_offer || 
                                    analysisResult.recommended_offer ||
                                    parseFloat(propertyData.price)),
                discount_percentage: analysisResult.offer_strategy?.discount_percentage || 
                                     analysisResult.discount_percentage || 0,
                risk_level: riskLevel,
                buyer_budget: buyerProfile.max_budget,
                repair_tolerance: buyerProfile.repair_tolerance,
                // Store full result for viewing later
                full_result: analysisResult,
                property_data: propertyData,
                buyer_profile: buyerProfile
              };
              
              // Add to beginning of array (most recent first)
              history.unshift(analysisRecord);
              
              // Keep only last 50 analyses
              const trimmedHistory = history.slice(0, 50);
              
              // Save back to localStorage
              localStorage.setItem('analysis_history', JSON.stringify(trimmedHistory));
              
              console.log('Saved analysis to history:', analysisRecord);
              
              // CRITICAL: Also save to backend database for cross-device sync
              try {
                console.log('ğŸ’¾ Saving analysis to backend database...');
                const saveResponse = await fetch('/api/user/analyses', {
                  method: 'POST',
                  headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  credentials: 'include',
                  body: JSON.stringify(analysisRecord)
                });
                
                if (saveResponse.ok) {
                  console.log('âœ… Analysis saved to backend successfully');
                } else {
                  console.warn('âš ï¸ Backend save failed, but localStorage save succeeded');
                }
              } catch (backendError) {
                console.warn('âš ï¸ Could not save to backend:', backendError);
                console.log('ğŸ“± Analysis saved to localStorage only (device-specific)');
              }
              
            } catch (error) {
              console.error('Error saving analysis to history:', error);
            }
          };
          
          const PropertyDocumentsStep = () => {
            // v5.54.10: ALL state is LOCAL - including error!
            // CRITICAL: Do NOT use parent's setError() - it causes re-renders that destroy this component
            const [address, setAddress] = useState('');
            const [price, setPrice] = useState('');
            const [disclosureText, setDisclosureText] = useState('');
            const [inspectionText, setInspectionText] = useState('');
            const [disclosureFile, setDisclosureFile] = useState(null);
            const [inspectionFile, setInspectionFile] = useState(null);
            const [localError, setLocalError] = useState(''); // v5.54.10: Local error state!
            
            // ğŸ¤– Property Research Agent state
            const [agentStatus, setAgentStatus] = useState('idle'); // idle | running | complete | error
            const [agentResults, setAgentResults] = useState(null);
            const [agentExpanded, setAgentExpanded] = useState(false);
            const [agentStartTime, setAgentStartTime] = useState(null);
            
            // ğŸ¤– Trigger agent research when address is complete
            const triggerAgentResearch = async (addr) => {
              if (!addr || addr.trim().length < 15 || agentStatus === 'running') return;
              
              // Must look like a real address (has number + street + city/state)
              if (!/\d+.*[a-zA-Z].*,/.test(addr)) return;
              
              console.log('ğŸ¤– Agent: Starting research for', addr);
              setAgentStatus('running');
              setAgentStartTime(Date.now());
              setAgentExpanded(true);
              
              try {
                const resp = await fetch('/api/research', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ address: addr.trim() })
                });
                
                if (!resp.ok) throw new Error('Research request failed');
                
                const data = await resp.json();
                console.log('ğŸ¤– Agent: Research complete', data);
                setAgentResults(data);
                setAgentStatus('complete');
                setResearchData(data); // Store in parent for results page
                
                // Auto-collapse after 5 seconds if user is busy uploading
                setTimeout(() => setAgentExpanded(false), 8000);
              } catch (err) {
                console.error('ğŸ¤– Agent: Research failed', err);
                setAgentStatus('error');
              }
            };
            
            // PARALLEL UPLOAD STATES - Each document uploads independently
            const [uploadingDisclosure, setUploadingDisclosure] = useState(false);
            const [uploadingInspection, setUploadingInspection] = useState(false);
            const [disclosureProgress, setDisclosureProgress] = useState({ current: 0, total: 0, message: '' });
            const [inspectionProgress, setInspectionProgress] = useState({ current: 0, total: 0, message: '' });
            const [disclosurePollInterval, setDisclosurePollInterval] = useState(null);
            const [inspectionPollInterval, setInspectionPollInterval] = useState(null);
            
            const [progressInterval, setProgressInterval] = useState(null);
            const [idleCount, setIdleCount] = useState(0); // Track consecutive idle responses
            
            // Cleanup polling ONLY on component unmount (not on state changes!)
            useEffect(() => {
              // Cleanup function when component unmounts
              return () => {
                // Clean up all polling intervals
                // NOTE: We capture the current values when cleanup runs
                // This only runs on unmount, not on every state change
                if (progressInterval) {
                  clearInterval(progressInterval);
                  console.log('ğŸ§¹ Cleaned up analysis polling interval on unmount');
                }
                if (disclosurePollInterval) {
                  clearInterval(disclosurePollInterval);
                  console.log('ğŸ§¹ Cleaned up disclosure polling interval on unmount');
                }
                if (inspectionPollInterval) {
                  clearInterval(inspectionPollInterval);
                  console.log('ğŸ§¹ Cleaned up inspection polling interval on unmount');
                }
              };
            }, []); // âœ… Empty deps array = only run cleanup on unmount!
            
            // Pause/resume polling when page visibility changes (but don't cancel jobs!)
            useEffect(() => {
              const handleVisibilityChange = () => {
                if (document.hidden) {
                  console.log('â¸ï¸ Page hidden - pausing progress polling (jobs will continue)');
                  // Just pause polling, don't cancel jobs
                  // Jobs will continue in background and complete
                  // When user returns, we can resume polling
                } else {
                  console.log('ğŸ‘ï¸ Page visible - resuming progress polling');
                  // Resume polling for active uploads
                  // Note: Polling will naturally resume on next check
                }
              };
              
              document.addEventListener('visibilitychange', handleVisibilityChange);
              
              return () => {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
              };
            }, [progressInterval, disclosurePollInterval, inspectionPollInterval]);
            
            // Cancel OCR only when user actually closes tab/window (not just switching tabs)
            useEffect(() => {
              const handleBeforeUnload = (e) => {
                if (uploadingDisclosure || uploadingInspection) {
                  console.log('ğŸ›‘ User closing page - canceling OCR to save costs');
                  // Only cancel if user is actually leaving the site
                  // Note: Switching tabs won't trigger this, only closing window
                  cancelOCRProcessing();
                }
              };
              
              window.addEventListener('beforeunload', handleBeforeUnload);
              
              return () => {
                window.removeEventListener('beforeunload', handleBeforeUnload);
              };
            }, [uploadingDisclosure, uploadingInspection]);
            
            // Function to cancel backend OCR processing
            const cancelOCRProcessing = async () => {
              try {
                await fetch('/api/cancel-ocr', {
                  method: 'POST',
                  credentials: 'include'
                });
                console.log('âœ… OCR cancellation signal sent');
              } catch (error) {
                console.error('Failed to send cancellation signal:', error);
              }
            };
            
            // Poll for OCR progress
            const startProgressPolling = () => {
              setIdleCount(0); // Reset idle counter when starting
              console.log('ğŸ”„ Starting progress polling...');
              const interval = setInterval(async () => {
                try {
                  const response = await fetch('/api/ocr-progress', {
                    credentials: 'include'  // Include session cookies
                  });
                  if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“Š Progress update:', data);
                    setProgress(data);
                    
                    // Stop polling if we keep getting idle status (no OCR in progress)
                    if (data.status === 'idle' || (data.current === 0 && data.total === 0)) {
                      setIdleCount(prev => {
                        const newCount = prev + 1;
                        // Stop after 5 consecutive idle responses (~5 seconds)
                        if (newCount >= 5) {
                          console.log('â¹ï¸ Stopping polling - received idle status 5 times');
                          stopProgressPolling();
                        }
                        return newCount;
                      });
                    } else {
                      setIdleCount(0); // Reset counter if we get actual progress
                    }
                  }
                } catch (error) {
                  console.error('Progress polling error:', error);
                  // Stop polling on persistent errors
                  setIdleCount(prev => {
                    const newCount = prev + 1;
                    if (newCount >= 3) {
                      console.log('â¹ï¸ Stopping polling - too many errors');
                      stopProgressPolling();
                    }
                    return newCount;
                  });
                }
              }, 1000); // Poll every second
              
              setProgressInterval(interval);
            };
            
            const stopProgressPolling = () => {
              if (progressInterval) {
                clearInterval(progressInterval);
                setProgressInterval(null);
              }
              setProgress({ current: 0, total: 0, message: '' });
              setIdleCount(0); // Reset idle counter
            };
            
            const handleFileUpload = async (file, type) => {
              console.log(`ğŸš€ [${type}] Starting CLIENT-SIDE PDF parsing:`, file.name);
              console.log(`ğŸ“„ File size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
              console.log(`ğŸ”’ PRIVACY: PDF will be parsed in YOUR browser - never uploaded to server!`);
              
              // Set uploading state for this specific document
              if (type === 'disclosure') {
                setUploadingDisclosure(true);
                setDisclosureProgress({ current: 0, total: 100, message: 'Reading PDF in your browser...' });
              } else {
                setUploadingInspection(true);
                setInspectionProgress({ current: 0, total: 100, message: 'Reading PDF in your browser...' });
              }
              
              setLocalError('');  // v5.54.10: Use local error state
              
              try {
                // Check file size (100MB limit)
                const maxSize = 100 * 1024 * 1024;
                if (file.size > maxSize) {
                  throw new Error(`File too large. Maximum file size is 100 MB. Your file is ${(file.size / 1024 / 1024).toFixed(1)} MB.`);
                }
                
                // Check if it's a PDF
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                  throw new Error('Please upload a PDF file. Other formats are not currently supported.');
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CLIENT-SIDE PDF PARSING (Privacy-First Architecture!)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                console.log('ğŸ“– Loading PDF into browser memory...');
                if (type === 'disclosure') {
                  setDisclosureProgress({ current: 10, total: 100, message: 'ğŸ”’ Loading PDF (stays on your device)...' });
                } else {
                  setInspectionProgress({ current: 10, total: 100, message: 'ğŸ”’ Loading PDF (stays on your device)...' });
                }
                
                // Read file as ArrayBuffer (in browser!)
                const arrayBuffer = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.onerror = reject;
                  reader.readAsArrayBuffer(file);
                });
                
                console.log('âœ… PDF loaded into browser memory');
                
                if (type === 'disclosure') {
                  setDisclosureProgress({ current: 20, total: 100, message: 'Parsing PDF pages...' });
                } else {
                  setInspectionProgress({ current: 20, total: 100, message: 'Parsing PDF pages...' });
                }
                
                // Load PDF with PDF.js (Mozilla's library - runs in browser!)
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const numPages = pdf.numPages;
                
                console.log(`ğŸ“„ PDF has ${numPages} pages`);
                console.log(`ğŸ”’ Extracting text IN YOUR BROWSER (not sending file to server)...`);
                
                let extractedText = '';
                let processedPages = 0;
                
                // Extract text from each page
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                  // Update progress
                  const progress = 20 + Math.floor((pageNum / numPages) * 60);
                  if (type === 'disclosure') {
                    setDisclosureProgress({ 
                      current: progress, 
                      total: 100, 
                      message: `Extracting text from page ${pageNum}/${numPages}...` 
                    });
                  } else {
                    setInspectionProgress({ 
                      current: progress, 
                      total: 100, 
                      message: `Extracting text from page ${pageNum}/${numPages}...` 
                    });
                  }
                  
                  try {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    extractedText += `\n\n=== Page ${pageNum} ===\n${pageText}`;
                    processedPages++;
                    
                    console.log(`âœ“ Page ${pageNum}/${numPages} extracted (${pageText.length} chars)`);
                  } catch (pageError) {
                    console.warn(`âš ï¸ Could not extract text from page ${pageNum}:`, pageError);
                    extractedText += `\n\n=== Page ${pageNum} - Could not extract text ===\n`;
                  }
                }
                
                console.log(`âœ… Client-side extraction complete!`);
                console.log(`ğŸ“Š Total text extracted: ${extractedText.length} characters`);
                console.log(`ğŸ“„ Pages processed: ${processedPages}/${numPages}`);
                console.log(`ğŸ”’ PRIVACY PROTECTED: Your PDF never left your device!`);
                
                // Check if we got meaningful text
                if (extractedText.trim().length < 100) {
                  throw new Error(
                    'This PDF appears to be scanned or image-based. ' +
                    'OfferWise works best with typed/digital PDFs that contain selectable text. ' +
                    '\n\nPlease try: ' +
                    '\nâ€¢ Using the original digital PDF (not a scanned copy)' +
                    '\nâ€¢ Converting scanned PDFs to text first' +
                    '\nâ€¢ Requesting a digital copy from your agent'
                  );
                }
                
                if (type === 'disclosure') {
                  setDisclosureProgress({ current: 90, total: 100, message: 'Text extracted! Finalizing...' });
                } else {
                  setInspectionProgress({ current: 90, total: 100, message: 'Text extracted! Finalizing...' });
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // SEND ONLY TEXT TO SERVER (NOT THE PDF!)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                console.log(`ğŸ“¤ Sending extracted TEXT to server (${extractedText.length} chars)`);
                console.log(`ğŸ”’ File name sent: ${file.name} (for logging only)`);
                console.log(`âŒ PDF file: NEVER SENT - stays on your device!`);
                
                // Store extracted text in state
                if (type === 'disclosure') {
                  setDisclosureText(extractedText);
                  setDisclosureFile({
                    name: file.name,
                    size: file.size,
                    text: extractedText,
                    pages: numPages,
                    extractedLocally: true,  // Flag that this was processed client-side
                    fileObject: file  // Keep File reference for View Source feature (v5.51.5)
                  });
                  
                  setDisclosureProgress({ current: 100, total: 100, message: 'âœ… Complete! PDF parsed locally.' });
                  setTimeout(() => setUploadingDisclosure(false), 500);
                } else {
                  setInspectionText(extractedText);
                  setInspectionFile({
                    name: file.name,
                    size: file.size,
                    text: extractedText,
                    pages: numPages,
                    extractedLocally: true,  // Flag that this was processed client-side
                    fileObject: file  // Keep File reference for View Source feature (v5.51.5)
                  });
                  
                  setInspectionProgress({ current: 100, total: 100, message: 'âœ… Complete! PDF parsed locally.' });
                  setTimeout(() => setUploadingInspection(false), 500);
                }
                
                console.log(`âœ… ${type} processing complete!`);
                console.log(`ğŸ‰ SUCCESS: Client-side parsing took ${(performance.now() / 1000).toFixed(1)}s`);
                console.log(`ğŸ”’ YOUR PRIVACY: PDF file stayed on your device, only text was extracted`);
                
                // ğŸ§ª Turk tracking (v5.54.11) - fire and forget, no state
                if (window.turkTracker) window.turkTracker.track(`upload_${type}_complete`);
                
              } catch (err) {  // v5.54.10: Renamed to err to avoid confusion with error state
                console.error(`âŒ [${type}] Error:`, err);
                setLocalError(err.message || 'Failed to process PDF. Please try again.');
                
                if (type === 'disclosure') {
                  setUploadingDisclosure(false);
                  setDisclosureProgress({ current: 0, total: 100, message: '' });
                } else {
                  setUploadingInspection(false);
                  setInspectionProgress({ current: 0, total: 100, message: '' });
                }
              }
            };
            const handleContinue = () => {
              // v5.54.8: Using local state (address, price from useState above)
              
              console.log('ğŸš€ handleContinue called!');
              console.log('ğŸ“Š Current state:', {
                address: address,
                price: price,
                hasDisclosureText: !!disclosureText,
                hasInspectionText: !!inspectionText,
                disclosureTextLength: disclosureText?.length || 0,
                inspectionTextLength: inspectionText?.length || 0,
                uploadingDisclosure: uploadingDisclosure,
                uploadingInspection: uploadingInspection
              });
              
              // Robust price parsing with validation
              let cleanPrice;
              try {
                const priceStr = String(price).replace(/[^0-9]/g, '');
                console.log('Price parsing:', { original: price, cleaned: priceStr });
                
                cleanPrice = parseInt(priceStr, 10);
                
                if (isNaN(cleanPrice) || cleanPrice <= 0) {
                  alert('Please enter a valid price (numbers only, greater than $0)');
                  return;
                }
                
                // v5.54.12: Validate realistic house price range
                if (cleanPrice < 10000) {
                  alert('Price seems too low for a property. Please enter a realistic asking price (minimum $10,000).');
                  return;
                }
                
                if (cleanPrice > 100000000) {
                  alert('Price must be less than $100,000,000');
                  return;
                }
                
                console.log('âœ… Price parsed successfully:', cleanPrice.toLocaleString());
              } catch (e) {
                console.error('âŒ Price parsing error:', e);
                alert('Error parsing price. Please enter numbers only.');
                return;
              }
              
              // v5.54.12: Validate address has minimum content
              // v5.54.12: Validate address has minimum content
              if (!address.trim() || address.trim().length < 10) {
                alert('Please enter a complete property address (e.g., 123 Main Street, San Jose, CA)');
                return;
              }
              
              if (!disclosureText) {
                alert('Please upload seller disclosure document');
                return;
              }
              
              const propertyDataToStore = { 
                address: address.trim(), 
                price: cleanPrice,  // Store as number
                disclosureText,
                inspectionText,
                // File objects for View Source feature (v5.51.5)
                disclosureFileObj: disclosureFile?.fileObject || null,
                inspectionFileObj: inspectionFile?.fileObject || null
              };
              
              console.log('âœ… Setting property data:', {
                address: propertyDataToStore.address,
                price: propertyDataToStore.price,
                priceFormatted: propertyDataToStore.price.toLocaleString(),
                hasDisclosure: !!propertyDataToStore.disclosureText,
                hasInspection: !!propertyDataToStore.inspectionText,
                // Debug View Source feature
                disclosureFileAvailable: !!propertyDataToStore.disclosureFileObj,
                inspectionFileAvailable: !!propertyDataToStore.inspectionFileObj,
                disclosureFileType: propertyDataToStore.disclosureFileObj?.constructor?.name,
                inspectionFileType: propertyDataToStore.inspectionFileObj?.constructor?.name
              });
              
              // Extra debug logging
              console.log('ğŸ“¸ View Source Debug:', {
                disclosureFileState: disclosureFile,
                inspectionFileState: inspectionFile,
                disclosureFileObj: disclosureFile?.fileObject,
                inspectionFileObj: inspectionFile?.fileObject
              });
              
              console.log('ğŸ¯ Calling setPropertyData...');
              setPropertyData(propertyDataToStore);
              console.log('ğŸ¯ Calling setCurrentStep("analysis")...');
              setCurrentStep('analysis');
              console.log('âœ… handleContinue complete!');
              
              // ğŸ§ª Turk tracking (v5.54.11) - fire and forget, no state
              if (window.turkTracker) window.turkTracker.track('continue_to_analysis');
            };
            
            // REMOVED AUTO-CONTINUE: User must click "Continue" button after uploads
            // This gives user chance to review uploads before proceeding
            
            
            return (
              <div style={styles.container}>
                {/* Consent Required Banner */}
                {needsConsent && (
                  <div style={{
                    background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                    color: 'white',
                    padding: '16px 24px',
                    borderRadius: '12px',
                    marginBottom: '24px',
                    boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    flexWrap: 'wrap',
                    gap: '16px'
                  }}>
                    <div style={{ flex: 1, minWidth: '250px' }}>
                      <div style={{ fontSize: '18px', fontWeight: '700', marginBottom: '6px' }}>
                        âš ï¸ Action Required: Legal Agreements
                      </div>
                      <div style={{ fontSize: '14px', opacity: 0.95 }}>
                        Please review and accept our terms before using OfferWise. Go to Settings to complete this step.
                      </div>
                    </div>
                    <a 
                      href="/settings"
                      style={{
                        background: 'white',
                        color: '#ef4444',
                        padding: '12px 24px',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '700',
                        textDecoration: 'none',
                        transition: 'transform 0.2s',
                        display: 'inline-block'
                      }}
                      onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      ğŸ“‹ Go to Settings â†’
                    </a>
                  </div>
                )}
                
                <h2 style={{...styles.subtitle, marginTop: '32px'}}>Property Details & Documents</h2>
                
                {localError && <div style={styles.error}>{localError}</div>}
                
                {/* Property Information Section */}
                <div style={styles.section}>
                  <h3 style={styles.sectionTitle}>Property Information</h3>
                  
                  <input
                    type="text"
                    placeholder="Property Address (e.g., 123 Main Street, San Jose, CA)"
                    value={address}
                    onChange={(e) => {
                      // v5.54.12: Only allow alphanumeric, spaces, commas, periods, hyphens, # for addresses
                      const sanitized = e.target.value.replace(/[^a-zA-Z0-9\s,.\-#]/g, '');
                      setAddress(sanitized);
                    }}
                    onBlur={(e) => {
                      // ğŸ¤– Trigger agent research when user leaves the address field
                      triggerAgentResearch(e.target.value);
                    }}
                    style={styles.input}
                    maxLength={200}
                  />
                  
                  {/* ğŸ¤– Property Research Agent Panel */}
                  {agentStatus !== 'idle' && (
                    <div style={{
                      background: agentStatus === 'complete' ? 'rgba(34, 197, 94, 0.05)' : agentStatus === 'error' ? 'rgba(239, 68, 68, 0.05)' : 'rgba(245, 158, 11, 0.05)',
                      border: `1px solid ${agentStatus === 'complete' ? 'rgba(34, 197, 94, 0.2)' : agentStatus === 'error' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)'}`,
                      borderRadius: '10px',
                      marginBottom: '16px',
                      overflow: 'hidden',
                      transition: 'all 0.3s ease'
                    }}>
                      {/* Agent Header - Always visible */}
                      <div 
                        onClick={() => setAgentExpanded(!agentExpanded)}
                        style={{
                          padding: '10px 16px',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          cursor: 'pointer'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <span style={{ fontSize: '16px' }}>ğŸ¤–</span>
                          <span style={{ 
                            fontSize: '13px', 
                            fontWeight: '700', 
                            color: agentStatus === 'complete' ? '#22c55e' : agentStatus === 'error' ? '#ef4444' : '#f59e0b' 
                          }}>
                            {agentStatus === 'running' ? 'Researching property...' : 
                             agentStatus === 'complete' ? 'Property Research Complete' : 
                             'Research unavailable'}
                          </span>
                          {agentStatus === 'complete' && agentResults && (
                            <span style={{ fontSize: '11px', color: '#64748b', fontFamily: 'monospace' }}>
                              {agentResults.tools_succeeded}/{agentResults.tools_succeeded + agentResults.tools_failed} sources Â· {(agentResults.research_time_ms / 1000).toFixed(1)}s
                            </span>
                          )}
                          {agentStatus === 'running' && (
                            <span style={{ fontSize: '11px', color: '#f59e0b', animation: 'pulse 1.5s ease-in-out infinite' }}>
                              checking public records...
                            </span>
                          )}
                        </div>
                        <span style={{ 
                          fontSize: '10px', color: '#64748b', 
                          transform: agentExpanded ? 'rotate(180deg)' : 'rotate(0deg)', 
                          transition: 'transform 0.2s' 
                        }}>â–¼</span>
                      </div>
                      
                      {/* Agent Details - Expandable */}
                      {agentExpanded && agentResults?.profile && (
                        <div style={{ padding: '0 16px 14px' }}>
                          {/* Tool Results Grid */}
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', marginBottom: '10px' }}>
                            {agentResults.tool_results?.filter(t => t.status === 'success').map((tool, i) => (
                              <div key={i} style={{ 
                                fontSize: '11px', 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '6px', 
                                color: '#94a3b8',
                                padding: '4px 0'
                              }}>
                                <span style={{ color: '#22c55e' }}>âœ…</span>
                                <span style={{ color: '#64748b', minWidth: '65px', fontWeight: '600' }}>
                                  {tool.tool_name === 'geocoding' ? 'Location' :
                                   tool.tool_name === 'redfin' ? 'Redfin' :
                                   tool.tool_name === 'flood_zone' ? 'Flood' :
                                   tool.tool_name === 'ca_hazards' ? 'Hazards' :
                                   tool.tool_name === 'walk_score' ? 'Walk Score' :
                                   tool.tool_name === 'permits' ? 'Permits' :
                                   tool.tool_name === 'school_ratings' ? 'Schools' :
                                   tool.tool_name}
                                </span>
                                <span style={{ color: '#cbd5e1', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {tool.tool_name === 'geocoding' && agentResults.profile.county ? `${agentResults.profile.city}, ${agentResults.profile.county} County` : ''}
                                  {tool.tool_name === 'redfin' && agentResults.profile.estimated_value ? `$${agentResults.profile.estimated_value.toLocaleString()} est.` : ''}
                                  {tool.tool_name === 'redfin' && agentResults.profile.year_built ? ` Â· Built ${agentResults.profile.year_built}` : ''}
                                  {tool.tool_name === 'flood_zone' ? `Zone ${agentResults.profile.flood_zone || '?'} (${agentResults.profile.flood_risk_level || 'unknown'})` : ''}
                                  {tool.tool_name === 'ca_hazards' ? `EQ: ${agentResults.profile.earthquake_zone ? 'Yes âš ï¸' : 'No'} Â· Fire: ${agentResults.profile.fire_hazard_zone || 'N/A'}` : ''}
                                  {tool.tool_name === 'walk_score' && agentResults.profile.walk_score ? `Walk ${agentResults.profile.walk_score} Â· Transit ${agentResults.profile.transit_score || 'â€“'}` : ''}
                                  {tool.tool_name === 'permits' ? `${agentResults.profile.permits?.length || 0} permits found` : ''}
                                  {tool.tool_name === 'school_ratings' && agentResults.profile.school_rating_elementary ? `Elem ${agentResults.profile.school_rating_elementary}/10` : ''}
                                </span>
                              </div>
                            ))}
                            {agentResults.tool_results?.filter(t => t.status === 'failed').map((tool, i) => (
                              <div key={`f-${i}`} style={{ fontSize: '11px', display: 'flex', alignItems: 'center', gap: '6px', color: '#64748b', padding: '4px 0' }}>
                                <span>âš ï¸</span>
                                <span style={{ minWidth: '65px', fontWeight: '600' }}>{tool.tool_name}</span>
                                <span style={{ color: '#475569', fontSize: '10px' }}>unavailable</span>
                              </div>
                            ))}
                          </div>
                          
                          {/* Agent Findings Summary */}
                          {agentResults.profile.agent_findings?.length > 0 && (
                            <div style={{ 
                              background: 'rgba(245, 158, 11, 0.08)', 
                              border: '1px solid rgba(245, 158, 11, 0.15)', 
                              borderRadius: '8px', 
                              padding: '10px 12px' 
                            }}>
                              <div style={{ fontSize: '11px', fontWeight: '700', color: '#f59e0b', marginBottom: '6px' }}>
                                ğŸ” {agentResults.profile.agent_findings.length} findings to verify against your documents
                              </div>
                              {agentResults.profile.agent_findings.slice(0, 3).map((finding, i) => (
                                <div key={i} style={{ 
                                  fontSize: '11px', 
                                  color: '#94a3b8', 
                                  padding: '3px 0',
                                  display: 'flex',
                                  alignItems: 'flex-start',
                                  gap: '6px'
                                }}>
                                  <span style={{ 
                                    color: finding.severity === 'high' ? '#ef4444' : finding.severity === 'medium' ? '#f59e0b' : '#60a5fa',
                                    fontSize: '8px',
                                    marginTop: '3px'
                                  }}>â—</span>
                                  <span>{finding.title}</span>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {/* Redfin estimate hint for price field */}
                          {agentResults.profile.estimated_value && !price && (
                            <div style={{ 
                              marginTop: '8px', 
                              fontSize: '12px', 
                              color: '#f59e0b', 
                              fontWeight: '500',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px'
                            }}>
                              ğŸ’¡ Estimated value: ${agentResults.profile.estimated_value.toLocaleString()} â€” is this close to the asking price?
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                  
                  <input
                    type="text"
                    inputMode="numeric"
                    placeholder="Asking Price (e.g., $1,480,000)"
                    value={price}
                    onChange={(e) => {
                      // v5.54.12: Only allow numbers, auto-format with commas
                      const rawValue = e.target.value.replace(/[^0-9]/g, '');
                      // Format with commas for display
                      const formatted = rawValue ? parseInt(rawValue, 10).toLocaleString('en-US') : '';
                      setPrice(formatted);
                    }}
                    style={styles.input}
                    maxLength={15}
                  />
                  
                  {/* Price hint */}
                  {price && (
                    <div style={{ fontSize: '12px', color: '#64748b', marginTop: '-12px', marginBottom: '16px' }}>
                      ğŸ’° ${price} ({(() => {
                        const num = parseInt(price.replace(/[^0-9]/g, ''), 10);
                        if (num >= 1000000) return `${(num / 1000000).toFixed(2)}M`;
                        if (num >= 1000) return `${(num / 1000).toFixed(0)}K`;
                        return num;
                      })()})
                    </div>
                  )}
                </div>
                
                {/* Documents Section */}
                <div style={styles.section}>
                  <h3 style={styles.sectionTitle}>Upload Documents</h3>
                  
                  {/* Document Retention Notice */}
                  <div style={{
                    background: 'rgba(59, 130, 246, 0.1)',
                    border: '1px solid rgba(59, 130, 246, 0.3)',
                    borderRadius: '8px',
                    padding: '16px',
                    marginBottom: '24px'
                  }}>
                    <div style={{
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '12px'
                    }}>
                      <div style={{ fontSize: '20px', flexShrink: 0 }}>ğŸ”’</div>
                      <div>
                        <div style={{
                          fontWeight: 600,
                          color: '#60a5fa',
                          marginBottom: '8px',
                          fontSize: '15px'
                        }}>
                          Privacy Notice: Your Documents Never Leave Your Device
                        </div>
                        <div style={{
                          color: '#94a3b8',
                          fontSize: '13px',
                          lineHeight: '1.6'
                        }}>
                          PDFs are parsed directly in your browser. Only the extracted text is sent to our serversâ€”we never receive, store, or have access to your PDF files.
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div style={styles.uploadSection}>
                    <label style={styles.label}>
                      Seller Disclosure Statement <span style={{color: '#ef4444'}}>*Required</span>
                    </label>
                    <input
                      type="file"
                      accept=".pdf"
                      onChange={(e) => {
                        if (e.target.files && e.target.files[0]) {
                          handleFileUpload(e.target.files[0], 'disclosure');
                        }
                      }}
                      disabled={uploadingDisclosure}
                      style={styles.fileInput}
                    />
                    {disclosureText && <div style={styles.success}>âœ“ Disclosure Uploaded</div>}
                    
                    {/* Disclosure Upload Progress - show during upload OR at completion */}
                    {(uploadingDisclosure || (disclosureProgress.current === 100 && disclosureProgress.total === 100)) && (
                      <div style={{
                        marginTop: '12px',
                        padding: '16px',
                        backgroundColor: uploadingDisclosure ? '#f8fafc' : '#ecfdf5',
                        borderRadius: '8px',
                        border: uploadingDisclosure ? '2px solid #e2e8f0' : '2px solid #10b981'
                      }}>
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          color: uploadingDisclosure ? '#334155' : '#059669',
                          marginBottom: '8px'
                        }}>
                          ğŸ“„ {disclosureProgress.message || 'Processing disclosure...'}
                        </div>
                        <div style={{
                          width: '100%',
                          height: '24px',
                          backgroundColor: '#e2e8f0',
                          borderRadius: '6px',
                          overflow: 'hidden',
                          position: 'relative'
                        }}>
                          <div style={{
                            width: `${(disclosureProgress.current / disclosureProgress.total) * 100}%`,
                            height: '100%',
                            backgroundColor: uploadingDisclosure ? '#3b82f6' : '#10b981',
                            transition: 'width 0.3s ease',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '12px',
                            fontWeight: '600'
                          }}>
                            {disclosureProgress.total > 0 ? `${Math.round((disclosureProgress.current / disclosureProgress.total) * 100)}%` : ''}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={styles.uploadSection}>
                    <label style={styles.label}>
                      Inspection Report <span style={{color: '#ef4444'}}>*Required</span>
                    </label>
                    <input
                      type="file"
                      accept=".pdf"
                      onChange={(e) => {
                        if (e.target.files && e.target.files[0]) {
                          handleFileUpload(e.target.files[0], 'inspection');
                        }
                      }}
                      disabled={uploadingInspection}
                      style={styles.fileInput}
                    />
                    {inspectionText && <div style={styles.success}>âœ“ Inspection Uploaded</div>}
                    
                    {/* Inspection Upload Progress - show during upload OR at completion */}
                    {(uploadingInspection || (inspectionProgress.current === 100 && inspectionProgress.total === 100)) && (
                      <div style={{
                        marginTop: '12px',
                        padding: '16px',
                        backgroundColor: uploadingInspection ? '#f8fafc' : '#ecfdf5',
                        borderRadius: '8px',
                        border: uploadingInspection ? '2px solid #e2e8f0' : '2px solid #10b981'
                      }}>
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          color: uploadingInspection ? '#334155' : '#059669',
                          marginBottom: '8px'
                        }}>
                          ğŸ” {inspectionProgress.message || 'Processing inspection...'}
                        </div>
                        <div style={{
                          width: '100%',
                          height: '24px',
                          backgroundColor: '#e2e8f0',
                          borderRadius: '6px',
                          overflow: 'hidden',
                          position: 'relative'
                        }}>
                          <div style={{
                            width: `${(inspectionProgress.current / inspectionProgress.total) * 100}%`,
                            height: '100%',
                            backgroundColor: uploadingInspection ? '#10b981' : '#10b981',
                            transition: 'width 0.3s ease',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '12px',
                            fontWeight: '600'
                          }}>
                            {inspectionProgress.total > 0 ? `${Math.round((inspectionProgress.current / inspectionProgress.total) * 100)}%` : ''}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                
                {/* DEBUG PANEL - Hidden in production (v4.9.13)
                <div style={{
                  padding: '12px',
                  backgroundColor: '#fef3c7',
                  borderRadius: '8px',
                  border: '2px solid #f59e0b',
                  marginBottom: '16px',
                  fontFamily: 'monospace',
                  fontSize: '13px'
                }}>
                  <div style={{ fontWeight: 'bold', marginBottom: '8px', color: '#92400e' }}>ğŸ” Button State Debug:</div>
                  <div>âœ“ Address: {address ? `"${address}"` : 'âŒ MISSING'}</div>
                  <div>âœ“ Price: {price ? `"${price}"` : 'âŒ MISSING'}</div>
                  <div>âœ“ Disclosure Text: {disclosureText ? `${disclosureText.length} chars` : 'âŒ MISSING'}</div>
                  <div>âœ“ Inspection Text: {inspectionText ? `${inspectionText.length} chars` : 'âŒ MISSING'}</div>
                  <div>âœ“ Uploading Disclosure: {uploadingDisclosure ? 'âŒ YES (blocking button)' : 'âœ… No'}</div>
                  <div>âœ“ Uploading Inspection: {uploadingInspection ? 'âŒ YES (blocking button)' : 'âœ… No'}</div>
                  <div style={{ 
                    marginTop: '8px', 
                    padding: '8px', 
                    backgroundColor: (!address || !price || !disclosureText || !inspectionText || uploadingDisclosure || uploadingInspection) ? '#fee2e2' : '#d1fae5',
                    borderRadius: '4px',
                    fontWeight: 'bold',
                    color: (!address || !price || !disclosureText || !inspectionText || uploadingDisclosure || uploadingInspection) ? '#991b1b' : '#065f46'
                  }}>
                    Button Status: {(!address || !price || !disclosureText || !inspectionText || uploadingDisclosure || uploadingInspection) ? 'ğŸ”’ DISABLED' : 'âœ… ENABLED'}
                  </div>
                </div>
                */}
                
                <button
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ğŸ–±ï¸ Continue button clicked!');
                    console.log('Button state check:', {
                      hasAddress: !!address,
                      hasPrice: !!price,
                      hasDisclosureText: !!disclosureText,
                      hasInspectionText: !!inspectionText,
                      uploadingDisclosure,
                      uploadingInspection,
                      shouldBeDisabled: !address || !price || !disclosureText || !inspectionText || uploadingDisclosure || uploadingInspection
                    });
                    
                    // Visual feedback
                    e.target.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                      if (e.target) e.target.style.transform = 'scale(1)';
                    }, 100);
                    
                    // Force immediate navigation
                    console.log('âš¡ Calling handleContinue...');
                    handleContinue();
                    console.log('âœ… handleContinue executed');
                  }}
                  disabled={
                    !address || 
                    address.trim().length < 10 || 
                    !price || 
                    parseInt(price.replace(/[^0-9]/g, ''), 10) < 10000 ||
                    !disclosureText || 
                    !inspectionText || 
                    uploadingDisclosure || 
                    uploadingInspection
                  }
                  title={
                    !address || address.trim().length < 10 ? 'Please enter a complete property address' :
                    !price ? 'Please enter property price' :
                    parseInt(price.replace(/[^0-9]/g, ''), 10) < 10000 ? 'Please enter a valid property price (min $10,000)' :
                    !disclosureText ? 'Please upload seller disclosure' :
                    !inspectionText ? 'Please upload inspection report' :
                    uploadingDisclosure ? 'Waiting for disclosure to finish processing...' :
                    uploadingInspection ? 'Waiting for inspection to finish processing...' :
                    'Click to continue to analysis'
                  }
                  style={{
                    ...styles.button,
                    opacity: (!address || address.trim().length < 10 || !price || parseInt(price.replace(/[^0-9]/g, ''), 10) < 10000 || !disclosureText || !inspectionText || uploadingDisclosure || uploadingInspection) ? 0.5 : 1,
                    cursor: (!address || address.trim().length < 10 || !price || parseInt(price.replace(/[^0-9]/g, ''), 10) < 10000 || !disclosureText || !inspectionText || uploadingDisclosure || uploadingInspection) ? 'not-allowed' : 'pointer'
                  }}
                >
                  Continue to Analysis â†’
                </button>
                
                <div style={styles.helpText}>
                  <p>ğŸ’¡ <strong>Tip:</strong> You can upload both documents simultaneously - no need to wait! Both files will process in parallel.</p>
                  <p style={{marginTop: '8px'}}>ğŸ“„ Both the seller disclosure and inspection report are required for accurate analysis.</p>
                  <p style={{marginTop: '12px', padding: '12px', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '8px', border: '1px solid rgba(59, 130, 246, 0.2)'}}>
                    <strong style={{color: '#60a5fa'}}>Don't have both documents yet?</strong><br/>
                    <span style={{fontSize: '14px', color: '#94a3b8'}}>
                      â€¢ Ask your agent for seller disclosures (usually provided early in the process)<br/>
                      â€¢ Inspection reports are typically done after offer acceptance â€” you can return later!
                    </span>
                  </p>
                </div>
              </div>
            );
          };
          
          // First-Time Profile Setup Step
          const FirstTimeProfileStep = () => {
            const [profile, setProfile] = useState({
              max_budget: '',
              repair_tolerance: 'moderate',
              biggest_regret: ''
            });
            const [hasReadConsent, setHasReadConsent] = useState(false);
            const [consentText, setConsentText] = useState('');
            const [consentExpanded, setConsentExpanded] = useState(false);
            const [showConsentFirst, setShowConsentFirst] = useState(true); // NEW: Show disclaimer first
            
            // Load consent text on mount
            React.useEffect(() => {
              const loadConsent = async () => {
                try {
                  const response = await fetch('/api/consent/get-text?consent_type=analysis_disclaimer', {
                    credentials: 'include'
                  });
                  if (response.ok) {
                    const data = await response.json();
                    setConsentText(data.text || 'Consent text not available');
                  }
                } catch (err) {
                  console.error('Failed to load consent text:', err);
                }
              };
              loadConsent();
            }, []);
            
            const handleAcceptConsent = async () => {
              // Record consent first
              try {
                const consentResponse = await fetch('/api/consent/record', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ consent_type: 'analysis_disclaimer' })
                });
                
                if (!consentResponse.ok) {
                  alert('Failed to record consent. Please try again.');
                  return;
                }
                
                // Move to profile setup
                setShowConsentFirst(false);
                
              } catch (err) {
                console.error('Consent error:', err);
                alert('Failed to record consent. Please try again.');
              }
            };
            
            const handleSaveProfile = async () => {
              // Validate budget
              const budgetNum = parseInt(profile.max_budget.replace(/[^0-9]/g, ''));
              if (isNaN(budgetNum) || budgetNum <= 0) {
                alert('Please enter a valid budget');
                return;
              }
              
              // Save to localStorage
              const profileToSave = {
                max_budget: budgetNum,
                repair_tolerance: profile.repair_tolerance,
                biggest_regret: profile.biggest_regret
              };
              
              localStorage.setItem('buyer_profile', JSON.stringify(profileToSave));
              setBuyerProfile(profileToSave);
              setHasProfile(true);
              
              // Check credits before starting first analysis
              checkCreditsAndStartAnalysis();
              
              alert('âœ“ Settings saved! Ready to analyze properties.');
            };
            
            // STEP 1: Show disclaimer first
            if (showConsentFirst) {
              return (
                <div style={styles.container}>
                  <a href="/settings" style={{ textDecoration: 'none', color: 'inherit' }}>
                    <h1 style={styles.title}>OfferWise AI</h1>
                  </a>
                  <h2 style={styles.subtitle}>âš–ï¸ Legal Disclaimer - Required First</h2>
                  
                  <div style={{
                    background: 'rgba(239, 68, 68, 0.1)',
                    border: '2px solid #ef4444',
                    borderRadius: '12px',
                    padding: '20px',
                    marginBottom: '24px'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
                      <div style={{ fontSize: '32px' }}>âš–ï¸</div>
                      <div>
                        <h3 style={{ color: '#ef4444', fontSize: '20px', margin: 0, fontWeight: '700' }}>
                          Read & Accept Before Proceeding
                        </h3>
                        <p style={{ color: '#94a3b8', fontSize: '13px', margin: '4px 0 0 0' }}>
                          You must accept this disclaimer to use OfferWise
                        </p>
                      </div>
                    </div>
                    
                    {/* Full disclaimer text - always visible */}
                    <div style={{
                      background: '#0f172a',
                      borderRadius: '8px',
                      padding: '16px',
                      marginBottom: '16px',
                      border: '1px solid #334155',
                      maxHeight: '400px',
                      overflow: 'auto'
                    }}>
                      <pre style={{
                        color: '#e2e8f0',
                        fontSize: '12px',
                        lineHeight: '1.7',
                        whiteSpace: 'pre-wrap',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        margin: 0
                      }}>
                        {consentText}
                      </pre>
                    </div>
                    
                    {/* Key points */}
                    <div style={{
                      fontSize: '13px',
                      color: '#cbd5e1',
                      lineHeight: '1.6',
                      marginBottom: '16px'
                    }}>
                      <p style={{ fontWeight: '600', color: '#fca5a5', marginBottom: '8px' }}>
                        By clicking "I Accept", you acknowledge that:
                      </p>
                      <ul style={{ margin: '0', paddingLeft: '20px' }}>
                        <li>This is NOT professional advice - consult licensed professionals</li>
                        <li>You must verify all information independently</li>
                        <li>You assume ALL RISK for your decisions</li>
                        <li>Our liability is limited to the amount you paid</li>
                      </ul>
                    </div>
                    
                    {/* Consent checkbox */}
                    <label style={{
                      display: 'flex',
                      alignItems: 'start',
                      gap: '12px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      color: '#cbd5e1',
                      lineHeight: '1.5',
                      marginBottom: '20px'
                    }}>
                      <input
                        type="checkbox"
                        checked={hasReadConsent}
                        onChange={(e) => setHasReadConsent(e.target.checked)}
                        style={{
                          width: '20px',
                          height: '20px',
                          marginTop: '2px',
                          cursor: 'pointer',
                          accentColor: '#ef4444'
                        }}
                      />
                      <span>
                        <strong style={{ color: '#ef4444' }}>I have read and accept</strong> the legal disclaimer above. 
                        I understand this is not professional advice and I must verify all information independently.
                      </span>
                    </label>
                    
                    <button
                      onClick={handleAcceptConsent}
                      disabled={!hasReadConsent}
                      style={{
                        width: '100%',
                        padding: '16px',
                        background: hasReadConsent ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : '#64748b',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '16px',
                        fontWeight: '700',
                        cursor: hasReadConsent ? 'pointer' : 'not-allowed',
                        opacity: hasReadConsent ? 1 : 0.5,
                        transition: 'all 0.2s'
                      }}
                    >
                      {hasReadConsent ? 'âœ“ I Accept - Continue to Setup â†’' : 'âš–ï¸ Check the box above to continue'}
                    </button>
                  </div>
                  
                  <div style={{
                    textAlign: 'center',
                    fontSize: '13px',
                    color: '#94a3b8'
                  }}>
                    Your consent is recorded and you can review it anytime in Settings
                  </div>
                </div>
              );
            }
            
            // STEP 2: Show profile setup (after consent)
            return (
              <div style={styles.container}>
                <a href="/settings" style={{ textDecoration: 'none', color: 'inherit' }}>
                  <h1 style={styles.title}>OfferWise AI</h1>
                </a>
                <h2 style={styles.subtitle}>ğŸ‘‹ Set Up Your Buyer Profile</h2>
                
                {/* Before You Purchase - 3 Column Important Notes */}
                <div style={{
                  background: 'rgba(15, 23, 42, 0.6)',
                  border: '2px solid #334155',
                  borderRadius: '16px',
                  padding: '24px',
                  marginBottom: '24px'
                }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    marginBottom: '24px',
                    justifyContent: 'center'
                  }}>
                    <span style={{ fontSize: '28px' }}>ğŸ“‹</span>
                    <h3 style={{ 
                      color: '#f1f5f9', 
                      fontSize: '24px', 
                      margin: 0,
                      fontWeight: '700'
                    }}>
                      Before You Purchase - Important Notes
                    </h3>
                  </div>
                  
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))',
                    gap: '20px'
                  }}>
                    {/* Column 1: Document Quality + Complete Documents (MERGED) */}
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                        <span style={{ fontSize: '32px' }}>ğŸ“„</span>
                        <div>
                          <div style={{ color: '#f1f5f9', fontSize: '18px', fontWeight: '700' }}>
                            Complete Quality Documents
                          </div>
                        </div>
                      </div>
                      <div style={{ color: '#94a3b8', fontSize: '14px', lineHeight: '1.6' }}>
                        <p style={{ margin: '0 0 12px 0' }}>
                          <strong style={{ color: '#cbd5e1' }}>Best results</strong> with typed, professional inspection 
                          reports and disclosure forms. Scanned or handwritten documents may have limitations.
                        </p>
                        <p style={{ margin: '0', color: '#10b981', fontWeight: '600' }}>
                          âœ“ Upload both documents for best results. Incomplete documents may limit analysis accuracy.
                        </p>
                      </div>
                    </div>
                    
                    {/* Column 2: AI-Powered Insights */}
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                        <span style={{ fontSize: '32px' }}>ğŸ¤–</span>
                        <div>
                          <div style={{ color: '#f1f5f9', fontSize: '18px', fontWeight: '700' }}>
                            AI-Powered Insights
                          </div>
                        </div>
                      </div>
                      <div style={{ color: '#94a3b8', fontSize: '14px', lineHeight: '1.6' }}>
                        Our AI provides data-driven insights and recommendations, <strong style={{ color: '#fbbf24' }}>not professional advice</strong>. 
                        Always verify findings with licensed professionals.
                      </div>
                    </div>
                    
                    {/* Column 3: Decision Support Tool */}
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                        <span style={{ fontSize: '32px' }}>ğŸ¯</span>
                        <div>
                          <div style={{ color: '#f1f5f9', fontSize: '18px', fontWeight: '700' }}>
                            Decision Support Tool
                          </div>
                        </div>
                      </div>
                      <div style={{ color: '#94a3b8', fontSize: '14px', lineHeight: '1.6' }}>
                        OfferWise helps you make informed decisions by analyzing documents you provide. 
                        Results depend on document quality and completeness.
                      </div>
                    </div>
                  </div>
                </div>
                
                <div style={{
                  background: 'rgba(59, 130, 246, 0.1)',
                  border: '1px solid rgba(59, 130, 246, 0.3)',
                  borderRadius: '12px',
                  padding: '16px',
                  marginBottom: '12px'
                }}>
                  <p style={{ color: '#cbd5e1', fontSize: '15px', lineHeight: '1.6', margin: 0 }}>
                    Tell us about your buying preferences. This helps OfferScoreâ„¢ provide personalized recommendations.
                  </p>
                </div>
                
                <div style={styles.section}>
                  <label style={styles.label}>
                    <strong>Maximum Budget</strong>
                    <div style={{ fontSize: '13px', color: '#94a3b8', marginTop: '4px' }}>
                      What's the most you're willing to spend?
                    </div>
                  </label>
                  <input
                    type="text"
                    placeholder="e.g., 1500000"
                    value={profile.max_budget}
                    onChange={(e) => setProfile({...profile, max_budget: e.target.value})}
                    style={styles.input}
                  />
                </div>
                
                <div style={styles.section}>
                  <label style={styles.label}>
                    <strong>Repair Tolerance</strong>
                    <div style={{ fontSize: '13px', color: '#94a3b8', marginTop: '4px' }}>
                      How much renovation are you willing to handle?
                    </div>
                  </label>
                  <select
                    value={profile.repair_tolerance}
                    onChange={(e) => setProfile({...profile, repair_tolerance: e.target.value})}
                    style={styles.input}
                  >
                    <option value="low">Low - I want move-in ready</option>
                    <option value="moderate">Moderate - Some repairs OK</option>
                    <option value="high">High - I can handle major renovations</option>
                  </select>
                </div>
                
                <div style={styles.section}>
                  <label style={styles.label}>
                    <strong>Biggest Fear / Regret to Avoid</strong>
                    <div style={{ fontSize: '13px', color: '#94a3b8', marginTop: '4px' }}>
                      What worries you most about buying a home? Be specific.
                    </div>
                  </label>
                  <textarea
                    value={profile.biggest_regret}
                    onChange={(e) => setProfile({...profile, biggest_regret: e.target.value})}
                    placeholder="e.g., 'Overpaying for a property with hidden foundation issues that cost more to fix than the house is worth'"
                    style={{
                      ...styles.input,
                      minHeight: '80px',
                      resize: 'vertical',
                      fontFamily: 'inherit',
                      padding: '10px'
                    }}
                  />
                </div>
                
                <button
                  onClick={handleSaveProfile}
                  disabled={!profile.max_budget}
                  style={{
                    ...styles.button,
                    opacity: !profile.max_budget ? 0.5 : 1
                  }}
                >
                  Save Profile & Start Analyzing â†’
                </button>
                
                <div style={{
                  textAlign: 'center',
                  marginTop: '24px',
                  fontSize: '13px',
                  color: '#94a3b8'
                }}>
                  âœ“ Legal disclaimer accepted â€¢ Update preferences anytime in Settings
                </div>
              </div>
            );
          };
          
          // Buyer Profile Step
          const ProfileStep = () => {
            const [profile, setProfile] = useState({
              max_budget: '',
              repair_tolerance: 'moderate',
              biggest_regret: ''
            });
            
            return (
              <div style={styles.container}>
                <button onClick={() => setCurrentStep('documents')} style={styles.backButton}>
                  â† Back
                </button>
                
                <h2 style={styles.subtitle}>Buyer Profile</h2>
                
                <label style={styles.label}>Maximum Budget</label>
                <input
                  type="text"
                  placeholder="1500000"
                  value={profile.max_budget}
                  onChange={(e) => setProfile({...profile, max_budget: e.target.value})}
                  style={styles.input}
                />
                
                <label style={styles.label}>Repair Tolerance</label>
                <select
                  value={profile.repair_tolerance}
                  onChange={(e) => setProfile({...profile, repair_tolerance: e.target.value})}
                  style={styles.input}
                >
                  <option value="low">Low</option>
                  <option value="moderate">Moderate</option>
                  <option value="high">High</option>
                </select>
                
                <label style={styles.label}>
                  <strong>Biggest Fear / Regret to Avoid</strong>
                  <div style={{ fontSize: '13px', color: '#94a3b8', marginTop: '4px' }}>
                    What worries you most about buying a home? Be specific.
                  </div>
                </label>
                <textarea
                  value={profile.biggest_regret}
                  onChange={(e) => setProfile({...profile, biggest_regret: e.target.value})}
                  placeholder="e.g., 'Overpaying for a property with hidden foundation issues that cost more to fix than the house is worth'"
                  style={{
                    ...styles.input,
                    minHeight: '80px',
                    resize: 'vertical',
                    fontFamily: 'inherit',
                    padding: '10px'
                  }}
                />
                
                <button
                  onClick={() => {
                    setBuyerProfile(profile);
                    setCurrentStep('analyze');
                  }}
                  disabled={!profile.max_budget}
                  style={styles.button}
                >
                  Continue â†’
                </button>
              </div>
            );
          };
          
          // ğŸ›¡ï¸ CONSENT MODAL FUNCTIONS
          const showConsentModalAndWait = () => {
            return new Promise(async (resolve, reject) => {
              try {
                // Fetch disclaimer text
                const response = await fetch('/api/consent/get-text?consent_type=analysis_disclaimer', {
                  credentials: 'include'
                });
                
                if (!response.ok) {
                  reject(new Error('Failed to load disclaimer'));
                  return;
                }
                
                const data = await response.json();
                setConsentText(data.text);
                setConsentVersion(data.version);
                setConsentType('analysis_disclaimer');
                
                // Show modal
                setShowConsentModal(true);
                
                // Wait for user to consent or cancel
                const checkConsent = setInterval(async () => {
                  if (!consentPending) {
                    clearInterval(checkConsent);
                    
                    // Check if they consented
                    const checkResponse = await fetch('/api/consent/check', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify({ consent_type: 'analysis_disclaimer' })
                    });
                    
                    if (checkResponse.ok) {
                      const checkData = await checkResponse.json();
                      if (checkData.has_consent) {
                        resolve();
                      } else {
                        reject(new Error('User did not consent'));
                      }
                    } else {
                      reject(new Error('Failed to verify consent'));
                    }
                  }
                }, 500);
                
              } catch (err) {
                console.error('Error showing consent modal:', err);
                reject(err);
              }
            });
          };
          
          const recordConsent = async () => {
            try {
              setConsentPending(true);
              
              const response = await fetch('/api/consent/record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ consent_type: 'analysis_disclaimer' })
              });
              
              if (response.ok) {
                console.log('âœ… Consent recorded successfully');
                setHasAnalysisConsent(true);
                setShowConsentModal(false);
                setConsentPending(false);
                return true;
              } else {
                const error = await response.json();
                console.error('âŒ Failed to record consent:', error);
                alert('Failed to record consent. Please try again.');
                setConsentPending(false);
                return false;
              }
            } catch (err) {
              console.error('âŒ Error recording consent:', err);
              alert('Error recording consent. Please try again.');
              setConsentPending(false);
              return false;
            }
          };
          
          const cancelConsent = () => {
            setShowConsentModal(false);
            setConsentPending(false);
            alert('You must accept the disclaimer to proceed with analysis.');
          };
          
          // Analysis Step
          const AnalyzeStep = () => {
            const [autoAnalyzeTriggered, setAutoAnalyzeTriggered] = useState(false);
            
            const handleAnalyze = async () => {
              console.log('ğŸ¯ ANALYZE BUTTON CLICKED!');
              
              // ğŸ›¡ï¸ SAFETY CHECK: Verify credits before starting analysis
              try {
                const creditsResponse = await fetch('/api/user/credits');
                if (creditsResponse.ok) {
                  const creditsData = await creditsResponse.json();
                  if (creditsData.credits === 0) {
                    console.log('ğŸš« No credits available - redirecting to pricing');
                    window.location.href = '/pricing?message=' + encodeURIComponent('You need to purchase credits before starting a new analysis.');
                    return;
                  }
                  console.log(`âœ… Credits verified: ${creditsData.credits} remaining`);
                } else {
                  console.warn('âš ï¸ Could not verify credits, proceeding with analysis');
                }
              } catch (err) {
                console.error('âŒ Error checking credits:', err);
                // Continue with analysis on error (fail open)
              }
              
              // ğŸ›¡ï¸ LEGAL PROTECTION: Check if user has consented - BLOCKS if missing
              try {
                const consentCheck = await fetch('/api/consent/check', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ consent_type: 'analysis_disclaimer' })
                });
                
                if (consentCheck.ok) {
                  const consentData = await consentCheck.json();
                  console.log('âš–ï¸ Consent check:', consentData);
                  
                  if (!consentData.has_consent) {
                    console.log('ğŸš« BLOCKING ANALYSIS: No consent recorded');
                    alert('Please accept the Analysis Disclaimer in Settings before starting analysis.\n\nThis is required for legal protection.');
                    setLoading(false);
                    return;  // BLOCK ANALYSIS!
                  } else {
                    console.log('âœ… User has valid consent - proceeding');
                  }
                } else {
                  console.error('âš ï¸ Could not verify consent - blocking for safety');
                  alert('Unable to verify consent status. Please try again or contact support.');
                  setLoading(false);
                  return;  // BLOCK on error for safety
                }
              } catch (err) {
                console.error('âŒ Error checking consent:', err);
                alert('Unable to verify consent. Please check your connection and try again.');
                setLoading(false);
                return;  // BLOCK on error for safety
              }
              
              console.log('ğŸ“Š Current state check:');
              console.log('  - propertyData:', propertyData);
              console.log('  - buyerProfile:', buyerProfile);
              console.log('  - disclosureText length:', propertyData?.disclosureText?.length || 0);
              console.log('  - inspectionText length:', propertyData?.inspectionText?.length || 0);
              
              setLoading(true);
              setError('');
              
              // Asymptotic progress bar: approaches 95% but NEVER reaches 100% until response arrives
              // This prevents the "stuck at 100%" problem regardless of how long analysis takes
              const progressMessages = [
                { at: 5, text: 'Starting analysis...', tip: 'ğŸ“„ Reading your documents' },
                { at: 15, text: 'Parsing seller disclosure...', tip: 'ğŸ” Extracting what the seller revealed' },
                { at: 25, text: 'Parsing inspection report...', tip: 'ğŸ”§ Identifying issues found by inspector' },
                { at: 40, text: 'Cross-referencing documents...', tip: 'âš¡ Finding gaps between what seller said vs reality' },
                { at: 55, text: 'Calculating repair costs...', tip: 'ğŸ’° Using 2024 contractor pricing data' },
                { at: 65, text: 'Scoring property risks...', tip: 'ğŸ§¬ Building your Property Risk DNAâ„¢' },
                { at: 75, text: 'Generating offer strategy...', tip: 'ğŸ¯ Calculating your optimal offer price' },
                { at: 85, text: 'Preparing negotiation points...', tip: 'ğŸ’ª Arming you with leverage' },
                { at: 92, text: 'Finalizing analysis...', tip: 'âœ¨ Almost ready!' },
              ];
              
              let currentPct = 0;
              let msgIdx = 0;
              const startTime = Date.now();
              
              // Expected duration: ~30s. Progress moves fast at start, slows as it approaches 95%
              const progressInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                // Asymptotic curve: fast start, slow finish, caps at 95%
                // Formula: 95 * (1 - e^(-elapsed/15))
                currentPct = Math.min(95, 95 * (1 - Math.exp(-elapsed / 15)));
                
                // Find the right message for current progress
                while (msgIdx < progressMessages.length - 1 && currentPct >= progressMessages[msgIdx + 1].at) {
                  msgIdx++;
                }
                
                setAnalysisProgress({ 
                  current: Math.round(currentPct), 
                  total: 100, 
                  message: progressMessages[msgIdx].text,
                  tip: progressMessages[msgIdx].tip
                });
              }, 500); // Update every 500ms for smooth animation
              
              try {
                console.log('âœ… Starting analysis...');
                console.log('ğŸ“¦ Property data:', propertyData);
                console.log('ğŸ‘¤ Buyer profile:', buyerProfile);
                
                const requestBody = {
                  seller_disclosure_text: propertyData.disclosureText,
                  inspection_report_text: propertyData.inspectionText || '',
                  property_price: propertyData.price,
                  property_address: propertyData.address,
                  buyer_profile: {
                    max_budget: parseInt(String(buyerProfile.max_budget).replace(/[^0-9]/g, '')),
                    repair_tolerance: buyerProfile.repair_tolerance,
                    biggest_regret: buyerProfile.biggest_regret
                  }
                };
                
                console.log('ğŸ“¤ Sending analysis request to /api/analyze');
                console.log('ğŸ“‹ Request body:', {
                  ...requestBody,
                  seller_disclosure_text: `${requestBody.seller_disclosure_text?.length || 0} chars`,
                  inspection_report_text: `${requestBody.inspection_report_text?.length || 0} chars`
                });
                
                // ğŸ§ª Turk tracking (v5.54.11) - fire and forget, no state
                if (window.turkTracker) window.turkTracker.track('start_analysis');
                
                const response = await fetch('/api/analyze', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify(requestBody)
                });
                
                // Response received â€” flash 100% then clear
                clearInterval(progressInterval);
                setAnalysisProgress({ current: 100, total: 100, message: 'Analysis complete!', tip: 'âœ… Done!' });
                // Brief flash of 100% for satisfying UX
                await new Promise(r => setTimeout(r, 400));
                setAnalysisProgress({ current: 0, total: 0, message: '' });
                
                console.log(`ğŸ“¥ Response status: ${response.status} ${response.statusText}`);
                console.log('ğŸ“‹ Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                  const errorText = await response.text();
                  console.error('âŒ Error response:', errorText);
                  
                  // Special handling for credits error (403)
                  if (response.status === 403) {
                    try {
                      const errorJson = JSON.parse(errorText);
                      if (errorJson.credits_remaining === 0 || errorJson.error === 'No analysis credits') {
                        console.log('ğŸ’³ No credits remaining, redirecting to pricing...');
                        // Redirect to pricing page with message
                        window.location.href = '/pricing?message=' + encodeURIComponent('You have no analysis credits remaining. Please purchase more credits to continue.');
                        return;
                      }
                    } catch (e) {
                      // If parsing fails, continue with normal error handling
                    }
                  }
                  
                  // Normal error handling
                  try {
                    const errorJson = JSON.parse(errorText);
                    throw new Error(errorJson.error || 'Analysis failed');
                  } catch (e) {
                    throw new Error(`Analysis failed: ${response.status} - ${errorText}`);
                  }
                }
                
                const data = await response.json();
                console.log('âœ… ANALYSIS COMPLETE!');
                console.log('ğŸ“Š Result data:', data);
                console.log('ğŸ¯ Setting result state and moving to results step...');
                
                setResult(data);
                window.currentAnalysisResult = data; // For share modal (v5.52.7)
                setCurrentStep('results');
                
                // ğŸ§ª Turk tracking (v5.54.11) - fire and forget, no state
                if (window.turkTracker) window.turkTracker.track('analysis_complete');
                
                // Save analysis to history
                saveAnalysisToHistory(data, propertyData, buyerProfile);
                
                console.log('âœ¨ State updated! Should now show results.');
                
              } catch (err) {
                // Clear progress indicators on error
                clearInterval(progressInterval);
                setAnalysisProgress({ current: 0, total: 0, message: '' });
                
                console.error('âŒ ANALYSIS ERROR:', err);
                console.error('Error details:', err.message, err.stack);
                setError(`Analysis failed: ${err.message}`);
                alert(`Analysis Error: ${err.message}\n\nCheck console (F12) for details.`);
              } finally {
                setLoading(false);
                console.log('ğŸ Analysis function complete (loading set to false)');
              }
            };
            
            // REMOVED AUTO-ANALYZE: User must click "Analyze" button to start
            // This ensures user explicitly consents to spending a credit
            
            // Helper to format budget
            const formatBudget = (budget) => {
              console.log('formatBudget called with:', budget, 'type:', typeof budget);
              const num = parseInt(String(budget).replace(/[^0-9]/g, ''));
              console.log('formatBudget parsed to:', num);
              const result = isNaN(num) || num === 0 ? '$0' : '$' + num.toLocaleString();
              console.log('formatBudget returning:', result);
              return result;
            };
            
            // Helper to format tolerance
            const formatTolerance = (tolerance) => {
              const labels = {
                'low': 'Low - Move-in ready',
                'moderate': 'Moderate - Some repairs OK',
                'high': 'High - Major renovations OK'
              };
              return labels[tolerance] || tolerance;
            };
            
            // Helper to format fear
            const formatFear = (fear) => {
              const labels = {
                'overpay': 'Overpaying',
                'lose_house': 'Losing the house',
                'hidden_issues': 'Hidden issues'
              };
              return labels[fear] || fear;
            };
            
            return (
              <div style={styles.container}>
                <button onClick={() => setCurrentStep('property')} style={styles.backButton}>
                  â† Back
                </button>
                
                <h2 style={styles.subtitle}>Generate Analysis</h2>
                
                {error && <div style={styles.error}>{error}</div>}
                
                {/* Property Details */}
                <div style={{
                  background: 'rgba(30, 41, 59, 0.6)',
                  border: '1px solid rgba(59, 130, 246, 0.2)',
                  borderRadius: '12px',
                  padding: '16px',
                  marginBottom: '12px'
                }}>
                  <h3 style={{
                    fontSize: '16px',
                    fontWeight: 600,
                    color: '#60a5fa',
                    marginBottom: '16px',
                    marginTop: 0
                  }}>
                    Property Details
                  </h3>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ color: '#94a3b8', fontSize: '14px' }}>Address:</span>
                      <span style={{ color: '#e2e8f0', fontSize: '14px', fontWeight: 500, textAlign: 'right', maxWidth: '60%' }}>
                        {propertyData.address}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ color: '#94a3b8', fontSize: '14px' }}>Asking Price:</span>
                      <span style={{ color: '#e2e8f0', fontSize: '14px', fontWeight: 600 }}>
                        ${propertyData.price?.toLocaleString()}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ color: '#94a3b8', fontSize: '14px' }}>Documents:</span>
                      <span style={{ color: '#10b981', fontSize: '14px', fontWeight: 500 }}>
                        {propertyData.inspectionText ? 'âœ“ Disclosure + Inspection' : 'âœ“ Disclosure only'}
                      </span>
                    </div>
                  </div>
                </div>
                
                {/* Buyer Preferences */}
                <div style={{
                  background: 'rgba(30, 41, 59, 0.6)',
                  border: '1px solid rgba(168, 85, 247, 0.2)',
                  borderRadius: '12px',
                  padding: '16px',
                  marginBottom: '12px'
                }}>
                  <h3 style={{
                    fontSize: '16px',
                    fontWeight: 600,
                    color: '#a78bfa',
                    marginBottom: '16px',
                    marginTop: 0
                  }}>
                    Your Preferences
                  </h3>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ color: '#94a3b8', fontSize: '14px' }}>Max Budget:</span>
                      <span style={{ color: '#e2e8f0', fontSize: '14px', fontWeight: 600 }}>
                        {(() => {
                          console.log('=== DISPLAYING BUDGET IN PREFERENCES ===');
                          console.log('buyerProfile object:', buyerProfile);
                          console.log('buyerProfile.max_budget value:', buyerProfile.max_budget);
                          console.log('buyerProfile.max_budget type:', typeof buyerProfile.max_budget);
                          const formatted = formatBudget(buyerProfile.max_budget);
                          console.log('After formatBudget:', formatted);
                          console.log('=== END DISPLAY ===');
                          return formatted;
                        })()}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                      <span style={{ color: '#94a3b8', fontSize: '14px' }}>Repair Tolerance:</span>
                      <span style={{ color: '#e2e8f0', fontSize: '14px', fontWeight: 500, textAlign: 'right', maxWidth: '60%' }}>
                        {formatTolerance(buyerProfile.repair_tolerance)}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ color: '#94a3b8', fontSize: '14px' }}>Biggest Fear:</span>
                      <span style={{ color: '#e2e8f0', fontSize: '14px', fontWeight: 500 }}>
                        {formatFear(buyerProfile.biggest_regret)}
                      </span>
                    </div>
                  </div>
                  <div style={{
                    marginTop: '16px',
                    paddingTop: '16px',
                    borderTop: '1px solid rgba(168, 85, 247, 0.2)',
                    fontSize: '12px',
                    color: '#94a3b8',
                    textAlign: 'center'
                  }}>
                    <a href="/settings" 
                       onClick={(e) => {
                         // Save property data to localStorage so we don't lose uploaded files
                         try {
                           localStorage.setItem('temp_property_data', JSON.stringify(propertyData));
                           console.log('Saved property data to localStorage before profile update');
                         } catch (err) {
                           console.error('Failed to save property data:', err);
                         }
                       }}
                       style={{ color: '#a78bfa', textDecoration: 'none' }}>
                      Update preferences
                    </a>
                  </div>
                </div>
                
                <button
                  onClick={handleAnalyze}
                  disabled={loading}
                  style={{
                    ...styles.button,
                    opacity: loading ? 0.7 : 1
                  }}
                >
                  {loading ? 'Analyzing (10-30s)...' : 'Generate Analysis â†’'}
                </button>
                
                {loading && (
                  <div style={{
                    marginTop: '24px',
                    padding: '24px',
                    backgroundColor: '#f8fafc',
                    borderRadius: '12px',
                    border: '2px solid #e2e8f0'
                  }}>
                    {/* Show progress bar if we have analysis progress info */}
                    {analysisProgress.total > 0 ? (
                      <div style={{width: '100%'}}>
                        {/* Analysis Progress Message */}
                        <div style={{
                          fontSize: '18px',
                          fontWeight: '600',
                          color: '#1e293b',
                          marginBottom: '16px',
                          textAlign: 'center'
                        }}>
                          {analysisProgress.message || 'Analyzing property...'}
                        </div>
                        
                        {/* Progress Bar */}
                        <div style={{
                          width: '100%',
                          height: '32px',
                          backgroundColor: '#e2e8f0',
                          borderRadius: '8px',
                          overflow: 'hidden',
                          marginBottom: '12px',
                          border: '2px solid #cbd5e1',
                          position: 'relative'
                        }}>
                          <div style={{
                            width: `${(analysisProgress.current / analysisProgress.total) * 100}%`,
                            height: '100%',
                            backgroundColor: '#3b82f6',
                            transition: 'width 0.5s ease',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            position: 'relative'
                          }}>
                            {/* Animated shine effect */}
                            <div style={{
                              position: 'absolute',
                              top: 0,
                              left: '-100%',
                              width: '100%',
                              height: '100%',
                              background: 'linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)',
                              animation: 'shine 2s infinite'
                            }}></div>
                          </div>
                          
                          {/* Percentage Overlay */}
                          <div style={{
                            position: 'absolute',
                            top: '50%',
                            left: '50%',
                            transform: 'translate(-50%, -50%)',
                            fontSize: '16px',
                            fontWeight: '700',
                            color: '#1e293b',
                            textShadow: '0 0 3px white, 0 0 3px white'
                          }}>
                            {Math.round((analysisProgress.current / analysisProgress.total) * 100)}%
                          </div>
                        </div>
                        
                        {/* Progress percentage */}
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          color: '#475569',
                          textAlign: 'center'
                        }}>
                          {analysisProgress.current}% complete
                        </div>
                        
                        {/* Educational Tip */}
                        {analysisProgress.tip && (
                          <div style={{
                            marginTop: '16px',
                            padding: '12px 16px',
                            backgroundColor: '#eff6ff',
                            borderRadius: '8px',
                            border: '1px solid #bfdbfe',
                            textAlign: 'center'
                          }}>
                            <div style={{
                              fontSize: '15px',
                              color: '#1e40af',
                              fontWeight: '500'
                            }}>
                              {analysisProgress.tip}
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      /* Simple spinner before progress starts (first 2 seconds) */
                      <div style={{textAlign: 'center'}}>
                        <div style={{
                          width: '40px',
                          height: '40px',
                          border: '3px solid rgba(59, 130, 246, 0.2)',
                          borderTopColor: '#3b82f6',
                          borderRadius: '50%',
                          animation: 'spin 1s linear infinite',
                          margin: '0 auto 12px'
                        }}></div>
                        <div style={{fontSize: '14px', color: '#64748b'}}>
                          Starting analysis...
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          };
          
          // Results Step - Hybrid Design (Concept 2 + 4)
          const ResultsStep = () => {
            console.log('ğŸ¯ ResultsStep rendering, full result:', result);
            console.log('ğŸ§¬ risk_dna:', result?.risk_dna);
            console.log('ğŸ” transparency_report:', result?.transparency_report);
            console.log('ğŸ”® predicted_issues:', result?.predicted_issues);
            console.log('ğŸ“Š risk_score:', result?.risk_score);
            
            
            if (!result) {
              return (
                <div style={styles.container}>
                  <h2>Error: No Results</h2>
                  <p>No analysis results available.</p>
                  <button onClick={() => checkCreditsAndStartAnalysis()} style={styles.button}>
                    Start New Analysis
                  </button>
                </div>
              );
            }
            
            try {
              const { risk_score, cross_reference, offer_strategy, negotiation_strategy, decision_framework } = result;
              
              // Helper function: Calculate risk tier from Property Risk DNA composite score
              const getRiskTierFromComposite = (compositeScore) => {
                if (compositeScore >= 90) return { tier: 'CRITICAL', color: '#ef4444', label: 'Critical issues' };
                if (compositeScore >= 75) return { tier: 'HIGH', color: '#f97316', label: 'Significant issues' };
                if (compositeScore >= 60) return { tier: 'ELEVATED', color: '#f59e0b', label: 'Elevated concerns' };
                if (compositeScore >= 40) return { tier: 'MODERATE', color: '#fbbf24', label: 'Manageable issues' };
                if (compositeScore >= 20) return { tier: 'LOW', color: '#22c55e', label: 'Minor concerns' };
                return { tier: 'MINIMAL', color: '#10b981', label: 'Minimal concerns' };
              };
              
              // ğŸ’¡ Tooltip Component (v5.54.0)
              const Tooltip = ({ children, text }) => (
                <span className="tooltip-trigger" style={{ position: 'relative', display: 'inline-flex', alignItems: 'center', gap: '4px', cursor: 'help' }}>
                  {children}
                  <span className="tooltip-icon" style={{
                    width: '16px',
                    height: '16px',
                    borderRadius: '50%',
                    background: 'rgba(100, 116, 139, 0.3)',
                    color: '#94a3b8',
                    fontSize: '10px',
                    display: 'inline-flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontWeight: '700'
                  }}>?</span>
                  <span className="tooltip-content" style={{
                    position: 'absolute',
                    bottom: 'calc(100% + 8px)',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: '#1e293b',
                    border: '1px solid #334155',
                    borderRadius: '8px',
                    padding: '12px 16px',
                    minWidth: '220px',
                    maxWidth: '300px',
                    zIndex: 100,
                    boxShadow: '0 10px 40px rgba(0, 0, 0, 0.4)',
                    opacity: 0,
                    visibility: 'hidden',
                    transition: 'all 0.2s',
                    pointerEvents: 'none',
                    fontSize: '13px',
                    color: '#cbd5e1',
                    lineHeight: '1.5',
                    textAlign: 'left',
                    fontWeight: '400'
                  }}>{text}</span>
                </span>
              );
              
              // Use Property Risk DNA composite score as source of truth
              const compositeScore = result.risk_dna?.composite_score || 0;
              const riskTier = getRiskTierFromComposite(compositeScore);
              
              const isWalkAway = compositeScore >= 90 || 
                                (risk_score?.deal_breakers && risk_score.deal_breakers.length >= 3);
              
              // Calculate average repair cost
              const avgRepairCost = risk_score?.total_repair_cost_low && risk_score?.total_repair_cost_high
                ? Math.round((risk_score.total_repair_cost_low + risk_score.total_repair_cost_high) / 2000)
                : 0;
              
              return (
                <div style={{
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                  background: '#0f172a',
                  color: 'white',
                  minHeight: '100vh',
                  margin: '-8px',
                  padding: 0
                }}>
                  
                  {/* ğŸ¯ STICKY SUMMARY BAR (v5.54.0) - Updated v5.54.51 with CSS class toggle */}
                  <div 
                    ref={stickyBarRef}
                    className="sticky-summary-bar"
                    style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      zIndex: 1000,
                      background: 'rgba(15, 23, 42, 0.98)',
                      backdropFilter: 'blur(12px)',
                      borderBottom: '1px solid rgba(51, 65, 85, 0.5)',
                      padding: '10px 24px'
                      // CSS handles visibility via transform
                    }}
                  >
                    <div style={{
                      maxWidth: '1400px',
                      margin: '0 auto',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      gap: '16px',
                      flexWrap: 'wrap'
                    }}>
                      {/* Left: Key metrics */}
                      <div style={{ display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap' }}>
                        {/* OfferScore */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <span style={{ color: '#94a3b8', fontSize: '11px', fontWeight: '600' }}>OfferScoreâ„¢</span>
                          <span style={{ 
                            color: riskTier.color, 
                            fontSize: '20px', 
                            fontWeight: '900' 
                          }}>{Math.round(100 - compositeScore)}</span>
                        </div>
                        
                        <div style={{ width: '1px', height: '24px', background: '#334155' }} />
                        
                        {/* Recommended Offer */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <span style={{ color: '#94a3b8', fontSize: '11px', fontWeight: '600' }}>Offer</span>
                          <span style={{ 
                            color: '#60a5fa', 
                            fontSize: '16px', 
                            fontWeight: '800' 
                          }}>${offer_strategy?.recommended_offer ? Math.round(offer_strategy.recommended_offer).toLocaleString() : 'N/A'}</span>
                        </div>
                        
                        <div style={{ width: '1px', height: '24px', background: '#334155' }} />
                        
                        {/* Savings */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <span style={{ color: '#94a3b8', fontSize: '11px', fontWeight: '600' }}>Save</span>
                          <span style={{ 
                            color: '#22c55e', 
                            fontSize: '16px', 
                            fontWeight: '800' 
                          }}>${result.property_price && offer_strategy?.recommended_offer 
                            ? Math.round(result.property_price - offer_strategy.recommended_offer).toLocaleString() 
                            : '0'}</span>
                        </div>
                      </div>
                      
                      {/* Center: Section Navigation */}
                      <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                        {[
                          { id: 'risk-dna', label: 'ğŸ§¬ Risk' },
                          { id: 'external-verification', label: 'ğŸ¤– Verify' },
                          { id: 'transparency', label: 'ğŸ” Trust' },
                          { id: 'predictions', label: 'ğŸ”® Predict' },
                          { id: 'decision-path', label: 'ğŸ’¡ Decide' },
                          { id: 'toolkit', label: 'ğŸ¯ Toolkit' }
                        ].map(section => (
                          <button
                            key={section.id}
                            onClick={() => {
                              setActiveSection(section.id);
                              document.getElementById(section.id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }}
                            style={{
                              padding: '6px 12px',
                              borderRadius: '6px',
                              border: '1px solid rgba(100, 116, 139, 0.3)',
                              background: activeSection === section.id 
                                ? 'rgba(96, 165, 250, 0.2)' 
                                : 'transparent',
                              color: activeSection === section.id ? '#60a5fa' : '#94a3b8',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                          >
                            {section.label}
                          </button>
                        ))}
                      </div>
                      
                      {/* Right: Quick Actions */}
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button 
                          onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                          style={{
                            padding: '6px 12px',
                            background: 'rgba(96, 165, 250, 0.15)',
                            border: '1px solid rgba(96, 165, 250, 0.3)',
                            borderRadius: '6px',
                            color: '#60a5fa',
                            fontSize: '12px',
                            fontWeight: '600',
                            cursor: 'pointer'
                          }}
                        >
                          â†‘ Top
                        </button>
                        <button 
                          onClick={() => window.generatePrintReport()}
                          style={{
                            padding: '6px 12px',
                            background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            fontSize: '12px',
                            fontWeight: '600',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ“„ Print
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  {/* Clean Hero with Risk Rating */}
                  <div style={{
                    background: '#1e293b',
                    padding: '32px 24px',
                    borderBottom: '1px solid #334155',
                    marginBottom: '40px'
                  }}>
                    <div style={{
                      maxWidth: '1200px',
                      margin: '0 auto'
                    }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', gap: '24px', flexWrap: 'wrap' }}>
                        {/* Property Info */}
                        <div style={{ flex: 1 }}>
                          <h1 style={{
                            fontSize: '32px',
                            fontWeight: '800',
                            margin: '0 0 8px 0',
                            color: '#f1f5f9'
                          }}>
                            {result.property_address || 'Property Analysis'}
                          </h1>
                          <p style={{ 
                            fontSize: '16px', 
                            color: '#94a3b8', 
                            margin: '0' 
                          }}>
                            Asking ${result.property_price?.toLocaleString() || 'N/A'}
                          </p>
                        </div>
                        
                        {/* Risk Rating Badge - Uses Property Risk DNA */}
                        <div style={{
                          background: riskTier.color,
                          padding: '20px 32px',
                          borderRadius: '12px',
                          boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
                          textAlign: 'center',
                          minWidth: '200px'
                        }}>
                          <div style={{
                            fontSize: '14px',
                            fontWeight: '700',
                            textTransform: 'uppercase',
                            letterSpacing: '1.5px',
                            marginBottom: '8px',
                            color: 'rgba(255,255,255,0.95)'
                          }}>
                            Property Risk Rating
                          </div>
                          <div style={{
                            fontSize: '36px',
                            fontWeight: '900',
                            color: 'white',
                            textTransform: 'uppercase',
                            letterSpacing: '-0.5px'
                          }}>
                            {riskTier.tier}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Main Container */}
                  <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '20px 20px 40px 20px' }}>
                    
                    {/* ğŸ¯ SUMMARY CARD v5.56 â€” The ONE thing users need to see */}
                    {(() => {
                      // Derive top 3 findings from deal_breakers + red flags
                      const topFindings = [];
                      // Priority 1: Deal breakers (most critical)
                      if (risk_score?.deal_breakers) {
                        risk_score.deal_breakers.slice(0, 3).forEach(db => {
                          topFindings.push({ text: typeof db === 'string' ? db : (db.issue || db.title || db.description || 'Critical issue found'), severity: 'critical' });
                        });
                      }
                      // Priority 2: Red flags from transparency report
                      if (topFindings.length < 3 && result.transparency_report?.red_flags) {
                        result.transparency_report.red_flags.slice(0, 3 - topFindings.length).forEach(rf => {
                          topFindings.push({ text: typeof rf === 'string' ? rf : (rf.flag || rf.issue || rf.title || rf.description || 'Issue found'), severity: 'warning' });
                        });
                      }
                      // Priority 3: Highest-risk categories from risk_score
                      if (topFindings.length < 3 && risk_score?.category_scores) {
                        const catScores = Array.isArray(risk_score.category_scores) ? risk_score.category_scores : [];
                        const worstCategories = catScores
                          .map(c => ({ name: c.category || 'Unknown', score: c.score || 0 }))
                          .filter(c => c.score > 50)
                          .sort((a, b) => b.score - a.score)
                          .slice(0, 3 - topFindings.length);
                        worstCategories.forEach(({ name, score }) => {
                          topFindings.push({ text: `${name} risk elevated (${Math.round(score)}%)`, severity: score > 70 ? 'critical' : 'warning' });
                        });
                      }
                      
                      const offerScoreValue = Math.round(100 - compositeScore);
                      const actionWord = compositeScore < 20 ? 'Strong Buy' :
                                         compositeScore < 40 ? 'Buy' :
                                         compositeScore < 60 ? 'Proceed with Caution' :
                                         compositeScore < 75 ? 'Negotiate Hard' :
                                         'Walk Away';
                      const actionIcon = compositeScore < 40 ? 'âœ…' :
                                         compositeScore < 60 ? 'âš ï¸' :
                                         compositeScore < 75 ? 'ğŸ”¶' : 'ğŸš«';
                      
                      return (
                      <div style={{
                        maxWidth: '1200px',
                        margin: '0 auto 40px',
                        background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                        borderRadius: '24px',
                        border: `2px solid ${riskTier.color}40`,
                        boxShadow: `0 8px 40px ${riskTier.color}15, 0 0 0 1px rgba(255,255,255,0.05)`,
                        overflow: 'hidden'
                      }}>
                        {/* Card Header */}
                        <div style={{
                          background: `linear-gradient(135deg, ${riskTier.color}15, transparent)`,
                          padding: '20px 32px 16px',
                          borderBottom: '1px solid rgba(255,255,255,0.06)',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <div style={{ fontSize: '13px', color: '#94a3b8', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '1.5px' }}>
                            Your Analysis at a Glance
                          </div>
                          <div style={{ 
                            fontSize: '13px', 
                            color: riskTier.color, 
                            fontWeight: '700',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}>
                            {actionIcon} {actionWord}
                          </div>
                        </div>

                        {/* Card Body â€” 3 columns */}
                        <div className="summary-card-grid">
                          
                          {/* Column 1: OfferScore Circle */}
                          <div className="summary-card-score-col" style={{ 
                            display: 'flex', 
                            flexDirection: 'column', 
                            alignItems: 'center',
                            padding: '0 32px 0 8px'
                          }}>
                            <div style={{
                              width: '120px',
                              height: '120px',
                              borderRadius: '50%',
                              background: `conic-gradient(${riskTier.color} ${offerScoreValue * 3.6}deg, rgba(51, 65, 85, 0.4) 0deg)`,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              position: 'relative',
                              boxShadow: `0 0 30px ${riskTier.color}25`
                            }}>
                              <div style={{
                                width: '96px',
                                height: '96px',
                                borderRadius: '50%',
                                background: '#0f172a',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center'
                              }}>
                                <div style={{ fontSize: '36px', fontWeight: '900', color: riskTier.color, lineHeight: '1' }}>
                                  {offerScoreValue}
                                </div>
                                <div style={{ fontSize: '10px', color: '#94a3b8', fontWeight: '600', marginTop: '2px' }}>
                                  / 100
                                </div>
                              </div>
                            </div>
                            <div style={{ 
                              fontSize: '11px', 
                              color: '#64748b', 
                              marginTop: '10px', 
                              fontWeight: '600', 
                              textTransform: 'uppercase', 
                              letterSpacing: '1px' 
                            }}>
                              OfferScoreâ„¢
                            </div>
                          </div>

                          {/* Divider */}
                          <div className="summary-card-divider" style={{ background: 'rgba(51, 65, 85, 0.5)', width: '1px', alignSelf: 'stretch' }} />

                          {/* Column 2: The Numbers */}
                          <div style={{ padding: '0 28px' }}>
                            {/* Recommended Offer */}
                            <div style={{ marginBottom: '20px' }}>
                              <div style={{ fontSize: '11px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '6px' }}>
                                Recommended Offer
                              </div>
                              {offer_strategy?.recommended_offer ? (
                                <div style={{ fontSize: '32px', fontWeight: '900', color: '#60a5fa', lineHeight: '1.1' }}>
                                  ${Math.round(offer_strategy.recommended_offer).toLocaleString()}
                                </div>
                              ) : (
                                <div style={{ fontSize: '16px', color: '#475569', fontStyle: 'italic' }}>Calculating...</div>
                              )}
                            </div>
                            
                            {/* Key numbers row */}
                            <div style={{ display: 'flex', gap: '20px' }}>
                              {offer_strategy?.recommended_offer && result.property_price && (result.property_price - offer_strategy.recommended_offer) > 0 && (
                                <div>
                                  <div style={{ fontSize: '11px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                                    Below Asking
                                  </div>
                                  <div style={{ fontSize: '18px', fontWeight: '800', color: '#22c55e' }}>
                                    ${Math.round(result.property_price - offer_strategy.recommended_offer).toLocaleString()}
                                  </div>
                                </div>
                              )}
                              <div>
                                <div style={{ fontSize: '11px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                                  Est. Repairs
                                </div>
                                <div style={{ fontSize: '18px', fontWeight: '800', color: '#f59e0b' }}>
                                  ${avgRepairCost > 0 ? `${avgRepairCost}K` : (risk_score?.total_repair_cost_low ? `${Math.round(risk_score.total_repair_cost_low / 1000)}K` : 'N/A')}
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Divider */}
                          <div className="summary-card-divider" style={{ background: 'rgba(51, 65, 85, 0.5)', width: '1px', alignSelf: 'stretch' }} />

                          {/* Column 3: Top Findings */}
                          <div style={{ padding: '0 8px 0 28px' }}>
                            <div style={{ fontSize: '11px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '12px' }}>
                              Top Findings
                            </div>
                            {topFindings.length > 0 ? (
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                {topFindings.slice(0, 3).map((finding, idx) => (
                                  <div key={idx} style={{
                                    display: 'flex',
                                    alignItems: 'start',
                                    gap: '10px',
                                    fontSize: '14px',
                                    lineHeight: '1.4'
                                  }}>
                                    <span style={{ 
                                      flexShrink: 0,
                                      width: '6px',
                                      height: '6px',
                                      borderRadius: '50%',
                                      background: finding.severity === 'critical' ? '#ef4444' : '#f59e0b',
                                      marginTop: '6px'
                                    }} />
                                    <span style={{ 
                                      color: finding.severity === 'critical' ? '#fca5a5' : '#fde68a',
                                      fontWeight: '500'
                                    }}>
                                      {finding.text.length > 80 ? finding.text.substring(0, 77) + '...' : finding.text}
                                    </span>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#22c55e', fontSize: '14px' }}>
                                <span>âœ“</span> No significant issues found
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Card Footer â€” Scroll nudge */}
                        <div style={{
                          padding: '14px 32px',
                          borderTop: '1px solid rgba(255,255,255,0.06)',
                          display: 'flex',
                          justifyContent: 'center'
                        }}>
                          <button 
                            onClick={() => {
                              const el = document.getElementById('risk-dna');
                              if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }}
                            style={{
                              background: 'none',
                              border: 'none',
                              color: '#64748b',
                              fontSize: '13px',
                              fontWeight: '500',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              padding: '4px 12px',
                              borderRadius: '8px',
                              transition: 'color 0.2s'
                            }}
                            onMouseOver={(e) => e.currentTarget.style.color = '#94a3b8'}
                            onMouseOut={(e) => e.currentTarget.style.color = '#64748b'}
                          >
                            Explore full analysis â†“
                          </button>
                        </div>
                      </div>
                      );
                    })()}
                    
                    {/* ğŸ¨ EXECUTIVE SUMMARY - REDESIGNED */}
                    <div style={{
                      maxWidth: '1200px',
                      margin: '0 auto 48px',
                      padding: '0 24px'
                    }}>
                      
                        <div style={{
                        background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                        borderRadius: '20px',
                        overflow: 'hidden',
                        border: `3px solid ${riskTier.color}`,
                        boxShadow: `0 20px 60px ${riskTier.color}40`,
                        marginBottom: '32px'
                      }}>
                        {/* Top Bar with OfferScore */}
                        <div style={{
                          background: `linear-gradient(135deg, ${riskTier.color}20, ${riskTier.color}10)`,
                          padding: '24px 32px',
                          borderBottom: `2px solid ${riskTier.color}40`,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          flexWrap: 'wrap',
                          gap: '20px'
                        }}>
                          <div>
                            <div style={{
                              fontSize: '14px',
                              color: '#94a3b8',
                              fontWeight: '600',
                              textTransform: 'uppercase',
                              letterSpacing: '1.5px',
                              marginBottom: '8px'
                            }}>
                              OfferScoreâ„¢ <span style={{ fontSize: '11px', fontStyle: 'italic', opacity: 0.7 }}>Patent Pending</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'baseline', gap: '16px' }}>
                              <div style={{
                                fontSize: '72px',
                                fontWeight: '900',
                                color: riskTier.color,
                                lineHeight: '1',
                                textShadow: `0 0 30px ${riskTier.color}50`
                              }}>
                                {Math.round(100 - compositeScore)}
                              </div>
                              <div>
                                <div style={{
                                  fontSize: '24px',
                                  fontWeight: '700',
                                  color: riskTier.color,
                                  textTransform: 'uppercase',
                                  letterSpacing: '1px'
                                }}>
                                  {compositeScore < 20 ? 'STRONG BUY' :
                                   compositeScore < 40 ? 'BUY' :
                                   compositeScore < 60 ? 'PROCEED WITH CAUTION' :
                                   'WALK AWAY'}
                                </div>
                                <div style={{ fontSize: '13px', color: '#64748b', marginTop: '4px' }}>
                                  {compositeScore < 20 ? 'Excellent investment opportunity' :
                                   compositeScore < 40 ? 'Good value with manageable issues' :
                                   compositeScore < 60 ? 'Significant concerns to address' :
                                   'Critical issues make this high-risk'}
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Quick Risk Level Badge */}
                          <div style={{
                            background: riskTier.color,
                            padding: '16px 24px',
                            borderRadius: '12px',
                            textAlign: 'center',
                            minWidth: '140px'
                          }}>
                            <div style={{
                              fontSize: '12px',
                              fontWeight: '700',
                              color: 'rgba(255,255,255,0.9)',
                              textTransform: 'uppercase',
                              letterSpacing: '1px',
                              marginBottom: '4px'
                            }}>Risk Level</div>
                            <div style={{
                              fontSize: '20px',
                              fontWeight: '800',
                              color: 'white'
                            }}>{riskTier.tier}</div>
                          </div>
                        </div>

                        {/* THE NUMBER THAT MATTERS */}
                        <div style={{
                          padding: '40px 32px',
                          background: 'linear-gradient(180deg, rgba(96, 165, 250, 0.05), transparent)'
                        }}>
                          <div style={{
                            textAlign: 'center',
                            marginBottom: '32px'
                          }}>
                            <div style={{
                              fontSize: '16px',
                              color: '#94a3b8',
                              fontWeight: '600',
                              textTransform: 'uppercase',
                              letterSpacing: '1.5px',
                              marginBottom: '12px'
                            }}>
                              ğŸ’° Recommended Offer Strategy
                            </div>
                            {offer_strategy?.recommended_offer ? (
                              <>
                                <div style={{
                                  fontSize: '56px',
                                  fontWeight: '900',
                                  color: '#60a5fa',
                                  lineHeight: '1.1',
                                  marginBottom: '12px',
                                  textShadow: '0 0 40px rgba(96, 165, 250, 0.3)'
                                }}>
                                  ${Math.round(offer_strategy.recommended_offer).toLocaleString()}
                                </div>
                                {offer_strategy.discount_percentage > 0 && (
                                  <div style={{
                                    display: 'inline-block',
                                    background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                    padding: '12px 24px',
                                    borderRadius: '12px',
                                    marginTop: '8px'
                                  }}>
                                    <span style={{ fontSize: '18px', fontWeight: '700', color: 'white' }}>
                                      {Math.round(offer_strategy.discount_percentage)}% below asking price
                                    </span>
                                  </div>
                                )}
                                
                                {/* ğŸ“Š VISUAL OFFER COMPARISON BAR (v5.54.0) */}
                                {result.property_price && offer_strategy.recommended_offer && (
                                  <div style={{
                                    marginTop: '32px',
                                    padding: '24px',
                                    background: 'rgba(15, 23, 42, 0.5)',
                                    borderRadius: '16px',
                                    border: '1px solid rgba(51, 65, 85, 0.5)'
                                  }}>
                                    <div style={{ 
                                      fontSize: '13px', 
                                      color: '#94a3b8', 
                                      fontWeight: '600',
                                      marginBottom: '16px',
                                      textTransform: 'uppercase',
                                      letterSpacing: '1px'
                                    }}>
                                      ğŸ’° Price Comparison
                                    </div>
                                    
                                    {/* The visual bar */}
                                    <div style={{ position: 'relative', marginBottom: '20px' }}>
                                      {/* Full bar (asking price) */}
                                      <div style={{
                                        height: '40px',
                                        background: 'rgba(239, 68, 68, 0.2)',
                                        borderRadius: '8px',
                                        border: '1px solid rgba(239, 68, 68, 0.4)',
                                        position: 'relative',
                                        overflow: 'hidden'
                                      }}>
                                        {/* Recommended offer portion */}
                                        <div style={{
                                          position: 'absolute',
                                          top: 0,
                                          left: 0,
                                          height: '100%',
                                          width: `${(offer_strategy.recommended_offer / result.property_price) * 100}%`,
                                          background: 'linear-gradient(90deg, #22c55e, #16a34a)',
                                          borderRadius: '7px 0 0 7px',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          transition: 'width 1s ease-out'
                                        }}>
                                          <span style={{ 
                                            color: 'white', 
                                            fontWeight: '700', 
                                            fontSize: '14px',
                                            textShadow: '0 1px 2px rgba(0,0,0,0.3)'
                                          }}>
                                            ${Math.round(offer_strategy.recommended_offer).toLocaleString()}
                                          </span>
                                        </div>
                                        
                                        {/* Savings portion - v5.54.65 only show if savings > 0 */}
                                        {(result.property_price - offer_strategy.recommended_offer) > 0 && (
                                        <div style={{
                                          position: 'absolute',
                                          top: 0,
                                          right: 0,
                                          height: '100%',
                                          width: `${Math.max(((result.property_price - offer_strategy.recommended_offer) / result.property_price) * 100, 15)}%`,
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          background: 'rgba(239, 68, 68, 0.15)',
                                          borderRadius: '0 7px 7px 0'
                                        }}>
                                          <span style={{ 
                                            color: '#ef4444', 
                                            fontWeight: '700', 
                                            fontSize: '12px',
                                            background: 'rgba(15, 23, 42, 0.8)',
                                            padding: '2px 8px',
                                            borderRadius: '4px'
                                          }}>
                                            -${Math.round(result.property_price - offer_strategy.recommended_offer).toLocaleString()}
                                          </span>
                                        </div>
                                        )}
                                      </div>
                                    </div>
                                    
                                    {/* Legend */}
                                    <div style={{ 
                                      display: 'flex', 
                                      justifyContent: 'space-between',
                                      fontSize: '13px'
                                    }}>
                                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <div style={{ width: '12px', height: '12px', borderRadius: '3px', background: '#22c55e' }} />
                                        <span style={{ color: '#94a3b8' }}>Your Offer</span>
                                      </div>
                                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <div style={{ width: '12px', height: '12px', borderRadius: '3px', background: 'rgba(239, 68, 68, 0.4)' }} />
                                        <span style={{ color: '#94a3b8' }}>Asking: ${result.property_price.toLocaleString()}</span>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </>
                            ) : (
                              <div style={{
                                padding: '24px',
                                background: 'rgba(96, 165, 250, 0.1)',
                                border: '2px dashed rgba(96, 165, 250, 0.3)',
                                borderRadius: '12px',
                                textAlign: 'center'
                              }}>
                                <div style={{ fontSize: '32px', marginBottom: '12px' }}>ğŸ”„</div>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: '#60a5fa', marginBottom: '8px' }}>
                                  Calculating optimal offer range...
                                </div>
                                <div style={{ fontSize: '14px', color: '#94a3b8', lineHeight: '1.6' }}>
                                  Our AI is analyzing market data, repair costs, and negotiation leverage to determine your best offer strategy.
                                </div>
                              </div>
                            )}
                          </div>

                          {/* Action Buttons Row */}
                          <div style={{
                            display: 'flex',
                            gap: '16px',
                            justifyContent: 'center',
                            flexWrap: 'wrap',
                            marginBottom: '32px'
                          }}>
                            <button style={{
                              padding: '16px 32px',
                              background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                              color: 'white',
                              border: 'none',
                              borderRadius: '12px',
                              fontSize: '16px',
                              fontWeight: '700',
                              cursor: 'pointer',
                              boxShadow: '0 4px 12px rgba(59, 130, 246, 0.3)',
                              transition: 'all 0.2s',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}
                            onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                            onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                            onClick={() => window.generatePrintReport()}>
                              ğŸ“„ Download Report
                            </button>
                            <button style={{
                              padding: '16px 32px',
                              background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                              color: 'white',
                              border: 'none',
                              borderRadius: '12px',
                              fontSize: '16px',
                              fontWeight: '700',
                              cursor: 'pointer',
                              boxShadow: '0 4px 12px rgba(245, 158, 11, 0.3)',
                              transition: 'all 0.2s',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}
                            onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                            onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                            onClick={() => window.openNegotiationCoach()}>
                              ğŸ¯ Negotiation Coach
                            </button>
                            <button style={{
                              padding: '16px 32px',
                              background: 'rgba(96, 165, 250, 0.15)',
                              color: '#60a5fa',
                              border: '2px solid #60a5fa',
                              borderRadius: '12px',
                              fontSize: '16px',
                              fontWeight: '700',
                              cursor: 'pointer',
                              transition: 'all 0.2s',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}
                            onMouseOver={(e) => e.target.style.background = 'rgba(96, 165, 250, 0.25)'}
                            onMouseOut={(e) => e.target.style.background = 'rgba(96, 165, 250, 0.15)'}
                            onClick={() => {
                              // Show sharing modal
                              const modal = document.createElement('div');
                              modal.id = 'share-modal';
                              modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);';
                              
                              const result = window.currentAnalysisResult;
                              const askingPrice = result?.property_price || 0;
                              const recommendedOffer = result?.offer_strategy?.recommended_offer || 0;
                              const savings = Math.max(0, Math.round((askingPrice - recommendedOffer) / 1000) * 1000);
                              
                              modal.innerHTML = `
                                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 24px; padding: 0; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 1px solid rgba(96, 165, 250, 0.3); overflow: hidden;">
                                  <!-- Header -->
                                  <div style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); padding: 32px; text-align: center; position: relative;">
                                    <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‰</div>
                                    <h2 style="font-size: var(--text-h2); font-weight: 700; color: white; margin: 0 0 8px 0;">Share Your Win!</h2>
                                    <p style="color: rgba(255, 255, 255, 0.9); font-size: var(--text-body-sm); margin: 0;">
                                      You saved $${savings.toLocaleString()} on this property!
                                    </p>
                                    <button onclick="document.getElementById('share-modal').remove()" style="position: absolute; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: var(--text-body-lg); display: flex; align-items: center; justify-content: center;">Ã—</button>
                                  </div>
                                  
                                  <!-- Body -->
                                  <div style="padding: 32px;">
                                    <p style="font-size: var(--text-body-sm); color: #cbd5e1; margin-bottom: 24px; line-height: 1.6; text-align: center;">
                                      Help your friends save money too. Share on social media!
                                    </p>
                                    
                                    <!-- Share Buttons -->
                                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                      <button onclick="window.shareAnalysisTwitter('${savings.toLocaleString()}'); document.getElementById('share-modal').remove();" style="flex: 1; padding: 14px 20px; background: rgba(0, 0, 0, 0.2); color: #e7e9ea; border: 2px solid #000000; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: var(--text-body-sm); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='rgba(0, 0, 0, 0.3)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                        Twitter
                                      </button>
                                      <button onclick="window.shareAnalysisFacebook(); document.getElementById('share-modal').remove();" style="flex: 1; padding: 14px 20px; background: rgba(24, 119, 242, 0.2); color: #1877f2; border: 2px solid #1877f2; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: var(--text-body-sm); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='rgba(24, 119, 242, 0.3)'" onmouseout="this.style.background='rgba(24, 119, 242, 0.2)'">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                        Facebook
                                      </button>
                                      <button onclick="window.shareAnalysisLinkedIn('${savings.toLocaleString()}'); document.getElementById('share-modal').remove();" style="flex: 1; padding: 14px 20px; background: rgba(10, 102, 194, 0.2); color: #0a66c2; border: 2px solid #0a66c2; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: var(--text-body-sm); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='rgba(10, 102, 194, 0.3)'" onmouseout="this.style.background='rgba(10, 102, 194, 0.2)'">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                        LinkedIn
                                      </button>
                                    </div>
                                    
                                    <!-- Tip -->
                                    <div style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3);">
                                      <div style="font-size: var(--text-caption); color: #cbd5e1; line-height: 1.5;">
                                        ğŸ’¡ <strong>Tip:</strong> Tag the property address or real estate agent for maximum impact!
                                      </div>
                                    </div>
                                    
                                    <!-- Close Button -->
                                    <button onclick="document.getElementById('share-modal').remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #475569; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(100, 116, 139, 0.3)'" onmouseout="this.style.background='rgba(100, 116, 139, 0.2)'">
                                      Maybe Later
                                    </button>
                                  </div>
                                </div>
                              `;
                              
                              document.body.appendChild(modal);
                              
                              // Close on backdrop click
                              modal.addEventListener('click', (e) => {
                                if (e.target === modal) {
                                  modal.remove();
                                }
                              });
                            }}>
                              ğŸ“£ Share Your Win
                            </button>
                            <button style={{
                              padding: '16px 32px',
                              background: 'linear-gradient(135deg, #14b8a6, #0d9488)',
                              color: 'white',
                              border: 'none',
                              borderRadius: '12px',
                              fontSize: '16px',
                              fontWeight: '700',
                              cursor: 'pointer',
                              boxShadow: '0 4px 12px rgba(20, 184, 166, 0.3)',
                              transition: 'all 0.2s',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}
                            onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                            onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                            onClick={() => window.openSecondOpinionModal(result)}>
                              ğŸ¤ Get a Second Opinion
                            </button>
                            <button style={{
                              padding: '16px 32px',
                              background: 'rgba(251, 191, 36, 0.15)',
                              color: '#fbbf24',
                              border: '2px solid #fbbf24',
                              borderRadius: '12px',
                              fontSize: '16px',
                              fontWeight: '700',
                              cursor: 'pointer',
                              transition: 'all 0.2s',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}
                            onMouseOver={(e) => e.target.style.background = 'rgba(251, 191, 36, 0.25)'}
                            onMouseOut={(e) => e.target.style.background = 'rgba(251, 191, 36, 0.15)'}
                            onClick={() => window.location.href = '/dashboard'}>
                              â† Back to Dashboard
                            </button>
                          </div>

                          {/* Critical Issues Alert - IF ANY */}
                          {risk_score?.deal_breakers && risk_score.deal_breakers.length > 0 && (
                            <div style={{
                              background: 'rgba(239, 68, 68, 0.1)',
                              border: '2px solid #ef4444',
                              borderRadius: '16px',
                              padding: '24px',
                              marginTop: '24px'
                            }}>
                              <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                marginBottom: '16px'
                              }}>
                                <span style={{ fontSize: '32px' }}>ğŸš¨</span>
                                <div>
                                  <h3 style={{
                                    fontSize: '20px',
                                    fontWeight: '700',
                                    color: '#ef4444',
                                    margin: '0 0 4px 0'
                                  }}>
                                    {risk_score.deal_breakers.length} Critical {risk_score.deal_breakers.length === 1 ? 'Issue' : 'Issues'} Require Attention
                                  </h3>
                                  <p style={{ fontSize: '14px', color: '#94a3b8', margin: 0 }}>
                                    These must be addressed in negotiations
                                  </p>
                                </div>
                              </div>
                              <div style={{
                                display: 'grid',
                                gap: '12px'
                              }}>
                                {risk_score.deal_breakers.slice(0, 3).map((issue, idx) => (
                                  <div key={idx} style={{
                                    background: 'rgba(15, 23, 42, 0.5)',
                                    padding: '16px',
                                    borderRadius: '12px',
                                    borderLeft: '4px solid #ef4444'
                                  }}>
                                    <div style={{
                                      display: 'flex',
                                      alignItems: 'start',
                                      gap: '12px'
                                    }}>
                                      <span style={{ fontSize: '20px', flexShrink: 0 }}>âš ï¸</span>
                                      <div style={{ flex: 1 }}>
                                        <div style={{
                                          fontSize: '15px',
                                          fontWeight: '600',
                                          color: '#fca5a5',
                                          marginBottom: '4px'
                                        }}>
                                          {issue}
                                        </div>
                                        <div style={{ fontSize: '13px', color: '#94a3b8' }}>
                                          Include in inspection contingency and price negotiation
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              {risk_score.deal_breakers.length > 3 && (
                                <div style={{
                                  marginTop: '12px',
                                  padding: '12px',
                                  background: 'rgba(239, 68, 68, 0.1)',
                                  borderRadius: '8px',
                                  textAlign: 'center',
                                  fontSize: '14px',
                                  color: '#ef4444',
                                  fontWeight: '600'
                                }}>
                                  + {risk_score.deal_breakers.length - 3} more critical {risk_score.deal_breakers.length - 3 === 1 ? 'issue' : 'issues'} (see full report below)
                                </div>
                              )}
                            </div>
                          )}

                          {/* Property Strengths - Show the Good! */}
                          {risk_score?.positive_findings && risk_score.positive_findings.length > 0 && (
                            <div style={{
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '2px solid #22c55e',
                              borderRadius: '16px',
                              padding: '24px',
                              marginTop: '24px'
                            }}>
                              <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                marginBottom: '16px'
                              }}>
                                <span style={{ fontSize: '32px' }}>âœ¨</span>
                                <div>
                                  <h3 style={{
                                    fontSize: '20px',
                                    fontWeight: '700',
                                    color: '#22c55e',
                                    margin: '0 0 4px 0'
                                  }}>
                                    {risk_score.positive_findings.length} Property Strengths
                                  </h3>
                                  <p style={{ fontSize: '14px', color: '#94a3b8', margin: 0 }}>
                                    What's working in your favor
                                  </p>
                                </div>
                              </div>
                              <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '12px'
                              }}>
                                {risk_score.positive_findings.slice(0, 6).map((finding, idx) => (
                                  <div key={idx} style={{
                                    padding: '12px 16px',
                                    background: 'rgba(34, 197, 94, 0.1)',
                                    borderRadius: '10px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px',
                                    border: '1px solid rgba(34, 197, 94, 0.3)'
                                  }}>
                                    <span style={{ fontSize: '18px' }}>âœ…</span>
                                    <span style={{
                                      fontSize: '14px',
                                      fontWeight: '600',
                                      color: '#86efac',
                                      lineHeight: '1.4'
                                    }}>
                                      {finding}
                                    </span>
                                  </div>
                                ))}
                              </div>
                              {risk_score.positive_findings.length > 6 && (
                                <div style={{
                                  marginTop: '12px',
                                  textAlign: 'center',
                                  fontSize: '13px',
                                  color: '#94a3b8'
                                }}>
                                  + {risk_score.positive_findings.length - 6} more strengths
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Quick Stats Row */}
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                        gap: '16px',
                        marginBottom: '48px'
                      }}>
                        {/* Estimated Repairs */}
                        <div style={{
                          background: '#1e293b',
                          padding: '24px',
                          borderRadius: '12px',
                          border: '1px solid #334155',
                          textAlign: 'center'
                        }}>
                          <div style={{
                            fontSize: '14px',
                            color: '#94a3b8',
                            marginBottom: '8px',
                            textTransform: 'uppercase',
                            letterSpacing: '1px',
                            fontWeight: '600'
                          }}>
                            Estimated Repairs
                          </div>
                          <div style={{
                            fontSize: '28px',
                            fontWeight: '800',
                            color: '#fbbf24',
                            marginBottom: '4px'
                          }}>
                            ${risk_score?.total_repair_cost_low?.toLocaleString() || '0'} - ${risk_score?.total_repair_cost_high?.toLocaleString() || '0'}
                          </div>
                          <div style={{
                            fontSize: '13px',
                            color: '#64748b'
                          }}>
                            Average: ${avgRepairCost?.toLocaleString() || '0'}k
                          </div>
                        </div>

                        {/* Risk Level */}
                        <div style={{
                          background: '#1e293b',
                          padding: '24px',
                          borderRadius: '12px',
                          border: '1px solid #334155',
                          textAlign: 'center'
                        }}>
                          <div style={{
                            fontSize: '14px',
                            color: '#94a3b8',
                            marginBottom: '12px',
                            textTransform: 'uppercase',
                            letterSpacing: '1px',
                            fontWeight: '600'
                          }}>
                            Risk Level
                          </div>
                          <div style={{
                            fontSize: '32px',
                            fontWeight: '800',
                            color: riskTier.color,
                            lineHeight: '1.2'
                          }}>
                            {riskTier.tier}
                          </div>
                          <div style={{
                            fontSize: '14px',
                            color: '#64748b',
                            marginTop: '8px'
                          }}>
                            {riskTier.label}
                          </div>
                        </div>

                        {/* Transparency Score */}
                        <div style={{
                          background: '#1e293b',
                          padding: '24px',
                          borderRadius: '12px',
                          border: '1px solid #334155',
                          textAlign: 'center'
                        }}>
                          <div style={{
                            fontSize: '14px',
                            color: '#94a3b8',
                            marginBottom: '8px',
                            textTransform: 'uppercase',
                            letterSpacing: '1px',
                            fontWeight: '600'
                          }}>
                            Seller Transparency
                          </div>
                          <div style={{
                            fontSize: '28px',
                            fontWeight: '800',
                            color: (() => {
                              const transparencyScore = result.transparency_report?.transparency_score;
                              if (!transparencyScore) return '#94a3b8';
                              if (transparencyScore >= 80) return '#10b981';
                              if (transparencyScore >= 60) return '#fbbf24';
                              return '#ef4444';
                            })(),
                            marginBottom: '4px'
                          }}>
                            {(() => {
                              // Transparency score is in transparency_report.transparency_score
                              const transparencyScore = result.transparency_report?.transparency_score;
                              return transparencyScore ? `${Math.round(transparencyScore)}%` : 'â€”';
                            })()}
                          </div>
                          <div style={{
                            fontSize: '13px',
                            color: '#64748b'
                          }}>
                            {(() => {
                              const transparencyScore = result.transparency_report?.transparency_score;
                              // Count total evidence items across all red flags
                              const totalIssues = result.transparency_report?.red_flags?.reduce((total, flag) => {
                                if (!flag.evidence) return total;
                                if (typeof flag.evidence === 'string') {
                                  // Count bullet-separated items in string
                                  const items = flag.evidence.split('â€¢').filter(item => item.trim().replace(/^-\s*/, ''));
                                  return total + items.length;
                                } else if (Array.isArray(flag.evidence)) {
                                  // Count array items
                                  return total + flag.evidence.filter(item => item.trim().replace(/^-\s*/, '')).length;
                                }
                                return total;
                              }, 0) || 0;
                              
                              if (transparencyScore) {
                                return `${totalIssues} item${totalIssues === 1 ? '' : 's'} not disclosed`;
                              } else {
                                return 'No seller disclosure uploaded';
                              }
                            })()}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* ğŸ§­ SECTION NAVIGATION (v5.54.0) */}
                    <div id="section-nav" style={{
                      maxWidth: '1200px',
                      margin: '0 auto 32px',
                      padding: '0 24px'
                    }}>
                      <div className="section-nav" style={{
                        display: 'flex',
                        gap: '8px',
                        flexWrap: 'wrap',
                        justifyContent: 'center',
                        padding: '16px',
                        background: 'rgba(30, 41, 59, 0.5)',
                        borderRadius: '16px',
                        border: '1px solid rgba(51, 65, 85, 0.3)'
                      }}>
                        {[
                          { id: 'risk-dna', label: 'ğŸ§¬ Risk DNA', icon: 'ğŸ§¬' },
                          { id: 'transparency', label: 'ğŸ” Transparency', icon: 'ğŸ”' },
                          { id: 'predictions', label: 'ğŸ”® Predictions', icon: 'ğŸ”®' },
                          { id: 'decision-path', label: 'ğŸ’¡ Decision Path', icon: 'ğŸ’¡' },
                          { id: 'toolkit', label: 'ğŸ¯ Toolkit', icon: 'ğŸ¯' }
                        ].map(section => (
                          <button
                            key={section.id}
                            onClick={() => {
                              setActiveSection(section.id);
                              document.getElementById(section.id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }}
                            className={`section-nav-pill ${activeSection === section.id ? 'active' : ''}`}
                            style={{
                              padding: '10px 20px',
                              borderRadius: '25px',
                              border: activeSection === section.id 
                                ? 'none' 
                                : '1px solid rgba(100, 116, 139, 0.3)',
                              background: activeSection === section.id 
                                ? 'linear-gradient(135deg, #3b82f6, #2563eb)' 
                                : 'transparent',
                              color: activeSection === section.id ? 'white' : '#94a3b8',
                              fontSize: '14px',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseOver={(e) => {
                              if (activeSection !== section.id) {
                                e.target.style.background = 'rgba(96, 165, 250, 0.1)';
                                e.target.style.borderColor = 'rgba(96, 165, 250, 0.3)';
                                e.target.style.color = '#60a5fa';
                              }
                            }}
                            onMouseOut={(e) => {
                              if (activeSection !== section.id) {
                                e.target.style.background = 'transparent';
                                e.target.style.borderColor = 'rgba(100, 116, 139, 0.3)';
                                e.target.style.color = '#94a3b8';
                              }
                            }}
                          >
                            {section.label}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* ğŸš€ BILLION-DOLLAR INNOVATIONS - NEW SECTIONS */}
                    
                    {/* Property Risk DNAâ„¢ */}
                    {(() => {
                      console.log('ğŸ§¬ Risk DNA data:', result.risk_dna);
                      return true;
                    })() && (
                      <div id="risk-dna" style={{
                        background: '#1e293b',
                        borderRadius: '12px',
                        padding: '32px',
                        marginBottom: '48px',
                        border: '1px solid #334155',
                        maxWidth: '1200px',
                        margin: '0 auto 48px',
                        scrollMarginTop: '80px'
                      }}>
                        
                        <h2 style={{
                          fontSize: '24px',
                          fontWeight: '700',
                          marginBottom: '8px',
                          color: '#cbd5e1'
                        }}>
                          ğŸ§¬ Property Risk DNAâ„¢
                        </h2>
                        
                        <p style={{ fontSize: '16px', color: '#94a3b8', lineHeight: '1.6', marginBottom: '8px' }}>
                          Multi-dimensional risk analysis across 5 key property categories.
                        </p>
                        
                        <div style={{
                          fontSize: '13px',
                          color: '#64748b',
                          fontStyle: 'italic',
                          marginBottom: '24px',
                          padding: '8px 12px',
                          background: 'rgba(251, 191, 36, 0.1)',
                          borderRadius: '6px',
                          borderLeft: '3px solid #fbbf24'
                        }}>
                          âš ï¸ <strong style={{ color: '#fbbf24' }}>Note:</strong> Risk DNA measures cumulative risk level (higher score = more risk). 
                          This is different from OfferScoreâ„¢ which measures property quality (higher score = better quality).
                        </div>
                        
                        {/* Composite Score Display - REDESIGNED FOR EFFICIENCY */}
                        {result.risk_dna ? (
                          <>
                          <div style={{
                            background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
                            borderRadius: '12px',
                            padding: '24px',
                            marginBottom: '24px',
                            border: `2px solid ${
                              (result.risk_dna.composite_score || 0) >= 90 ? '#dc2626' :
                              (result.risk_dna.composite_score || 0) >= 75 ? '#ef4444' :
                              (result.risk_dna.composite_score || 0) >= 60 ? '#f97316' :
                              (result.risk_dna.composite_score || 0) >= 40 ? '#fbbf24' :
                              (result.risk_dna.composite_score || 0) >= 20 ? '#60a5fa' : '#10b981'
                            }`,
                            boxShadow: `0 8px 24px ${
                              (result.risk_dna.composite_score || 0) >= 90 ? 'rgba(220, 38, 38, 0.3)' :
                              (result.risk_dna.composite_score || 0) >= 75 ? 'rgba(239, 68, 68, 0.2)' :
                              (result.risk_dna.composite_score || 0) >= 60 ? 'rgba(249, 115, 22, 0.2)' :
                              (result.risk_dna.composite_score || 0) >= 40 ? 'rgba(251, 191, 36, 0.2)' :
                              (result.risk_dna.composite_score || 0) >= 20 ? 'rgba(96, 165, 250, 0.2)' : 'rgba(16, 185, 129, 0.2)'
                            }`
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '32px', flexWrap: 'wrap' }}>
                              {/* Compact Score Display */}
                              <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                {/* Mini gauge indicator */}
                                <div style={{ position: 'relative', width: '80px', height: '80px' }}>
                                  <div style={{
                                    width: '100%',
                                    height: '100%',
                                    borderRadius: '50%',
                                    background: `conic-gradient(${
                                      (result.risk_dna.composite_score || 0) >= 90 ? '#dc2626' :
                                      (result.risk_dna.composite_score || 0) >= 75 ? '#ef4444' :
                                      (result.risk_dna.composite_score || 0) >= 60 ? '#f97316' :
                                      (result.risk_dna.composite_score || 0) >= 40 ? '#fbbf24' :
                                      (result.risk_dna.composite_score || 0) >= 20 ? '#60a5fa' : '#10b981'
                                    } 0% ${result.risk_dna.composite_score || 0}%, #1e293b ${result.risk_dna.composite_score || 0}% 100%)`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                  }}>
                                    <div style={{
                                      width: '60px',
                                      height: '60px',
                                      borderRadius: '50%',
                                      background: '#0f172a',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      fontSize: '24px',
                                      fontWeight: '800',
                                      color: (result.risk_dna.composite_score || 0) >= 90 ? '#dc2626' :
                                             (result.risk_dna.composite_score || 0) >= 75 ? '#ef4444' :
                                             (result.risk_dna.composite_score || 0) >= 60 ? '#f97316' :
                                             (result.risk_dna.composite_score || 0) >= 40 ? '#fbbf24' :
                                             (result.risk_dna.composite_score || 0) >= 20 ? '#60a5fa' : '#10b981'
                                    }}>
                                      {Math.round(result.risk_dna.composite_score || 0)}
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Inline interpretation */}
                                <div>
                                  <div style={{
                                    fontSize: '28px',
                                    fontWeight: '800',
                                    color: getRiskTierFromComposite(result.risk_dna.composite_score || 0).color,
                                    textTransform: 'uppercase',
                                    letterSpacing: '1px',
                                    marginBottom: '4px'
                                  }}>
                                    {getRiskTierFromComposite(result.risk_dna.composite_score || 0).tier}
                                  </div>
                                  <div style={{
                                    fontSize: '13px',
                                    color: '#94a3b8'
                                  }}>
                                    Composite Risk Score
                                  </div>
                                </div>
                              </div>
                              
                              {/* Inline risk category explanation */}
                              <div style={{ 
                                flex: 1,
                                minWidth: '250px',
                                paddingLeft: '24px',
                                borderLeft: '2px solid #334155'
                              }}>
                                <div style={{
                                  fontSize: '16px',
                                  fontWeight: '700',
                                  color: getRiskTierFromComposite(result.risk_dna.composite_score || 0).color,
                                  marginBottom: '8px'
                                }}>
                                  {getRiskTierFromComposite(result.risk_dna.composite_score || 0).tier}
                                </div>
                                <div style={{
                                  fontSize: '14px',
                                  color: '#cbd5e1',
                                  lineHeight: '1.5'
                                }}>
                                  {(result.risk_dna.composite_score || 0) >= 90 ? 'Critical issues requiring immediate attention and likely deal-breaking' :
                                   (result.risk_dna.composite_score || 0) >= 75 ? 'Multiple severe issues requiring immediate attention' :
                                   (result.risk_dna.composite_score || 0) >= 60 ? 'Significant concerns across multiple categories' :
                                   (result.risk_dna.composite_score || 0) >= 40 ? 'Some concerns worth monitoring and budgeting for' :
                                   (result.risk_dna.composite_score || 0) >= 20 ? 'Minor issues with manageable impact' : 
                                   'Property in good condition with minimal risk factors'}
                                </div>
                              </div>
                            </div>
                          </div>
                        
                        {/* ğŸ•¸ï¸ RADAR CHART - Risk DNA Visualization (v5.54.1 - Fixed labels) */}
                        <div style={{
                          display: 'flex',
                          justifyContent: 'center',
                          marginBottom: '24px',
                          padding: '24px',
                          background: 'rgba(15, 23, 42, 0.5)',
                          borderRadius: '16px',
                          border: '1px solid rgba(51, 65, 85, 0.3)'
                        }}>
                          <svg width="380" height="380" viewBox="0 0 380 380">
                            {/* Background grid - v5.54.63 increased visibility */}
                            {[0.2, 0.4, 0.6, 0.8, 1].map((scale, i) => (
                              <polygon
                                key={i}
                                points={[0, 1, 2, 3, 4].map(i => {
                                  const angle = (i * 72 - 90) * Math.PI / 180;
                                  const r = 110 * scale;
                                  return `${190 + r * Math.cos(angle)},${190 + r * Math.sin(angle)}`;
                                }).join(' ')}
                                fill="none"
                                stroke="rgba(148, 163, 184, 0.4)"
                                strokeWidth="1"
                              />
                            ))}
                            
                            {/* Axis lines - v5.54.63 increased visibility */}
                            {[0, 1, 2, 3, 4].map(i => {
                              const angle = (i * 72 - 90) * Math.PI / 180;
                              return (
                                <line
                                  key={i}
                                  x1="190"
                                  y1="190"
                                  x2={190 + 110 * Math.cos(angle)}
                                  y2={190 + 110 * Math.sin(angle)}
                                  stroke="rgba(148, 163, 184, 0.5)"
                                  strokeWidth="1"
                                />
                              );
                            })}
                            
                            {/* Data polygon - Using correct Risk DNA fields */}
                            <polygon
                              points={[
                                result.risk_dna?.structural_score || 0,
                                result.risk_dna?.systems_score || 0,
                                result.risk_dna?.transparency_score || 0,
                                result.risk_dna?.temporal_score || 0,
                                result.risk_dna?.financial_score || 0
                              ].map((score, i) => {
                                const angle = (i * 72 - 90) * Math.PI / 180;
                                const r = (score / 100) * 110;
                                return `${190 + r * Math.cos(angle)},${190 + r * Math.sin(angle)}`;
                              }).join(' ')}
                              fill="rgba(239, 68, 68, 0.3)"
                              stroke="#ef4444"
                              strokeWidth="2"
                            />
                            
                            {/* Data points */}
                            {[
                              result.risk_dna?.structural_score || 0,
                              result.risk_dna?.systems_score || 0,
                              result.risk_dna?.transparency_score || 0,
                              result.risk_dna?.temporal_score || 0,
                              result.risk_dna?.financial_score || 0
                            ].map((score, i) => {
                              const angle = (i * 72 - 90) * Math.PI / 180;
                              const r = (score / 100) * 110;
                              return (
                                <circle
                                  key={i}
                                  cx={190 + r * Math.cos(angle)}
                                  cy={190 + r * Math.sin(angle)}
                                  r="6"
                                  fill="#ef4444"
                                  stroke="white"
                                  strokeWidth="2"
                                />
                              );
                            })}
                            
                            {/* Labels - Matching Risk Vector Analysis */}
                            {[
                              { label: 'Structural', score: result.risk_dna?.structural_score || 0 },
                              { label: 'Systems', score: result.risk_dna?.systems_score || 0 },
                              { label: 'Transparency', score: result.risk_dna?.transparency_score || 0 },
                              { label: 'Temporal', score: result.risk_dna?.temporal_score || 0 },
                              { label: 'Financial', score: result.risk_dna?.financial_score || 0 }
                            ].map((item, i) => {
                              const angle = (i * 72 - 90) * Math.PI / 180;
                              const r = 140;
                              const x = 190 + r * Math.cos(angle);
                              const y = 190 + r * Math.sin(angle);
                              return (
                                <g key={i}>
                                  <text
                                    x={x}
                                    y={y}
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fill="#94a3b8"
                                    fontSize="12"
                                    fontWeight="600"
                                  >
                                    {item.label}
                                  </text>
                                  <text
                                    x={x}
                                    y={y + 16}
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fill={item.score >= 60 ? '#ef4444' : item.score >= 40 ? '#f59e0b' : '#22c55e'}
                                    fontSize="14"
                                    fontWeight="700"
                                  >
                                    {Math.round(item.score)}
                                  </text>
                                </g>
                              );
                            })}
                          </svg>
                        </div>
                        
                        {/* Risk Vector Breakdown */}
                        <div style={{ marginTop: '16px' }}>
                          <h3 style={{ fontSize: '20px', fontWeight: '700', color: '#10b981', marginBottom: '12px' }}>
                            ğŸ”¬ Risk Vector Analysis
                          </h3>
                          
                          {/* EXPLANATION BOX */}
                          <div style={{
                            background: 'rgba(16, 185, 129, 0.05)',
                            borderRadius: '8px',
                            padding: '12px 16px',
                            marginBottom: '12px',
                            border: '1px solid rgba(16, 185, 129, 0.2)'
                          }}>
                            <div style={{ fontSize: '13px', color: '#94a3b8', lineHeight: '1.6' }}>
                              Risk DNA analyzes property risk across 5 key dimensions. Each measures different aspects that affect your investment:
                            </div>
                          </div>
                          
                          {/* LEGEND INSIDE SECTION */}
                          <div style={{
                            background: 'rgba(59, 130, 246, 0.1)',
                            borderRadius: '8px',
                            padding: '12px 16px',
                            marginBottom: '16px',
                            border: '1px solid rgba(59, 130, 246, 0.3)'
                          }}>
                            <div style={{
                              fontSize: '12px',
                              fontWeight: '600',
                              color: '#60a5fa',
                              marginBottom: '8px',
                              textAlign: 'center'
                            }}>
                              Risk Vector Scale
                            </div>
                            <div style={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              fontSize: '11px',
                              color: '#cbd5e1',
                              textAlign: 'center',
                              gap: '6px'
                            }}>
                              {/* FIXED: Match backend categories from property_risk_dna.py */}
                              <div style={{ flex: 1, padding: '4px', background: 'rgba(16, 185, 129, 0.15)', borderRadius: '4px', border: '1px solid rgba(16, 185, 129, 0.4)' }}>
                                <div style={{ fontWeight: '700', color: '#10b981', fontSize: '10px' }}>0-20</div>
                                <div style={{ fontSize: '9px', color: '#6ee7b7' }}>MINIMAL</div>
                              </div>
                              <div style={{ flex: 1, padding: '4px', background: 'rgba(96, 165, 250, 0.15)', borderRadius: '4px', border: '1px solid rgba(96, 165, 250, 0.4)' }}>
                                <div style={{ fontWeight: '700', color: '#60a5fa', fontSize: '10px' }}>20-40</div>
                                <div style={{ fontSize: '9px', color: '#93c5fd' }}>LOW</div>
                              </div>
                              <div style={{ flex: 1, padding: '4px', background: 'rgba(251, 191, 36, 0.15)', borderRadius: '4px', border: '1px solid rgba(251, 191, 36, 0.4)' }}>
                                <div style={{ fontWeight: '700', color: '#fbbf24', fontSize: '10px' }}>40-60</div>
                                <div style={{ fontSize: '9px', color: '#fcd34d' }}>MODERATE</div>
                              </div>
                              <div style={{ flex: 1, padding: '4px', background: 'rgba(249, 115, 22, 0.15)', borderRadius: '4px', border: '1px solid rgba(249, 115, 22, 0.4)' }}>
                                <div style={{ fontWeight: '700', color: '#f97316', fontSize: '10px' }}>60-75</div>
                                <div style={{ fontSize: '9px', color: '#fb923c' }}>ELEVATED</div>
                              </div>
                              <div style={{ flex: 1, padding: '4px', background: 'rgba(239, 68, 68, 0.15)', borderRadius: '4px', border: '1px solid rgba(239, 68, 68, 0.4)' }}>
                                <div style={{ fontWeight: '700', color: '#ef4444', fontSize: '10px' }}>75-90</div>
                                <div style={{ fontSize: '9px', color: '#fca5a5' }}>HIGH</div>
                              </div>
                              <div style={{ flex: 1, padding: '4px', background: 'rgba(220, 38, 38, 0.2)', borderRadius: '4px', border: '1px solid rgba(220, 38, 38, 0.5)' }}>
                                <div style={{ fontWeight: '700', color: '#dc2626', fontSize: '10px' }}>90-100</div>
                                <div style={{ fontSize: '9px', color: '#f87171' }}>CRITICAL</div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Merged: Each card now shows score + interpretation inline */}
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '12px' }}>
                            {[
                              { 
                                name: 'Structural', 
                                key: 'structural', 
                                icon: 'ğŸ—ï¸',
                                description: 'Foundation, roof, framing integrity'
                              },
                              { 
                                name: 'Systems', 
                                key: 'systems', 
                                icon: 'âš™ï¸',
                                description: 'Electrical, plumbing, HVAC'
                              },
                              { 
                                name: 'Transparency', 
                                key: 'transparency', 
                                icon: 'ğŸ‘ï¸',
                                description: 'Seller disclosure honesty'
                              },
                              { 
                                name: 'Temporal', 
                                key: 'temporal', 
                                icon: 'â±ï¸',
                                description: 'Age, deferred maintenance, time to failure'
                              },
                              { 
                                name: 'Financial', 
                                key: 'financial', 
                                icon: 'ğŸ’°',
                                description: 'Repair costs & value impact'
                              }
                            ].map((vector, i) => {
                              const score = result.risk_dna.risk_vectors && result.risk_dna.risk_vectors[vector.key] ?
                                Math.round(result.risk_dna.risk_vectors[vector.key].reduce((a, b) => a + b, 0) / 
                                result.risk_dna.risk_vectors[vector.key].length * 100) : 50;
                              
                              // FIXED: Match backend categories from property_risk_dna.py
                              // Backend: minimal (0-20), low (20-40), moderate (40-60), elevated (60-75), high (75-90), critical (90-100)
                              const riskLevel = score >= 90 ? 'CRITICAL' : score >= 75 ? 'HIGH' : score >= 60 ? 'ELEVATED' : score >= 40 ? 'MODERATE' : score >= 20 ? 'LOW' : 'MINIMAL';
                              const riskColor = score >= 90 ? '#dc2626' : score >= 75 ? '#ef4444' : score >= 60 ? '#f97316' : score >= 40 ? '#fbbf24' : score >= 20 ? '#60a5fa' : '#10b981';
                              
                              return (
                                <div key={i} style={{
                                  background: '#0f172a',
                                  padding: '16px',
                                  borderRadius: '10px',
                                  border: `2px solid ${riskColor}`,
                                  position: 'relative',
                                  transition: 'transform 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                                >
                                  {/* Icon + Name + Description */}
                                  <div style={{ marginBottom: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                      <div style={{ fontSize: '24px' }}>{vector.icon}</div>
                                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#cbd5e1' }}>
                                        {vector.name}
                                      </div>
                                    </div>
                                    <div style={{ fontSize: '11px', color: '#64748b', marginLeft: '32px', lineHeight: '1.3' }}>
                                      {vector.description}
                                    </div>
                                  </div>
                                  
                                  {/* Score + Risk Level (MERGED!) */}
                                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px', marginBottom: '8px' }}>
                                    <div style={{ fontSize: '32px', fontWeight: '800', color: riskColor, lineHeight: '1' }}>
                                      {score}
                                    </div>
                                    <div style={{ 
                                      fontSize: '11px', 
                                      fontWeight: '700', 
                                      color: riskColor,
                                      textTransform: 'uppercase',
                                      letterSpacing: '0.5px',
                                      padding: '2px 6px',
                                      background: `${riskColor}20`,
                                      borderRadius: '4px'
                                    }}>
                                      {riskLevel}
                                    </div>
                                  </div>
                                  
                                  {/* Progress Bar - FIXED: Correct gradient (low score = low risk) */}
                                  <div style={{
                                    height: '6px',
                                    background: 'linear-gradient(to right, #10b981 0%, #10b981 20%, #60a5fa 20%, #60a5fa 40%, #fbbf24 40%, #fbbf24 60%, #f97316 60%, #f97316 75%, #ef4444 75%, #ef4444 90%, #dc2626 90%, #dc2626 100%)',
                                    borderRadius: '3px',
                                    position: 'relative',
                                    marginBottom: '4px'
                                  }}>
                                    {/* Marker showing current score */}
                                    <div style={{
                                      position: 'absolute',
                                      left: `${score}%`,
                                      top: '-3px',
                                      width: '12px',
                                      height: '12px',
                                      background: riskColor,
                                      border: '2px solid #0f172a',
                                      borderRadius: '50%',
                                      transform: 'translateX(-50%)',
                                      boxShadow: `0 0 8px ${riskColor}`
                                    }}></div>
                                  </div>
                                  
                                  {/* Inline scale labels - FIXED: Correct order (low = good, high = bad) */}
                                  <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between',
                                    fontSize: '9px',
                                    color: '#64748b',
                                    fontWeight: '600',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.3px'
                                  }}>
                                    <span style={{ color: '#10b981' }}>Min</span>
                                    <span style={{ color: '#60a5fa' }}>Low</span>
                                    <span style={{ color: '#fbbf24' }}>Mod</span>
                                    <span style={{ color: '#f97316' }}>Elev</span>
                                    <span style={{ color: '#dc2626' }}>Crit</span>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                        </>
                        ) : (
                          <div style={{
                            background: 'rgba(239, 68, 68, 0.1)',
                            border: '2px solid rgba(239, 68, 68, 0.3)',
                            borderRadius: '16px',
                            padding: '30px',
                            textAlign: 'center'
                          }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>âš ï¸</div>
                            <div style={{ fontSize: '20px', fontWeight: '700', color: '#ef4444', marginBottom: '12px' }}>
                              Risk DNA Data Not Available
                            </div>
                            <div style={{ fontSize: '14px', color: '#cbd5e1', lineHeight: '1.6' }}>
                              The Risk DNA analysis module encountered an issue during generation. 
                              Please check the backend logs for errors related to risk_dna encoding.
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* ğŸ¤– External Verification (Property Research Agent) */}
                    {researchData?.profile && (
                      <div id="external-verification" style={{
                        background: '#1e293b',
                        borderRadius: '12px',
                        padding: '32px',
                        marginBottom: '48px',
                        border: '1px solid rgba(245, 158, 11, 0.3)',
                        maxWidth: '1200px',
                        margin: '0 auto 48px',
                        scrollMarginTop: '80px'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                          <h2 style={{ fontSize: '24px', fontWeight: '700', color: '#cbd5e1', margin: 0 }}>
                            ğŸ¤– External Verification
                          </h2>
                          <span style={{ 
                            fontSize: '10px', fontWeight: '700', 
                            background: 'rgba(245, 158, 11, 0.15)', 
                            color: '#f59e0b', 
                            padding: '3px 10px', 
                            borderRadius: '4px',
                            letterSpacing: '0.05em'
                          }}>
                            AGENT-POWERED
                          </span>
                        </div>
                        
                        <p style={{ fontSize: '14px', color: '#94a3b8', lineHeight: '1.6', marginBottom: '24px' }}>
                          Our AI agent independently researched this property using {researchData.tools_succeeded || 0} public data sources, 
                          then cross-referenced findings against the seller's disclosure.
                        </p>
                        
                        {/* Agent Findings */}
                        {researchData.profile.agent_findings?.length > 0 && (
                          <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '16px', fontWeight: '700', color: '#e2e8f0', marginBottom: '12px' }}>
                              Public Record Findings
                            </h3>
                            {researchData.profile.agent_findings.map((finding, i) => (
                              <div key={i} style={{
                                padding: '14px 16px',
                                marginBottom: '8px',
                                background: 'rgba(255, 255, 255, 0.02)',
                                borderLeft: `3px solid ${
                                  finding.severity === 'high' ? '#ef4444' : 
                                  finding.severity === 'medium' ? '#f59e0b' : '#3b82f6'
                                }`,
                                borderRadius: '0 8px 8px 0'
                              }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                  <span style={{
                                    fontSize: '10px', fontWeight: '700', textTransform: 'uppercase',
                                    letterSpacing: '0.05em',
                                    padding: '2px 8px', borderRadius: '4px',
                                    background: finding.severity === 'high' ? 'rgba(239,68,68,0.15)' : 
                                               finding.severity === 'medium' ? 'rgba(245,158,11,0.15)' : 'rgba(59,130,246,0.1)',
                                    color: finding.severity === 'high' ? '#ef4444' : 
                                           finding.severity === 'medium' ? '#f59e0b' : '#60a5fa'
                                  }}>
                                    {finding.severity}
                                  </span>
                                  <span style={{ fontSize: '10px', fontWeight: '600', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.03em' }}>
                                    {finding.type}
                                  </span>
                                </div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#e2e8f0', marginBottom: '4px' }}>
                                  {finding.title}
                                </div>
                                <div style={{ fontSize: '13px', color: '#94a3b8', lineHeight: '1.5', marginBottom: finding.cross_check ? '8px' : '0' }}>
                                  {finding.detail}
                                </div>
                                {finding.cross_check && (
                                  <div style={{
                                    fontSize: '12px', color: '#f59e0b',
                                    background: 'rgba(245, 158, 11, 0.06)',
                                    padding: '8px 12px', borderRadius: '6px',
                                    borderLeft: '2px solid rgba(245, 158, 11, 0.3)'
                                  }}>
                                    ğŸ“ <strong>Document cross-check:</strong> {finding.cross_check}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                        
                        {/* Property Quick Facts from Agent */}
                        <div style={{ marginBottom: '16px' }}>
                          <h3 style={{ fontSize: '16px', fontWeight: '700', color: '#e2e8f0', marginBottom: '12px' }}>
                            Property Intelligence
                          </h3>
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(170px, 1fr))', gap: '8px' }}>
                            {[
                              researchData.profile.estimated_value && { label: 'Estimated Value', value: `$${researchData.profile.estimated_value.toLocaleString()}`, icon: 'ğŸ’°' },
                              researchData.profile.year_built && { label: 'Year Built', value: researchData.profile.year_built, icon: 'ğŸ—“ï¸' },
                              researchData.profile.sqft && { label: 'Sq Ft', value: researchData.profile.sqft.toLocaleString(), icon: 'ğŸ“' },
                              researchData.profile.flood_zone && { label: 'Flood Zone', value: `${researchData.profile.flood_zone} (${researchData.profile.flood_risk_level})`, icon: 'ğŸŒŠ' },
                              researchData.profile.earthquake_zone !== null && { label: 'Earthquake Zone', value: researchData.profile.earthquake_zone ? 'Yes âš ï¸' : 'No', icon: 'ğŸŒ' },
                              researchData.profile.fire_hazard_zone && { label: 'Fire Hazard', value: researchData.profile.fire_hazard_zone, icon: 'ğŸ”¥' },
                              researchData.profile.walk_score && { label: 'Walk Score', value: `${researchData.profile.walk_score}/100`, icon: 'ğŸš¶' },
                              researchData.profile.permits?.length > 0 && { label: 'Permits on File', value: researchData.profile.permits.length, icon: 'ğŸ“‹' },
                              researchData.profile.annual_tax && { label: 'Annual Tax', value: `$${Math.round(researchData.profile.annual_tax).toLocaleString()}`, icon: 'ğŸ›ï¸' },
                            ].filter(Boolean).map((item, i) => (
                              <div key={i} style={{
                                background: 'rgba(255,255,255,0.03)',
                                border: '1px solid rgba(255,255,255,0.06)',
                                borderRadius: '8px',
                                padding: '10px 12px'
                              }}>
                                <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '4px' }}>
                                  {item.icon} {item.label}
                                </div>
                                <div style={{ fontSize: '15px', fontWeight: '700', color: '#e2e8f0', fontFamily: 'monospace' }}>
                                  {item.value}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                        
                        {/* AI Synthesis Brief */}
                        {researchData.synthesis?.brief && (
                          <div style={{
                            background: 'rgba(245, 158, 11, 0.04)',
                            border: '1px solid rgba(245, 158, 11, 0.12)',
                            borderRadius: '10px',
                            padding: '20px'
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                              <span style={{ fontSize: '14px' }}>ğŸ¤–</span>
                              <span style={{ fontSize: '13px', fontWeight: '700', color: '#f59e0b' }}>Intelligence Brief</span>
                              <span style={{ fontSize: '10px', color: '#64748b' }}>Generated from public records before document analysis</span>
                            </div>
                            <div style={{ fontSize: '13px', color: '#cbd5e1', lineHeight: '1.7', whiteSpace: 'pre-line' }}>
                              {researchData.synthesis.brief}
                            </div>
                          </div>
                        )}
                        
                        {/* Data Sources Attribution */}
                        <div style={{ marginTop: '16px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.06)' }}>
                          <div style={{ fontSize: '11px', color: '#475569' }}>
                            ğŸ“ Sources: {researchData.profile.tools_used?.map(t => 
                              t === 'geocoding' ? 'US Census' : 
                              t === 'flood_zone' ? 'FEMA' : 
                              t === 'ca_hazards' ? 'CAL FIRE / CGS' : 
                              t === 'redfin' ? 'Redfin' : 
                              t === 'permits' ? 'County Records' :
                              t === 'walk_score' ? 'WalkScore' :
                              t === 'school_ratings' ? 'GreatSchools' : t
                            ).join(' Â· ')}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Seller Transparency Reportâ„¢ */}
                    {(() => {
                      console.log('ğŸ” Transparency data:', result.transparency_report);
                      return true;
                    })() && (
                      <div id="transparency" style={{
                        background: '#1e293b',
                        borderRadius: '12px',
                        padding: '32px',
                        marginBottom: '48px',
                        border: '1px solid #334155',
                        maxWidth: '1200px',
                        margin: '0 auto 48px',
                        scrollMarginTop: '80px'
                      }}>
                        
                        <h2 style={{
                          fontSize: '24px',
                          fontWeight: '700',
                          marginBottom: '8px',
                          color: '#cbd5e1'
                        }}>
                          ğŸ” Seller Transparency Reportâ„¢
                        </h2>
                        
                        <p style={{ fontSize: '16px', color: '#94a3b8', lineHeight: '1.6', marginBottom: '8px' }}>
                          Analysis of seller disclosure quality - comparing what was disclosed versus what was found.
                        </p>
                        
                        <div style={{
                          fontSize: '13px',
                          color: '#64748b',
                          fontStyle: 'italic',
                          marginBottom: '24px',
                          padding: '8px 12px',
                          background: 'rgba(59, 130, 246, 0.1)',
                          borderRadius: '6px',
                          borderLeft: '3px solid #60a5fa'
                        }}>
                          ğŸ’¡ <strong style={{ color: '#60a5fa' }}>How it works:</strong> We cross-reference inspection findings with seller disclosures. 
                          Higher score = seller was more transparent and honest in their disclosures.
                        </div>
                        
                        {/* Transparency Score */}
                        {result.transparency_report ? (
                          <>
                          <div style={{
                            background: '#0f172a',
                            borderRadius: '16px',
                            padding: '24px',
                            marginBottom: '20px',
                            border: `2px solid ${
                              (result.transparency_report.transparency_score || 0) >= 85 ? '#10b981' :
                              (result.transparency_report.transparency_score || 0) >= 70 ? '#fbbf24' :
                              (result.transparency_report.transparency_score || 0) >= 55 ? '#f59e0b' : '#ef4444'
                            }`
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '24px', flexWrap: 'wrap' }}>
                              {/* Score Circle */}
                              <div>
                                <div style={{ position: 'relative', width: '140px', height: '140px' }}>
                                  <div style={{
                                    width: '100%',
                                    height: '100%',
                                    borderRadius: '50%',
                                    background: `conic-gradient(${
                                      (result.transparency_report.transparency_score || 0) >= 85 ? '#10b981' :
                                      (result.transparency_report.transparency_score || 0) >= 70 ? '#fbbf24' :
                                      (result.transparency_report.transparency_score || 0) >= 55 ? '#f59e0b' : '#ef4444'
                                    } 0% ${result.transparency_report.transparency_score || 0}%, #334155 ${result.transparency_report.transparency_score || 0}% 100%)`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                  }}>
                                    <div style={{
                                      width: '110px',
                                      height: '110px',
                                      borderRadius: '50%',
                                      background: '#0f172a',
                                      display: 'flex',
                                      flexDirection: 'column',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      border: '4px solid #1e293b'
                                    }}>
                                      <div style={{
                                        fontSize: '42px',
                                        fontWeight: '800',
                                        color: (result.transparency_report.transparency_score || 0) >= 85 ? '#10b981' :
                                               (result.transparency_report.transparency_score || 0) >= 70 ? '#fbbf24' :
                                               (result.transparency_report.transparency_score || 0) >= 55 ? '#f59e0b' : '#ef4444'
                                      }}>{result.transparency_report.transparency_score || 0}<span style={{fontSize: '18px'}}>/100</span></div>
                                      <div style={{ fontSize: '11px', color: '#94a3b8', marginTop: '4px', fontWeight: '600' }}>
                                        {(result.transparency_report.transparency_score || 0) >= 85 ? 'EXCELLENT' :
                                         (result.transparency_report.transparency_score || 0) >= 70 ? 'GOOD' :
                                         (result.transparency_report.transparency_score || 0) >= 55 ? 'FAIR' : 'GAPS FOUND'}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              
                              {/* Grade and Trust Level */}
                              <div style={{ flex: 1 }}>
                                <div style={{
                                  fontSize: '14px',
                                  color: '#64748b',
                                  textTransform: 'uppercase',
                                  letterSpacing: '2px',
                                  marginBottom: '8px'
                              }}>
                                Transparency Grade
                              </div>
                              <div style={{
                                fontSize: '56px',
                                fontWeight: '800',
                                color: result.transparency_report.transparency_score >= 85 ? '#10b981' :
                                       result.transparency_report.transparency_score >= 70 ? '#fbbf24' :
                                       result.transparency_report.transparency_score >= 55 ? '#f59e0b' : '#ef4444',
                                lineHeight: '1',
                                marginBottom: '16px'
                              }}>
                                {result.transparency_report.grade}
                              </div>
                              <div style={{
                                fontSize: '16px',
                                color: '#cbd5e1',
                                marginBottom: '20px'
                              }}>
                                Disclosure Quality: <strong style={{
                                  color: result.transparency_report.trust_level === 'high' ? '#10b981' :
                                         result.transparency_report.trust_level === 'medium' ? '#fbbf24' : '#ef4444',
                                  textTransform: 'none'
                                }}>{
                                  result.transparency_report.trust_level === 'VERY_LOW' ? 'Significant Gaps' :
                                  result.transparency_report.trust_level === 'very_low' ? 'Significant Gaps' :
                                  result.transparency_report.trust_level === 'LOW' ? 'Some Gaps' :
                                  result.transparency_report.trust_level === 'low' ? 'Some Gaps' :
                                  result.transparency_report.trust_level === 'MEDIUM' ? 'Moderate' :
                                  result.transparency_report.trust_level === 'medium' ? 'Moderate' :
                                  result.transparency_report.trust_level === 'HIGH' ? 'Strong' :
                                  result.transparency_report.trust_level === 'high' ? 'Strong' :
                                  result.transparency_report.trust_level === 'VERY_HIGH' ? 'Excellent' :
                                  result.transparency_report.trust_level.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase())
                                }</strong>
                              </div>
                              
                              {/* Score Breakdown */}
                              <div style={{
                                display: 'grid',
                                gridTemplateColumns: '1fr 1fr',
                                gap: '12px',
                                fontSize: '13px',
                                color: '#94a3b8'
                              }}>
                                <div>
                                  <span style={{ color: '#64748b' }}>Omission:</span>{' '}
                                  <strong>{result.transparency_report.omission_score}/100</strong>
                                </div>
                                <div>
                                  <span style={{ color: '#64748b' }}>Minimization:</span>{' '}
                                  <strong>{result.transparency_report.minimization_score}/100</strong>
                                </div>
                                <div>
                                  <span style={{ color: '#64748b' }}>Proactivity:</span>{' '}
                                  <strong>{result.transparency_report.proactivity_score}/100</strong>
                                </div>
                                <div>
                                  <span style={{ color: '#64748b' }}>Consistency:</span>{' '}
                                  <strong>{result.transparency_report.consistency_score}/100</strong>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Red Flags */}
                        {result.transparency_report.red_flags && result.transparency_report.red_flags.length > 0 && (
                          <div style={{ marginTop: '20px' }}>
                            <h3 style={{
                              fontSize: '20px',
                              fontWeight: '700',
                              color: '#ef4444',
                              marginBottom: '20px',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '10px'
                            }}>
                              ğŸš¨ {result.transparency_report.red_flags.length} Red Flag{result.transparency_report.red_flags.length > 1 ? 's' : ''} Detected
                            </h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                              {result.transparency_report.red_flags.map((flag, i) => (
                                <div key={i} style={{
                                  background: '#0f172a',
                                  padding: '24px',
                                  borderRadius: '12px',
                                  borderLeft: `4px solid ${
                                    flag.severity === 'critical' ? '#ef4444' :
                                    flag.severity === 'major' ? '#f59e0b' : '#fbbf24'
                                  }`
                                }}>
                                  <div style={{
                                    display: 'flex',
                                    alignItems: 'flex-start',
                                    gap: '16px'
                                  }}>
                                    <div style={{
                                      fontSize: '24px',
                                      minWidth: '32px'
                                    }}>
                                      {flag.severity === 'critical' ? 'â›”' : flag.severity === 'major' ? 'âš ï¸' : 'âš¡'}
                                    </div>
                                    <div style={{ flex: 1 }}>
                                      <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        marginBottom: '8px'
                                      }}>
                                        <div style={{
                                          fontSize: '16px',
                                          fontWeight: '700',
                                          color: '#f1f5f9',
                                          flex: 1
                                        }}>
                                          {flag.description}
                                        </div>
                                        {/* Evidence Strength Badge - v5.49.0 */}
                                        <div style={{
                                          display: 'inline-flex',
                                          alignItems: 'center',
                                          gap: '4px',
                                          padding: '4px 10px',
                                          borderRadius: '12px',
                                          fontSize: '10px',
                                          fontWeight: '600',
                                          background: flag.evidence && (typeof flag.evidence === 'string' ? flag.evidence.length > 50 : flag.evidence.length > 1)
                                            ? 'rgba(34, 197, 94, 0.15)'
                                            : flag.evidence 
                                              ? 'rgba(234, 179, 8, 0.15)'
                                              : 'rgba(239, 68, 68, 0.15)',
                                          color: flag.evidence && (typeof flag.evidence === 'string' ? flag.evidence.length > 50 : flag.evidence.length > 1)
                                            ? '#22c55e'
                                            : flag.evidence 
                                              ? '#eab308'
                                              : '#ef4444',
                                          border: `1px solid ${flag.evidence && (typeof flag.evidence === 'string' ? flag.evidence.length > 50 : flag.evidence.length > 1)
                                            ? 'rgba(34, 197, 94, 0.3)'
                                            : flag.evidence 
                                              ? 'rgba(234, 179, 8, 0.3)'
                                              : 'rgba(239, 68, 68, 0.3)'}`
                                        }}>
                                          {flag.evidence && (typeof flag.evidence === 'string' ? flag.evidence.length > 50 : flag.evidence.length > 1)
                                            ? 'ğŸŸ¢ VERIFIED'
                                            : flag.evidence 
                                              ? 'ğŸŸ¡ CITED'
                                              : 'ğŸ”´ INFERRED'}
                                        </div>
                                      </div>
                                      {flag.evidence && (typeof flag.evidence === 'string' ? flag.evidence : flag.evidence.length > 0) && (
                                        <div style={{
                                          fontSize: '14px',
                                          color: '#94a3b8',
                                          marginBottom: '12px',
                                          paddingLeft: '16px',
                                          borderLeft: '2px solid #334155'
                                        }}>
                                          {typeof flag.evidence === 'string' 
                                            ? flag.evidence.split('â€¢').map((item, idx) => {
                                                // Clean up: remove leading dash, trim whitespace
                                                const cleanItem = item.trim().replace(/^-\s*/, '');
                                                // Skip empty items or form field labels like "FINDINGS: None"
                                                if (!cleanItem) return null;
                                                if (/^[A-Z\s]+:\s*(None|N\/?A|No)\s*$/i.test(cleanItem)) return null;
                                                return (
                                                  <div key={idx} style={{ marginBottom: '4px' }}>
                                                    â€¢ {cleanItem}
                                                  </div>
                                                );
                                              })
                                            : flag.evidence.map((item, idx) => {
                                                // Clean up array items too
                                                const cleanItem = item.trim().replace(/^-\s*/, '');
                                                // Skip empty items or form field labels like "FINDINGS: None", "CONCERNS: None"
                                                if (!cleanItem) return null;
                                                if (/^[A-Z\s]+:\s*(None|N\/?A|No)\s*$/i.test(cleanItem)) return null;
                                                return (
                                                  <div key={idx} style={{ marginBottom: '4px' }}>
                                                    â€¢ {cleanItem}
                                                  </div>
                                                );
                                              })
                                          }
                                        </div>
                                      )}
                                      <div style={{
                                        fontSize: '13px',
                                        color: '#64748b',
                                        marginBottom: '8px'
                                      }}>
                                        <strong>Impact:</strong> {flag.impact}
                                      </div>
                                      
                                      {/* SOURCE TRACKING (v5.50.0) - CLICKABLE VIEW SOURCE BUTTONS (v5.51.0) */}
                                      {(flag.source_page || flag.disclosure_page || flag.inspection_page) && (
                                        <div style={{
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '12px',
                                          marginBottom: '12px',
                                          fontSize: '12px'
                                        }}>
                                          {flag.disclosure_page && (
                                            <button
                                              onClick={() => viewSourceScreenshot('disclosure', flag.disclosure_page, flag.flag || 'Disclosure Item', flag.source_quote || flag.detail || '')}
                                              style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '4px',
                                                padding: '4px 10px',
                                                background: propertyData?.disclosureFileObj ? 'rgba(96, 165, 250, 0.1)' : 'rgba(100, 100, 100, 0.1)',
                                                border: `1px solid ${propertyData?.disclosureFileObj ? 'rgba(96, 165, 250, 0.3)' : 'rgba(100, 100, 100, 0.3)'}`,
                                                borderRadius: '6px',
                                                color: propertyData?.disclosureFileObj ? '#60a5fa' : '#94a3b8',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                transition: 'all 0.2s'
                                              }}
                                              onMouseOver={(e) => e.target.style.background = propertyData?.disclosureFileObj ? 'rgba(96, 165, 250, 0.2)' : 'rgba(100, 100, 100, 0.2)'}
                                              onMouseOut={(e) => e.target.style.background = propertyData?.disclosureFileObj ? 'rgba(96, 165, 250, 0.1)' : 'rgba(100, 100, 100, 0.1)'}
                                            >
                                              ğŸ“„ View Disclosure p.{flag.disclosure_page}
                                            </button>
                                          )}
                                          {flag.inspection_page && (
                                            <button
                                              onClick={() => viewSourceScreenshot('inspection', flag.inspection_page, flag.flag || 'Inspection Finding', flag.source_quote || flag.detail || '')}
                                              style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '4px',
                                                padding: '4px 10px',
                                                background: propertyData?.inspectionFileObj ? 'rgba(251, 191, 36, 0.1)' : 'rgba(100, 100, 100, 0.1)',
                                                border: `1px solid ${propertyData?.inspectionFileObj ? 'rgba(251, 191, 36, 0.3)' : 'rgba(100, 100, 100, 0.3)'}`,
                                                borderRadius: '6px',
                                                color: propertyData?.inspectionFileObj ? '#fbbf24' : '#94a3b8',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                transition: 'all 0.2s'
                                              }}
                                              onMouseOver={(e) => e.target.style.background = propertyData?.inspectionFileObj ? 'rgba(251, 191, 36, 0.2)' : 'rgba(100, 100, 100, 0.2)'}
                                              onMouseOut={(e) => e.target.style.background = propertyData?.inspectionFileObj ? 'rgba(251, 191, 36, 0.1)' : 'rgba(100, 100, 100, 0.1)'}
                                            >
                                              ğŸ” View Inspection p.{flag.inspection_page}
                                            </button>
                                          )}
                                          {flag.source_page && !flag.disclosure_page && !flag.inspection_page && (
                                            <span style={{
                                              display: 'inline-flex',
                                              alignItems: 'center',
                                              gap: '4px',
                                              padding: '4px 10px',
                                              background: 'rgba(148, 163, 184, 0.1)',
                                              border: '1px solid rgba(148, 163, 184, 0.3)',
                                              borderRadius: '6px',
                                              color: '#94a3b8'
                                            }}>
                                              ğŸ“„ Page {flag.source_page}
                                            </span>
                                          )}
                                        </div>
                                      )}
                                      
                                      <div style={{
                                        fontSize: '13px',
                                        color: '#cbd5e1',
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        padding: '12px',
                                        borderRadius: '8px'
                                      }}>
                                        ğŸ’¡ <strong>Recommendation:</strong> {flag.recommendation}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Risk Adjustment - only show for meaningful adjustments */}
                        {result.transparency_report.risk_adjustment > 0 && (
                          <div style={{
                            background: result.transparency_report.risk_adjustment >= 0.03 
                              ? 'rgba(239, 68, 68, 0.1)' 
                              : 'rgba(234, 179, 8, 0.1)',
                            border: `2px solid ${result.transparency_report.risk_adjustment >= 0.03 
                              ? 'rgba(239, 68, 68, 0.3)' 
                              : 'rgba(234, 179, 8, 0.3)'}`,
                            borderRadius: '16px',
                            padding: '24px',
                            marginTop: '20px'
                          }}>
                            <div style={{ fontSize: '16px', color: '#f1f5f9', fontWeight: '600', marginBottom: '8px' }}>
                              ğŸ’° Transparency-Based Offer Consideration
                            </div>
                            <div style={{ fontSize: '14px', color: '#cbd5e1', lineHeight: '1.6' }}>
                              {result.transparency_report.transparency_score < 40 
                                ? <>Our analysis identified gaps between what the seller disclosed and what the inspection found. To account for potential undisclosed issues, consider an additional </>
                                : <>Some discrepancies were found between the seller's disclosures and the inspection report. You may want to factor in an additional </>
                              }
                              <strong style={{ color: result.transparency_report.risk_adjustment >= 0.03 ? '#ef4444' : '#fbbf24' }}>
                                {(result.transparency_report.risk_adjustment * 100).toFixed(1)}%
                              </strong>{' '}
                              ({result.property_price ? 
                                `$${Math.round(result.property_price * result.transparency_report.risk_adjustment).toLocaleString()}` 
                                : 'TBD'}) reduction as a buffer for unknowns.
                            </div>
                            <div style={{ fontSize: '12px', color: '#64748b', marginTop: '10px', fontStyle: 'italic' }}>
                              ğŸ’¡ This is already factored into your Recommended Offer above. Use this insight during negotiations.
                            </div>
                          </div>
                        )}
                        </>
                        ) : (
                          <div style={{
                            background: 'rgba(239, 68, 68, 0.1)',
                            border: '2px solid rgba(239, 68, 68, 0.3)',
                            borderRadius: '16px',
                            padding: '30px',
                            textAlign: 'center'
                          }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>âš ï¸</div>
                            <div style={{ fontSize: '20px', fontWeight: '700', color: '#ef4444', marginBottom: '12px' }}>
                              Transparency Report Data Not Available
                            </div>
                            <div style={{ fontSize: '14px', color: '#cbd5e1', lineHeight: '1.6' }}>
                              The Seller Transparency Scorer module encountered an issue during generation.
                              Please check the backend logs for errors related to transparency_report.
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* ğŸ“„ What We Extracted - v5.55.8 Credibility Feature */}
                    {result.document_extracts && (result.document_extracts.inspection_extracts?.length > 0 || result.document_extracts.disclosure_extracts?.length > 0) && (
                      <div style={{
                        background: '#1e293b',
                        borderRadius: '12px',
                        padding: '20px 24px',
                        marginBottom: '32px',
                        border: '1px solid #334155',
                        maxWidth: '1200px',
                        margin: '0 auto 32px'
                      }}>
                        <div 
                          onClick={() => setShowDocumentExtracts(!showDocumentExtracts)}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            cursor: 'pointer'
                          }}
                        >
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <span style={{ fontSize: '20px' }}>ğŸ“„</span>
                            <span style={{ color: '#cbd5e1', fontWeight: '600' }}>What We Extracted From Your Documents</span>
                            <span style={{ 
                              background: 'rgba(34, 197, 94, 0.2)', 
                              color: '#22c55e', 
                              padding: '2px 8px', 
                              borderRadius: '10px', 
                              fontSize: '11px',
                              fontWeight: '600'
                            }}>
                              {(result.document_extracts.inspection_extracts?.length || 0) + (result.document_extracts.disclosure_extracts?.length || 0)} items
                            </span>
                          </div>
                          <span style={{ 
                            color: '#64748b', 
                            fontSize: '12px',
                            transform: showDocumentExtracts ? 'rotate(180deg)' : 'rotate(0deg)',
                            transition: 'transform 0.2s'
                          }}>â–¼</span>
                        </div>
                        
                        {showDocumentExtracts && (
                          <div style={{ marginTop: '20px', borderTop: '1px solid #334155', paddingTop: '20px' }}>
                            <p style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '16px' }}>
                              These are the exact findings we pulled from your uploaded documents. Every claim we make traces back to text we found here.
                            </p>
                            
                            {/* Inspection Extracts */}
                            {result.document_extracts.inspection_extracts?.length > 0 && (
                              <div style={{ marginBottom: '20px' }}>
                                <div style={{ color: '#fbbf24', fontSize: '14px', fontWeight: '600', marginBottom: '12px' }}>
                                  ğŸ” From Inspection Report:
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {result.document_extracts.inspection_extracts.slice(0, 8).map((item, idx) => (
                                    <div key={idx} style={{
                                      background: 'rgba(251, 191, 36, 0.05)',
                                      borderLeft: '3px solid #fbbf24',
                                      padding: '10px 14px',
                                      borderRadius: '0 6px 6px 0',
                                      fontSize: '13px'
                                    }}>
                                      <div style={{ color: '#e2e8f0' }}>"{item.finding}"</div>
                                      <div style={{ color: '#64748b', fontSize: '11px', marginTop: '4px' }}>
                                        {item.category?.replace(/_/g, ' ')} 
                                        {item.cost_from_document && <span style={{ color: '#22c55e', marginLeft: '8px' }}>ğŸ“„ Cost in document</span>}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            
                            {/* Disclosure Extracts */}
                            {result.document_extracts.disclosure_extracts?.length > 0 && (
                              <div>
                                <div style={{ color: '#60a5fa', fontSize: '14px', fontWeight: '600', marginBottom: '12px' }}>
                                  ğŸ“ From Seller Disclosure:
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {result.document_extracts.disclosure_extracts.slice(0, 5).map((item, idx) => (
                                    <div key={idx} style={{
                                      background: 'rgba(96, 165, 250, 0.05)',
                                      borderLeft: '3px solid #60a5fa',
                                      padding: '10px 14px',
                                      borderRadius: '0 6px 6px 0',
                                      fontSize: '13px'
                                    }}>
                                      <div style={{ color: '#e2e8f0', fontWeight: '500' }}>{item.flag}</div>
                                      {item.evidence && (
                                        <div style={{ color: '#94a3b8', fontSize: '12px', marginTop: '4px', fontStyle: 'italic' }}>
                                          Evidence: "{item.evidence}"
                                        </div>
                                      )}
                                      {item.source_page && (
                                        <div style={{ color: '#64748b', fontSize: '11px', marginTop: '4px' }}>
                                          Page {item.source_page}
                                        </div>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* Predicted Hidden Issuesâ„¢ */}
                    {(() => {
                      console.log('ğŸ”® Predicted Issues data:', result.predicted_issues);
                      return result.predicted_issues && result.predicted_issues.length > 0;
                    })() && (
                      <div id="predictions" style={{
                        background: '#1e293b',
                        borderRadius: '12px',
                        padding: '32px',
                        marginBottom: '48px',
                        border: '1px solid #334155',
                        maxWidth: '1200px',
                        margin: '0 auto 48px',
                        scrollMarginTop: '80px'
                      }}>
                        
                        <h2 style={{
                          fontSize: '24px',
                          fontWeight: '700',
                          marginBottom: '16px',
                          color: '#cbd5e1'
                        }}>
                          ğŸ”® Predicted Hidden Issuesâ„¢
                        </h2>
                        
                        <p style={{ fontSize: '16px', color: '#94a3b8', lineHeight: '1.6', marginBottom: '24px' }}>
                          AI-powered predictions of potential issues based on property age, condition patterns, and industry knowledge.
                        </p>
                        
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                          {result.predicted_issues.map((prediction, i) => (
                            <div key={i} style={{
                              background: '#0f172a',
                              borderRadius: '16px',
                              padding: '30px',
                              border: `2px solid ${
                                prediction.probability >= 0.85 ? '#ef4444' :
                                prediction.probability >= 0.75 ? '#f59e0b' :
                                prediction.probability >= 0.65 ? '#fbbf24' : '#a855f7'
                              }`
                            }}>
                              <div style={{ display: 'flex', gap: '24px' }}>
                                {/* Probability Circle */}
                                <div>
                                  <div style={{
                                    width: '100px',
                                    height: '100px',
                                    borderRadius: '50%',
                                    background: `conic-gradient(${
                                      prediction.probability >= 0.85 ? '#ef4444' :
                                      prediction.probability >= 0.75 ? '#f59e0b' :
                                      prediction.probability >= 0.65 ? '#fbbf24' : '#a855f7'
                                    } 0% ${prediction.probability * 100}%, #334155 ${prediction.probability * 100}% 100%)`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                  }}>
                                    <div style={{
                                      width: '76px',
                                      height: '76px',
                                      borderRadius: '50%',
                                      background: '#0f172a',
                                      display: 'flex',
                                      flexDirection: 'column',
                                      alignItems: 'center',
                                      justifyContent: 'center'
                                    }}>
                                      <div style={{
                                        fontSize: '24px',
                                        fontWeight: '800',
                                        color: prediction.probability >= 0.85 ? '#ef4444' :
                                               prediction.probability >= 0.75 ? '#f59e0b' :
                                               prediction.probability >= 0.65 ? '#fbbf24' : '#a855f7'
                                      }}>
                                        {Math.round(prediction.probability * 100)}%
                                      </div>
                                      <div style={{ fontSize: '9px', color: '#64748b', marginTop: '2px' }}>
                                        likely
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Prediction Details */}
                                <div style={{ flex: 1 }}>
                                  <div style={{
                                    fontSize: '20px',
                                    fontWeight: '700',
                                    color: '#f1f5f9',
                                    marginBottom: '12px'
                                  }}>
                                    {prediction.predicted_issue}
                                  </div>
                                  
                                  <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                    gap: '12px',
                                    marginBottom: '16px'
                                  }}>
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#64748b', marginBottom: '4px' }}>
                                        Estimated Cost
                                      </div>
                                      <div style={{ fontSize: '16px', fontWeight: '700', color: '#ef4444' }}>
                                        ${prediction.estimated_cost_low?.toLocaleString()} - ${prediction.estimated_cost_high?.toLocaleString()}
                                      </div>
                                    </div>
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#64748b', marginBottom: '4px' }}>
                                        Timeline
                                      </div>
                                      <div style={{ fontSize: '16px', fontWeight: '700', color: '#cbd5e1' }}>
                                        {prediction.likely_timeline}
                                      </div>
                                    </div>
                                    <div>
                                      <div style={{ fontSize: '12px', color: '#64748b', marginBottom: '4px' }}>
                                        Urgency
                                      </div>
                                      <div style={{
                                        fontSize: '14px',
                                        fontWeight: '700',
                                        color: prediction.urgency === 'critical' ? '#ef4444' :
                                               prediction.urgency === 'high' ? '#f59e0b' :
                                               prediction.urgency === 'medium' ? '#fbbf24' : '#10b981',
                                        textTransform: 'uppercase'
                                      }}>
                                        {prediction.urgency}
                                      </div>
                                    </div>
                                  </div>
                                  
                                  {/* Observable Indicators */}
                                  {prediction.observable_indicators && prediction.observable_indicators.length > 0 && (
                                    <div style={{
                                      background: 'rgba(168, 85, 247, 0.1)',
                                      borderRadius: '8px',
                                      padding: '16px',
                                      marginBottom: '16px'
                                    }}>
                                      <div style={{ fontSize: '13px', color: '#a855f7', fontWeight: '600', marginBottom: '8px' }}>
                                        ğŸ“Š Why we predict this:
                                      </div>
                                      <div style={{ fontSize: '13px', color: '#cbd5e1', lineHeight: '1.6' }}>
                                        {prediction.observable_indicators.join(' â€¢ ')}
                                      </div>
                                      {/* Removed false "similar cases in our database" claim - no database exists yet */}
                                    </div>
                                  )}
                                  
                                  {/* Recommended Actions */}
                                  {prediction.recommended_actions && prediction.recommended_actions.length > 0 && (
                                    <div style={{
                                      background: 'rgba(59, 130, 246, 0.1)',
                                      borderRadius: '8px',
                                      padding: '16px'
                                    }}>
                                      <div style={{ fontSize: '13px', color: '#3b82f6', fontWeight: '600', marginBottom: '8px' }}>
                                        ğŸ’¡ Recommended Actions:
                                      </div>
                                      <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '13px', color: '#cbd5e1', lineHeight: '1.8' }}>
                                        {prediction.recommended_actions.map((action, j) => (
                                          <li key={j}>{action}</li>
                                        ))}
                                      </ul>
                                      {prediction.specialist_needed && (
                                        <div style={{ fontSize: '12px', color: '#94a3b8', marginTop: '12px' }}>
                                          ğŸ‘¤ Specialist needed: <strong>{prediction.specialist_needed}</strong>
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Decision Path - Final Section */}
                    <div id="decision-path" style={{
                      background: '#1e293b',
                      borderRadius: '12px',
                      padding: '30px',
                      marginBottom: '20px',
                      border: '2px solid #334155',
                      maxWidth: '1200px',
                      margin: '0 auto 48px',
                      scrollMarginTop: '80px'
                    }}>
                      
                      <h2 style={{
                        fontSize: '28px',
                        fontWeight: '700',
                        marginBottom: '20px',
                        background: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',
                        WebkitBackgroundClip: 'text',
                        WebkitTextFillColor: 'transparent',
                        backgroundClip: 'text'
                      }}>
                        ğŸ’¡ Your Decision Path
                      </h2>
                      
                      {/* Offer Strategy */}
                      {offer_strategy && (
                        <div style={{
                          background: '#1e293b',
                          padding: '24px',
                          borderRadius: '12px',
                          marginBottom: '20px',
                          border: '2px solid #334155'
                        }}>
                          <h3 style={{
                            fontSize: '24px',
                            fontWeight: '700',
                            marginBottom: '20px',
                            color: '#0ea5e9'
                          }}>
                            ğŸ’° Recommended Offer Strategy
                          </h3>
                          
                          {/* Main Offer Display */}
                          <div style={{
                            background: 'linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%)',
                            padding: '24px',
                            borderRadius: '16px',
                            textAlign: 'center',
                            marginBottom: '20px',
                            boxShadow: '0 10px 40px rgba(14, 165, 233, 0.3)'
                          }}>
                            <div style={{
                              fontSize: '14px',
                              textTransform: 'uppercase',
                              letterSpacing: '2px',
                              opacity: '0.9',
                              marginBottom: '12px'
                            }}>
                              Recommended Offer
                            </div>
                            <div style={{
                              fontSize: '56px',
                              fontWeight: '900',
                              marginBottom: '12px'
                            }}>
                              ${typeof offer_strategy === 'object' && offer_strategy.recommended_offer 
                                ? Math.round(offer_strategy.recommended_offer).toLocaleString()
                                : 'N/A'}
                            </div>
                            <div style={{
                              fontSize: '16px',
                              opacity: '0.9'
                            }}>
                              {typeof offer_strategy === 'object' && offer_strategy.discount_percentage 
                                ? `${Math.round(offer_strategy.discount_percentage)}% below asking price`
                                : ''}
                            </div>
                            
                            {/* CREDIBILITY INDICATOR - v5.49.0, v5.54.52: Fixed contrast on cyan */}
                            {typeof offer_strategy === 'object' && offer_strategy.confidence_level && (
                              <div style={{
                                marginTop: '16px',
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '8px',
                                background: 'rgba(15, 23, 42, 0.9)',
                                padding: '8px 16px',
                                borderRadius: '20px',
                                border: `2px solid ${offer_strategy.confidence_level >= 0.8 ? '#22c55e' :
                                                     offer_strategy.confidence_level >= 0.6 ? '#eab308' : '#ef4444'}`,
                                boxShadow: '0 2px 8px rgba(0,0,0,0.3)'
                              }}>
                                <span style={{ fontSize: '16px' }}>
                                  {offer_strategy.confidence_level >= 0.8 ? 'ğŸŸ¢' :
                                   offer_strategy.confidence_level >= 0.6 ? 'ğŸŸ¡' : 'ğŸ”´'}
                                </span>
                                <span style={{ 
                                  fontSize: '13px', 
                                  fontWeight: '700',
                                  color: offer_strategy.confidence_level >= 0.8 ? '#4ade80' :
                                         offer_strategy.confidence_level >= 0.6 ? '#fbbf24' : '#f87171'
                                }}>
                                  {offer_strategy.confidence_level >= 0.8 ? 'HIGH CONFIDENCE' :
                                   offer_strategy.confidence_level >= 0.6 ? 'MODERATE CONFIDENCE' : 'LOW CONFIDENCE'}
                                  {' '}({Math.round(offer_strategy.confidence_level * 100)}%)
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Breakdown */}
                          {typeof offer_strategy === 'object' && offer_strategy.discount_breakdown && (
                            <div style={{
                              background: '#0f172a',
                              padding: '30px',
                              borderRadius: '12px',
                              border: '1px solid #1e293b'
                            }}>
                              <div style={{
                                fontSize: '18px',
                                fontWeight: '700',
                                marginBottom: '24px',
                                color: '#f1f5f9'
                              }}>
                                ğŸ“Š How We Calculated Your Recommended Offer
                              </div>
                              
                              {/* Asking Price */}
                              <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                  <span style={{ color: '#cbd5e1', fontSize: '15px', fontWeight: '600' }}>Asking Price</span>
                                  <span style={{ color: '#f1f5f9', fontSize: '17px', fontWeight: '700' }}>
                                    ${result.property_price?.toLocaleString() || 'N/A'}
                                  </span>
                                </div>
                              </div>
                              
                              <div style={{ height: '2px', background: '#1e293b', margin: '20px 0' }}></div>
                              
                              {/* REPAIR COSTS - Detailed */}
                              <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                  <div style={{ flex: 1 }}>
                                    <div style={{ 
                                      display: 'flex', 
                                      alignItems: 'center', 
                                      gap: '8px',
                                      marginBottom: '4px'
                                    }}>
                                      <div style={{ color: '#ef4444', fontSize: '16px', fontWeight: '700' }}>
                                        Estimated Repair Costs
                                      </div>
                                    </div>
                                    <div style={{ color: '#94a3b8', fontSize: '13px', marginTop: '4px' }}>
                                      Based on inspection findings and {(() => {
                                        // Check if any category has document-sourced costs
                                        const hasDocCosts = result?.category_scores?.some(cat => cat.costs_are_estimates === false);
                                        return hasDocCosts 
                                          ? <span><span style={{ color: '#22c55e' }}>ğŸ“„ document costs</span> + industry estimates</span>
                                          : 'industry-standard estimates';
                                      })()}
                                    </div>
                                  </div>
                                  <span style={{ color: '#ef4444', fontSize: '18px', fontWeight: '700' }}>
                                    -${Math.round(offer_strategy.discount_breakdown.repair_costs || 0).toLocaleString()}
                                  </span>
                                </div>
                                
                                <div style={{
                                  marginTop: '12px',
                                  paddingLeft: '16px',
                                  borderLeft: '2px solid #ef4444'
                                }}>
                                  <div 
                                    onClick={() => setShowRepairExplanation(!showRepairExplanation)}
                                    style={{ 
                                      color: '#cbd5e1', 
                                      fontSize: '13px', 
                                      lineHeight: '1.6', 
                                      marginBottom: '12px',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '8px',
                                      transition: 'color 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.color = '#fbbf24'}
                                    onMouseLeave={(e) => e.currentTarget.style.color = '#cbd5e1'}
                                  >
                                    <span style={{ 
                                      fontSize: '10px',
                                      transition: 'transform 0.2s',
                                      display: 'inline-block',
                                      transform: showRepairExplanation ? 'rotate(90deg)' : 'rotate(0deg)'
                                    }}>â–¶</span>
                                    <strong>How we estimate repairs</strong>
                                  </div>
                                  
                                  {showRepairExplanation && (
                                    <div style={{ color: '#94a3b8', fontSize: '12px', lineHeight: '1.6', marginLeft: '18px' }}>
                                      Our proprietary OfferScoreâ„¢ algorithm (Patent Pending) uses industry-standard cost estimates with 
                                      category-specific, severity-stratified repair ranges. This methodology 
                                      analyzes each inspection finding by type (Foundation, Roof, Electrical, etc.) 
                                      and severity level (Critical, Major, Moderate, Minor) to provide accurate 
                                      cost ranges based on typical contractor pricing. The system 
                                      accounts for the scope of work identified in the inspection without requiring 
                                      regional data collection.
                                    </div>
                                  )}
                                </div>
                                
                                {/* Detailed breakdown - hidden for IP protection */}
                                {false && (
                                  <div style={{
                                    background: 'rgba(15, 23, 42, 0.6)',
                                    padding: '16px',
                                    paddingLeft: '20px',
                                    borderRadius: '8px',
                                    marginBottom: '16px',
                                    border: '1px solid rgba(239, 68, 68, 0.2)',
                                    borderLeft: '3px solid #ef4444'
                                  }}>
                                    <div style={{ color: '#ef4444', fontSize: '13px', fontWeight: '600', marginBottom: '12px' }}>
                                      ğŸ“‹ Repair Cost Breakdown by System
                                    </div>
                                    
                                    <div style={{ color: '#94a3b8', fontSize: '12px', lineHeight: '1.7', marginBottom: '12px' }}>
                                      Costs estimated based on inspection findings, contractor quotes, and typical repair pricing:
                                    </div>
                                    
                                    {result && result.category_scores && result.category_scores.filter(cat => cat.estimated_cost_high > 0).length > 0 ? (
                                      <>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                          {result.category_scores
                                            .filter(cat => cat.estimated_cost_high > 0)
                                            .map((cat, idx) => (
                                              <div key={idx} style={{ 
                                                display: 'flex', 
                                                justifyContent: 'space-between',
                                                padding: '10px 12px',
                                                background: 'rgba(30, 41, 59, 0.4)',
                                                borderRadius: '6px',
                                                border: '1px solid rgba(51, 65, 85, 0.5)'
                                              }}>
                                                <div>
                                                  <div style={{ color: '#cbd5e1', fontSize: '13px', fontWeight: '600', marginBottom: '4px' }}>
                                                    {cat.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                                  </div>
                                                  <div style={{ color: '#94a3b8', fontSize: '11px' }}>
                                                    Range: ${Math.round(cat.estimated_cost_low).toLocaleString()} - ${Math.round(cat.estimated_cost_high).toLocaleString()}
                                                  </div>
                                                </div>
                                                <div style={{ color: '#ef4444', fontSize: '14px', fontWeight: '700', textAlign: 'right' }}>
                                                  ${Math.round((cat.estimated_cost_low + cat.estimated_cost_high) / 2).toLocaleString()}
                                                  <div style={{ color: '#64748b', fontSize: '10px', fontWeight: '400' }}>
                                                    (avg)
                                                  </div>
                                                </div>
                                              </div>
                                            ))}
                                        </div>
                                        
                                        <div style={{ 
                                          marginTop: '12px',
                                          paddingTop: '12px',
                                          borderTop: '1px solid rgba(51, 65, 85, 0.5)',
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center'
                                        }}>
                                          <span style={{ color: '#cbd5e1', fontSize: '13px', fontWeight: '600' }}>
                                            Total Estimated Repairs:
                                          </span>
                                          <span style={{ color: '#ef4444', fontSize: '16px', fontWeight: '700' }}>
                                            ${Math.round(offer_strategy.discount_breakdown.repair_costs || 0).toLocaleString()}
                                          </span>
                                        </div>
                                        
                                        <div style={{ color: '#64748b', fontSize: '11px', lineHeight: '1.6', fontStyle: 'italic', marginTop: '12px' }}>
                                          <strong>Note:</strong> These are estimated costs based on inspection findings. 
                                          Actual costs may vary. We recommend getting contractor quotes before finalizing your offer.
                                        </div>
                                      </>
                                    ) : (
                                      <div style={{ color: '#94a3b8', fontSize: '13px', fontStyle: 'italic', padding: '12px' }}>
                                        Detailed breakdown by category is not available. Total repair cost: ${Math.round(offer_strategy.discount_breakdown.repair_costs || 0).toLocaleString()}
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {/* Category breakdown summary - always show */}
                                {result && result.category_scores && result.category_scores.filter(cat => cat.estimated_cost_high > 0).length > 0 && (
                                  <div style={{ 
                                    marginTop: '12px', 
                                    paddingLeft: '16px',
                                    borderLeft: '2px solid #ef4444'
                                  }}>
                                    {result.category_scores
                                      .filter(cat => cat.estimated_cost_high > 0)
                                      .slice(0, 5)
                                      .map((cat, idx) => (
                                        <div key={idx} style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between',
                                          padding: '8px 0',
                                          borderBottom: idx < 4 ? '1px solid #1e293b' : 'none'
                                        }}>
                                          <span style={{ color: '#94a3b8', fontSize: '13px' }}>
                                            {cat.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                          </span>
                                          <span style={{ color: '#cbd5e1', fontSize: '13px', fontWeight: '600' }}>
                                            ${Math.round((cat.estimated_cost_low + cat.estimated_cost_high) / 2).toLocaleString()}
                                          </span>
                                        </div>
                                      ))}
                                  </div>
                                )}
                              </div>
                              
                              {/* RISK PREMIUM - Detailed with explanation */}
                              <div style={{ marginBottom: '30px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                  <div>
                                    <div style={{ color: '#f59e0b', fontSize: '16px', fontWeight: '700' }}>
                                      Risk Premium
                                    </div>
                                    <div style={{ color: '#94a3b8', fontSize: '13px', marginTop: '4px' }}>
                                      {result && result.risk_tier === 'CRITICAL' ? 'Critical issues require substantial risk compensation' :
                                       result && result.risk_tier === 'HIGH' ? 'Significant issues warrant moderate risk premium' :
                                       result && result.risk_tier === 'MODERATE' ? 'Standard risk premium for moderate concerns' :
                                       'Compensation for taking on property condition risks'}
                                    </div>
                                  </div>
                                  <span style={{ color: '#f59e0b', fontSize: '18px', fontWeight: '700' }}>
                                    -${Math.round(offer_strategy.discount_breakdown.risk_premium || 0).toLocaleString()}
                                  </span>
                                </div>
                                
                                {/* Risk premium explanation */}
                                <div style={{ 
                                  marginTop: '12px', 
                                  paddingLeft: '16px',
                                  borderLeft: '2px solid #f59e0b'
                                }}>
                                  <div 
                                    onClick={() => setShowRiskPremiumExplanation(!showRiskPremiumExplanation)}
                                    style={{ 
                                      color: '#cbd5e1', 
                                      fontSize: '13px', 
                                      lineHeight: '1.6', 
                                      marginBottom: '12px',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '8px',
                                      transition: 'color 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.color = '#fbbf24'}
                                    onMouseLeave={(e) => e.currentTarget.style.color = '#cbd5e1'}
                                  >
                                    <span style={{ 
                                      fontSize: '10px',
                                      transition: 'transform 0.2s',
                                      display: 'inline-block',
                                      transform: showRiskPremiumExplanation ? 'rotate(90deg)' : 'rotate(0deg)'
                                    }}>â–¶</span>
                                    <strong>Why this premium?</strong>
                                  </div>
                                  
                                  {showRiskPremiumExplanation && (
                                    <div style={{ color: '#94a3b8', fontSize: '12px', lineHeight: '1.6', marginLeft: '18px' }}>
                                      Our proprietary OfferScoreâ„¢ algorithm (Patent Pending) analyzes property 
                                      condition, market factors, and seller transparency to calculate an objective 
                                      risk-based discount. Properties with {result.risk_tier} risk profiles warrant 
                                      additional negotiation leverage beyond repair costs to account for resale 
                                      difficulty, financing challenges, and potential unknown issues.
                                    </div>
                                  )}
                                  
                                  {/* Calculation methodology (hidden for IP protection) */}
                                  {false && (
                                    <div style={{
                                      background: 'rgba(15, 23, 42, 0.6)',
                                      padding: '16px',
                                      paddingLeft: '20px',
                                      borderRadius: '8px',
                                      marginBottom: '16px',
                                      border: '1px solid rgba(245, 158, 11, 0.2)',
                                      borderLeft: '3px solid #f59e0b'
                                    }}>
                                      <div style={{ color: '#fbbf24', fontSize: '13px', fontWeight: '600', marginBottom: '12px' }}>
                                        ğŸ“Š Risk Premium Calculation (Objective Formula)
                                      </div>
                                      
                                      <div style={{ color: '#94a3b8', fontSize: '12px', lineHeight: '1.7', marginBottom: '12px' }}>
                                        The risk premium is calculated based on <strong style={{ color: '#cbd5e1' }}>property condition risk tier</strong>, 
                                        not subjective opinion. This is an objective percentage of asking price:
                                      </div>
                                      
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '12px' }}>
                                        <div style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between',
                                          padding: '8px 12px',
                                          background: result.risk_tier === 'CRITICAL' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(30, 41, 59, 0.4)',
                                          borderRadius: '4px',
                                          border: result.risk_tier === 'CRITICAL' ? '1px solid rgba(239, 68, 68, 0.3)' : '1px solid rgba(51, 65, 85, 0.5)'
                                        }}>
                                          <span style={{ color: '#cbd5e1', fontSize: '12px' }}>
                                            <strong>CRITICAL</strong> Risk Tier
                                          </span>
                                          <span style={{ color: '#fbbf24', fontSize: '12px', fontWeight: '600' }}>
                                            10% of asking price
                                          </span>
                                        </div>
                                        
                                        <div style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between',
                                          padding: '8px 12px',
                                          background: result.risk_tier === 'HIGH' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(30, 41, 59, 0.4)',
                                          borderRadius: '4px',
                                          border: result.risk_tier === 'HIGH' ? '1px solid rgba(245, 158, 11, 0.3)' : '1px solid rgba(51, 65, 85, 0.5)'
                                        }}>
                                          <span style={{ color: '#cbd5e1', fontSize: '12px' }}>
                                            <strong>HIGH</strong> Risk Tier
                                          </span>
                                          <span style={{ color: '#fbbf24', fontSize: '12px', fontWeight: '600' }}>
                                            5% of asking price
                                          </span>
                                        </div>
                                        
                                        <div style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between',
                                          padding: '8px 12px',
                                          background: result.risk_tier === 'MODERATE' ? 'rgba(234, 179, 8, 0.1)' : 'rgba(30, 41, 59, 0.4)',
                                          borderRadius: '4px',
                                          border: result.risk_tier === 'MODERATE' ? '1px solid rgba(234, 179, 8, 0.3)' : '1px solid rgba(51, 65, 85, 0.5)'
                                        }}>
                                          <span style={{ color: '#cbd5e1', fontSize: '12px' }}>
                                            <strong>MODERATE</strong> Risk Tier
                                          </span>
                                          <span style={{ color: '#fbbf24', fontSize: '12px', fontWeight: '600' }}>
                                            2% of asking price
                                          </span>
                                        </div>
                                        
                                        <div style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between',
                                          padding: '8px 12px',
                                          background: result.risk_tier === 'LOW' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(30, 41, 59, 0.4)',
                                          borderRadius: '4px',
                                          border: result.risk_tier === 'LOW' ? '1px solid rgba(34, 197, 94, 0.3)' : '1px solid rgba(51, 65, 85, 0.5)'
                                        }}>
                                          <span style={{ color: '#cbd5e1', fontSize: '12px' }}>
                                            <strong>LOW</strong> Risk Tier
                                          </span>
                                          <span style={{ color: '#10b981', fontSize: '12px', fontWeight: '600' }}>
                                            0% (No premium)
                                          </span>
                                        </div>
                                      </div>
                                      
                                      <div style={{ 
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        padding: '12px',
                                        borderRadius: '6px',
                                        border: '1px solid rgba(59, 130, 246, 0.2)',
                                        marginBottom: '12px'
                                      }}>
                                        <div style={{ color: '#60a5fa', fontSize: '12px', fontWeight: '600', marginBottom: '6px' }}>
                                          Your Property: {result.risk_tier || 'Unknown'} Risk
                                        </div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px', lineHeight: '1.6' }}>
                                          {(() => {
                                            const premium = offer_strategy.discount_breakdown?.risk_premium || 0;
                                            const price = result.property_price || 1;
                                            const actualPercentage = ((premium / price) * 100).toFixed(1);
                                            return (
                                              <>
                                                Risk Premium = ${price.toLocaleString()} Ã— {actualPercentage}% = <strong style={{ color: '#fbbf24' }}>${premium.toLocaleString()}</strong>
                                              </>
                                            );
                                          })()}
                                        </div>
                                      </div>
                                      
                                      <div style={{ color: '#64748b', fontSize: '11px', lineHeight: '1.6', fontStyle: 'italic' }}>
                                        <strong>Note:</strong> Risk tier is determined by analyzing inspection findings, 
                                        disclosure transparency, and system condition across 12 categories. This is an objective, 
                                        data-driven calculationâ€”not a subjective opinion.
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Calculate and show premium components */}
                                  {result && result.category_scores && (() => {
                                    const criticalCount = result.category_scores.filter(c => c.score >= 75).length;
                                    const majorCount = result.category_scores.filter(c => c.score >= 50 && c.score < 75).length;
                                    const insurabilityIssues = result.category_scores.filter(c => c.affects_insurability && c.score >= 50).length;
                                    const resaleIssues = result.category_scores.filter(c => c.affects_resale && c.score >= 50).length;
                                    
                                    return (
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                        {criticalCount > 0 && (
                                          <div style={{ color: '#94a3b8', fontSize: '12px' }}>
                                            â€¢ <span style={{ color: '#cbd5e1', fontWeight: '600' }}>{criticalCount} critical system{criticalCount > 1 ? 's' : ''}</span> requiring immediate attention
                                          </div>
                                        )}
                                        {majorCount > 0 && (
                                          <div style={{ color: '#94a3b8', fontSize: '12px' }}>
                                            â€¢ <span style={{ color: '#cbd5e1', fontWeight: '600' }}>{majorCount} major system{majorCount > 1 ? 's' : ''}</span> need professional repairs
                                          </div>
                                        )}
                                        {insurabilityIssues > 0 && (
                                          <div style={{ color: '#94a3b8', fontSize: '12px' }}>
                                            â€¢ <span style={{ color: '#cbd5e1', fontWeight: '600' }}>Insurance risk:</span> Issues may affect insurability or increase premiums
                                          </div>
                                        )}
                                        {resaleIssues > 0 && (
                                          <div style={{ color: '#94a3b8', fontSize: '12px' }}>
                                            â€¢ <span style={{ color: '#cbd5e1', fontWeight: '600' }}>Resale impact:</span> Issues will affect future marketability and time-to-sell
                                          </div>
                                        )}
                                        {(criticalCount >= 2 || (criticalCount >= 1 && majorCount >= 2)) && (
                                          <div style={{ color: '#94a3b8', fontSize: '12px' }}>
                                            â€¢ <span style={{ color: '#cbd5e1', fontWeight: '600' }}>Elevated uncertainty:</span> Multiple significant issues suggest possible hidden problems
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })()}
                                </div>
                              </div>
                              
                              {/* TRANSPARENCY DISCOUNT - Detailed with what was hidden */}
                              {offer_strategy.discount_breakdown.transparency_issues > 0 && (
                                <div style={{ marginBottom: '30px' }}>
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                    <div style={{ flex: 1 }}>
                                      <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        marginBottom: '4px'
                                      }}>
                                        <div style={{ color: '#fbbf24', fontSize: '16px', fontWeight: '700' }}>
                                          Transparency Discount
                                        </div>
                                      </div>
                                      <div style={{ color: '#94a3b8', fontSize: '13px', marginTop: '4px' }}>
                                        Seller failed to disclose known defects (proprietary analysis)
                                      </div>
                                    </div>
                                    <span style={{ color: '#fbbf24', fontSize: '18px', fontWeight: '700' }}>
                                      -${Math.round(offer_strategy.discount_breakdown.transparency_issues || 0).toLocaleString()}
                                    </span>
                                  </div>
                                  
                                  <div style={{
                                    marginTop: '12px',
                                    paddingLeft: '16px',
                                    borderLeft: '2px solid #fbbf24'
                                  }}>
                                    <div 
                                      onClick={() => setShowTransparencyExplanation(!showTransparencyExplanation)}
                                      style={{ 
                                        color: '#cbd5e1', 
                                        fontSize: '13px', 
                                        lineHeight: '1.6', 
                                        marginBottom: '12px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        transition: 'color 0.2s'
                                      }}
                                      onMouseEnter={(e) => e.currentTarget.style.color = '#fbbf24'}
                                      onMouseLeave={(e) => e.currentTarget.style.color = '#cbd5e1'}
                                    >
                                      <span style={{ 
                                        fontSize: '10px',
                                        transition: 'transform 0.2s',
                                        display: 'inline-block',
                                        transform: showTransparencyExplanation ? 'rotate(90deg)' : 'rotate(0deg)'
                                      }}>â–¶</span>
                                      <strong>Why this discount?</strong>
                                    </div>
                                    
                                    {showTransparencyExplanation && (
                                      <div style={{ color: '#94a3b8', fontSize: '12px', lineHeight: '1.6', marginLeft: '18px' }}>
                                        Our proprietary OfferScoreâ„¢ algorithm (Patent Pending) automatically compares 
                                        what the seller disclosed against what the inspector actually found. When 
                                        sellers fail to disclose known defects, it creates legal risk, trust issues, 
                                        and suggests potential hidden problems beyond what was found. This discount 
                                        compensates for that increased uncertainty and provides negotiation leverage 
                                        based on documented non-disclosure.
                                      </div>
                                    )}
                                  </div>
                                  
                                  {/* Expandable transparency calculation (hidden for IP protection) */}
                                  {false && (
                                    <div style={{
                                      background: 'rgba(15, 23, 42, 0.6)',
                                      padding: '16px',
                                      paddingLeft: '20px',
                                      borderRadius: '8px',
                                      marginBottom: '16px',
                                      border: '1px solid rgba(251, 191, 36, 0.2)',
                                      borderLeft: '3px solid #fbbf24'
                                    }}>
                                      <div style={{ color: '#fbbf24', fontSize: '13px', fontWeight: '600', marginBottom: '12px' }}>
                                        ğŸ“Š Transparency Discount Calculation (Objective Formula)
                                      </div>
                                      
                                      <div style={{ color: '#94a3b8', fontSize: '12px', lineHeight: '1.7', marginBottom: '12px' }}>
                                        This discount compensates for <strong style={{ color: '#cbd5e1' }}>seller non-disclosure</strong> of defects. 
                                        It's calculated based on transparency score:
                                      </div>
                                      
                                      <div style={{
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        padding: '12px',
                                        borderRadius: '6px',
                                        border: '1px solid rgba(59, 130, 246, 0.2)',
                                        marginBottom: '12px'
                                      }}>
                                        <div style={{ color: '#60a5fa', fontSize: '12px', fontWeight: '600', marginBottom: '8px' }}>
                                          Formula:
                                        </div>
                                        <div style={{ color: '#94a3b8', fontSize: '11px', lineHeight: '1.6' }}>
                                          {(() => {
                                            const transparencyScore = result?.cross_reference?.transparency_score || 100;
                                            const discount = offer_strategy.discount_breakdown.transparency_issues || 0;
                                            const price = result?.property_price || 1;
                                            const percentage = ((discount / price) * 100).toFixed(1);
                                            return (
                                              <>
                                                â€¢ Transparency Score: <strong style={{ color: '#fbbf24' }}>{transparencyScore}%</strong>
                                                {transparencyScore < 50 && (
                                                  <>
                                                    <br />â€¢ Low transparency (under 50%) triggers <strong style={{ color: '#fbbf24' }}>3%</strong> discount
                                                    <br />â€¢ ${price.toLocaleString()} Ã— {percentage}% = <strong style={{ color: '#fbbf24' }}>${discount.toLocaleString()}</strong>
                                                  </>
                                                )}
                                              </>
                                            );
                                          })()}
                                        </div>
                                      </div>
                                      
                                      <div style={{ color: '#94a3b8', fontSize: '12px', marginBottom: '8px', fontWeight: '600' }}>
                                        Why this matters:
                                      </div>
                                      <div style={{ color: '#64748b', fontSize: '11px', lineHeight: '1.6', marginBottom: '12px' }}>
                                        â€¢ Seller's failure to disclose increases your risk<br />
                                        â€¢ You may discover additional hidden issues after purchase<br />
                                        â€¢ Non-disclosure suggests potential bad faith dealing<br />
                                        â€¢ Discount compensates for increased uncertainty and risk
                                      </div>
                                      
                                      <div style={{ color: '#64748b', fontSize: '11px', lineHeight: '1.6', fontStyle: 'italic' }}>
                                        <strong>Note:</strong> Our proprietary OfferScoreâ„¢ algorithm (Patent Pending) automatically compares 
                                        what the seller disclosed versus what the inspector found to calculate this discount.
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              <div style={{ height: '2px', background: '#1e293b', margin: '20px 0' }}></div>
                              
                              {/* Final Offer */}
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px', background: 'rgba(14, 165, 233, 0.1)', borderRadius: '8px' }}>
                                <div>
                                  <div style={{ color: '#0ea5e9', fontSize: '17px', fontWeight: '700' }}>
                                    Recommended Offer
                                  </div>
                                  <div style={{ color: '#94a3b8', fontSize: '13px', marginTop: '4px' }}>
                                    {Math.round(offer_strategy.discount_percentage || 0)}% below asking price
                                  </div>
                                </div>
                                <span style={{ color: '#0ea5e9', fontSize: '22px', fontWeight: '900' }}>
                                  ${typeof offer_strategy.recommended_offer === 'number' 
                                    ? Math.round(offer_strategy.recommended_offer).toLocaleString()
                                    : 'N/A'}
                                </span>
                              </div>
                              
                              {/* CREDIBILITY TOOLTIP - v5.54.30 */}
                              <div style={{ 
                                marginTop: '16px',
                                display: 'flex',
                                justifyContent: 'flex-end'
                              }}>
                                <div style={{ position: 'relative', display: 'inline-block' }}>
                                  <button
                                    onClick={() => setShowCredibilityTooltip(!showCredibilityTooltip)}
                                    style={{
                                      background: 'transparent',
                                      border: 'none',
                                      color: '#64748b',
                                      fontSize: '12px',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '4px',
                                      padding: '4px 8px',
                                      borderRadius: '4px',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.target.style.color = '#94a3b8'}
                                    onMouseLeave={(e) => e.target.style.color = '#64748b'}
                                  >
                                    <span>â„¹ï¸</span>
                                    <span>Analysis Credibility</span>
                                    <span style={{ fontSize: '10px' }}>{showCredibilityTooltip ? 'â–²' : 'â–¼'}</span>
                                  </button>
                                  
                                  {showCredibilityTooltip && (
                                    <div style={{
                                      position: 'absolute',
                                      bottom: '100%',
                                      right: '0',
                                      marginBottom: '8px',
                                      width: '320px',
                                      padding: '16px',
                                      background: '#1e293b',
                                      borderRadius: '12px',
                                      border: '1px solid #334155',
                                      boxShadow: '0 10px 40px rgba(0,0,0,0.5)',
                                      zIndex: 1000
                                    }}>
                                      {/* Confidence indicator */}
                                      {offer_strategy.confidence_level && (
                                        <div style={{ marginBottom: '12px' }}>
                                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                            <span style={{ color: '#f1f5f9', fontSize: '13px', fontWeight: '600' }}>Confidence</span>
                                            <span style={{ 
                                              color: offer_strategy.confidence_level >= 0.8 ? '#22c55e' :
                                                     offer_strategy.confidence_level >= 0.6 ? '#eab308' : '#ef4444',
                                              fontSize: '13px',
                                              fontWeight: '700'
                                            }}>
                                              {Math.round(offer_strategy.confidence_level * 100)}%
                                            </span>
                                          </div>
                                          <div style={{ 
                                            width: '100%', 
                                            height: '4px', 
                                            background: '#0f172a',
                                            borderRadius: '2px',
                                            overflow: 'hidden'
                                          }}>
                                            <div style={{ 
                                              width: `${Math.round(offer_strategy.confidence_level * 100)}%`,
                                              height: '100%',
                                              background: offer_strategy.confidence_level >= 0.8 ? '#22c55e' :
                                                         offer_strategy.confidence_level >= 0.6 ? '#eab308' : '#ef4444',
                                              borderRadius: '2px'
                                            }}></div>
                                          </div>
                                        </div>
                                      )}
                                      
                                      {/* What we verified */}
                                      <div style={{ marginBottom: '12px' }}>
                                        <div style={{ color: '#22c55e', fontSize: '11px', fontWeight: '600', marginBottom: '4px' }}>âœ“ Verified</div>
                                        <ul style={{ margin: '0', paddingLeft: '16px', color: '#94a3b8', fontSize: '11px', lineHeight: '1.5' }}>
                                          <li>Cost estimates from HomeAdvisor/Angi 2024</li>
                                          <li>Cross-referenced disclosures vs inspection</li>
                                        </ul>
                                      </div>
                                      
                                      {/* Limitations */}
                                      <div style={{ marginBottom: '12px' }}>
                                        <div style={{ color: '#fbbf24', fontSize: '11px', fontWeight: '600', marginBottom: '4px' }}>âš ï¸ Limitations</div>
                                        <ul style={{ margin: '0', paddingLeft: '16px', color: '#94a3b8', fontSize: '11px', lineHeight: '1.5' }}>
                                          <li>Cannot verify inspector thoroughness</li>
                                          <li>Hidden issues may exist</li>
                                          <li>Local pricing may vary</li>
                                        </ul>
                                      </div>
                                      
                                      {/* Tip */}
                                      <div style={{ 
                                        padding: '8px',
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        borderRadius: '6px',
                                        color: '#60a5fa',
                                        fontSize: '10px'
                                      }}>
                                        ğŸ’¡ Get contractor quotes for major repairs before finalizing your offer.
                                      </div>
                                      
                                      {/* Arrow */}
                                      <div style={{
                                        position: 'absolute',
                                        bottom: '-6px',
                                        right: '20px',
                                        width: '12px',
                                        height: '12px',
                                        background: '#1e293b',
                                        border: '1px solid #334155',
                                        borderTop: 'none',
                                        borderLeft: 'none',
                                        transform: 'rotate(45deg)'
                                      }}></div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                      
                      {/* Strategic Options - Property-Specific Action Plans */}
                      {result?.strategic_options && result.strategic_options.length > 0 ? (
                        <div style={{ marginTop: '40px' }}>
                          <h2 style={{ 
                            fontSize: '32px', 
                            fontWeight: '800', 
                            marginBottom: '16px',
                            textAlign: 'center',
                            color: '#f1f5f9'
                          }}>
                            ğŸ“Š Your Strategic Options
                          </h2>
                          <p style={{ 
                            fontSize: '16px', 
                            color: '#94a3b8', 
                            textAlign: 'center',
                            marginBottom: '40px'
                          }}>
                            Based on OfferScore {Math.round(100 - (risk_score?.overall_risk_score || 0))}, here are your best moves
                          </p>
                          
                          <div style={{ 
                            display: 'grid', 
                            gap: '30px'
                          }}>
                            {result.strategic_options.map((option, idx) => {
                              // Determine accent color based on risk level
                              const accentColor = option.risk_level === 'low' ? '#10b981' :
                                                option.risk_level === 'medium' ? '#fbbf24' : '#f59e0b';
                              
                              return (
                                <div key={idx} style={{
                                  background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                                  padding: '24px',
                                  borderRadius: '12px',
                                  border: '2px solid #334155',
                                  position: 'relative',
                                  overflow: 'hidden'
                                }}>
                                  {/* Top accent bar */}
                                  <div style={{
                                    position: 'absolute',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    height: '4px',
                                    background: `linear-gradient(90deg, ${accentColor} 0%, ${accentColor}dd 100%)`
                                  }}></div>
                                  
                                  {/* Header */}
                                  <div style={{ marginBottom: '24px' }}>
                                    <h3 style={{
                                      fontSize: '26px',
                                      fontWeight: '700',
                                      color: '#ffffff',
                                      marginBottom: '12px'
                                    }}>
                                      {option.icon} {option.title}
                                    </h3>
                                    
                                    {/* Success indicators */}
                                    <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', fontSize: '14px' }}>
                                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#94a3b8' }}>
                                        <span style={{ fontSize: '16px' }}>
                                          {option.probability_success === 'high' ? 'â­â­â­â­â­' :
                                           option.probability_success === 'medium' ? 'â­â­â­' : 'â­'}
                                        </span>
                                        <span>Success: {option.probability_success.toUpperCase()}</span>
                                      </div>
                                      
                                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#94a3b8' }}>
                                        <span style={{ fontSize: '16px' }}>ğŸ›¡ï¸</span>
                                        <span>Risk: {option.risk_level.toUpperCase()}</span>
                                      </div>
                                    </div>
                                  </div>
                                  
                                  {/* Strategy */}
                                  <div style={{
                                    background: 'rgba(15, 23, 42, 0.6)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    marginBottom: '24px'
                                  }}>
                                    <div style={{
                                      fontSize: '14px',
                                      color: '#cbd5e1',
                                      fontWeight: '600',
                                      marginBottom: '8px',
                                      letterSpacing: '0.5px'
                                    }}>
                                      STRATEGY
                                    </div>
                                    <div style={{
                                      fontSize: '16px',
                                      color: '#e2e8f0',
                                      lineHeight: '1.6'
                                    }}>
                                      {option.strategy}
                                    </div>
                                  </div>
                                  
                                  {/* Tactics */}
                                  <div style={{ marginBottom: '24px' }}>
                                    <div style={{
                                      fontSize: '13px',
                                      color: '#fbbf24',
                                      fontWeight: '700',
                                      marginBottom: '12px',
                                      letterSpacing: '1px'
                                    }}>
                                      KEY TACTICS
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                      {option.tactics.map((tactic, tidx) => (
                                        <div key={tidx} style={{
                                          display: 'flex',
                                          gap: '12px',
                                          fontSize: '15px',
                                          color: '#cbd5e1',
                                          lineHeight: '1.6'
                                        }}>
                                          <span style={{ color: '#10b981', flexShrink: 0, fontWeight: '700' }}>â€¢</span>
                                          <span>{tactic}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                  
                                  {/* Rationale */}
                                  <div style={{
                                    background: 'rgba(59, 130, 246, 0.1)',
                                    border: '1px solid rgba(59, 130, 246, 0.3)',
                                    padding: '20px',
                                    borderRadius: '12px',
                                    marginBottom: '24px'
                                  }}>
                                    <div style={{
                                      fontSize: '13px',
                                      color: '#60a5fa',
                                      fontWeight: '700',
                                      marginBottom: '8px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '8px',
                                      letterSpacing: '0.5px'
                                    }}>
                                      <span>ğŸ’¡</span>
                                      <span>WHY THIS WORKS</span>
                                    </div>
                                    <div style={{
                                      fontSize: '15px',
                                      color: '#e2e8f0',
                                      lineHeight: '1.7'
                                    }}>
                                      {option.rationale}
                                    </div>
                                  </div>
                                  
                                  {/* Next Steps */}
                                  <div>
                                    <div style={{
                                      fontSize: '13px',
                                      color: '#10b981',
                                      fontWeight: '700',
                                      marginBottom: '12px',
                                      letterSpacing: '1px'
                                    }}>
                                      ğŸ“‹ YOUR NEXT STEPS
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                      {option.next_steps.map((step, sidx) => (
                                        <div key={sidx} style={{
                                          fontSize: '15px',
                                          color: '#cbd5e1',
                                          lineHeight: '1.6',
                                          paddingLeft: '20px'
                                        }}>
                                          <span style={{ color: '#10b981', fontWeight: '700' }}>{sidx + 1}.</span> {step}
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      ) : (
                        // Fallback to old generic options if strategic_options not available
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                          <div style={{
                            background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                            padding: '24px',
                            borderRadius: '16px',
                            border: '2px solid #334155',
                            position: 'relative',
                            overflow: 'hidden'
                          }}>
                            <div style={{
                              position: 'absolute',
                              top: 0,
                              left: 0,
                              right: 0,
                              height: '4px',
                              background: 'linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #ef4444 100%)'
                            }}></div>
                            <h3 style={{
                              fontSize: '24px',
                              fontWeight: '700',
                              marginBottom: '16px',
                              color: '#fbbf24'
                            }}>Option 1: Walk Away</h3>
                            <div style={{
                              color: '#cbd5e1',
                              lineHeight: '1.8',
                              fontSize: '16px',
                              whiteSpace: 'pre-line'
                            }}>
                              {decision_framework && typeof decision_framework === 'string' 
                                ? decision_framework.split('\n').slice(0, 5).join('\n')
                                : 'Given the multiple safety hazards and seller\'s lack of transparency, walking away is a valid option.'}
                            </div>
                          </div>
                          
                          <div style={{
                            background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                            padding: '24px',
                            borderRadius: '16px',
                            border: '2px solid #334155',
                            position: 'relative',
                            overflow: 'hidden'
                          }}>
                            <div style={{
                              position: 'absolute',
                              top: 0,
                              left: 0,
                              right: 0,
                              height: '4px',
                              background: 'linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #ef4444 100%)'
                            }}></div>
                            <h3 style={{
                              fontSize: '24px',
                              fontWeight: '700',
                              marginBottom: '16px',
                              color: '#fbbf24'
                            }}>Option 2: Negotiate Hard</h3>
                            <div style={{
                              color: '#cbd5e1',
                              lineHeight: '1.8',
                              fontSize: '16px',
                              whiteSpace: 'pre-line'
                            }}>
                              {negotiation_strategy && typeof negotiation_strategy === 'string'
                                ? negotiation_strategy.split('\n').slice(0, 5).join('\n')
                                : 'If you love the location, demand seller fix all safety items or reduce price significantly.'}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {/* NEGOTIATION TOOLKIT (v5.58.3) */}
                    <div id="toolkit" style={{
                      background: '#1e293b',
                      borderRadius: '12px',
                      padding: '30px',
                      border: '2px solid #334155',
                      maxWidth: '1200px',
                      margin: '0 auto 48px',
                      scrollMarginTop: '80px'
                    }}>
                      <h2 style={{
                        fontSize: '28px',
                        fontWeight: '700',
                        marginBottom: '8px',
                        background: 'linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%)',
                        WebkitBackgroundClip: 'text',
                        WebkitTextFillColor: 'transparent',
                        backgroundClip: 'text'
                      }}>
                        ğŸ¯ Negotiation Toolkit
                      </h2>
                      <p style={{ color: '#94a3b8', fontSize: '15px', marginBottom: '24px', lineHeight: '1.5' }}>
                        Turn your analysis into action. Generate professional documents backed by your property data.
                      </p>
                      
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                        {[
                          { type: 'offer_letter', icon: 'ğŸ“„', title: 'Offer Justification Letter', desc: 'Data-backed letter to justify your offer price to the seller or their agent.' },
                          { type: 'talking_points', icon: 'ğŸ’¬', title: 'Talking Points', desc: 'Key points for conversations with your agent, the seller, or their listing agent.' },
                          { type: 'email', icon: 'âœ‰ï¸', title: 'Agent Email Template', desc: 'Ready-to-send email for your real estate agent with your offer details.' },
                          { type: 'counteroffer', icon: 'ğŸ”„', title: 'Counter-Offer Strategy', desc: 'If the seller counters, use this to evaluate and respond strategically.' }
                        ].map(doc => (
                          <button
                            key={doc.type}
                            id={`toolkit-btn-${doc.type}`}
                            onClick={() => {
                              const btn = document.getElementById(`toolkit-btn-${doc.type}`);
                              const outputDiv = document.getElementById('toolkit-output');
                              btn.style.opacity = '0.6';
                              btn.style.pointerEvents = 'none';
                              
                              const result = window.currentAnalysisResult;
                              if (!result) { alert('No analysis data available.'); btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; return; }
                              
                              const os = result.offer_strategy || {};
                              const payload = {
                                document_type: doc.type,
                                analysis: result,
                                property_address: result.property_address || 'Property',
                                asking_price: result.property_price || 0,
                                recommended_offer: os.recommended_offer || 0,
                                buyer_name: 'Buyer'
                              };
                              
                              if (doc.type === 'counteroffer') {
                                const counterInput = prompt('Enter the seller\'s counter-offer amount (e.g. 950000):');
                                if (!counterInput) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; return; }
                                payload.original_offer = os.recommended_offer || 0;
                                payload.seller_counteroffer = parseFloat(counterInput.replace(/[,$]/g, ''));
                              }
                              
                              fetch('/api/generate-negotiation-document', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                                credentials: 'include',
                                body: JSON.stringify(payload)
                              })
                              .then(r => r.json())
                              .then(data => {
                                btn.style.opacity = '1';
                                btn.style.pointerEvents = 'auto';
                                if (data.success && data.document) {
                                  outputDiv.style.display = 'block';
                                  document.getElementById('toolkit-output-title').textContent = doc.icon + ' ' + data.document.title;
                                  document.getElementById('toolkit-output-content').textContent = data.document.content;
                                  outputDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                } else {
                                  alert(data.error || 'Failed to generate document');
                                }
                              })
                              .catch(err => {
                                btn.style.opacity = '1';
                                btn.style.pointerEvents = 'auto';
                                console.error('Toolkit error:', err);
                                alert('Error generating document. Please try again.');
                              });
                            }}
                            style={{
                              background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
                              border: '1px solid rgba(148,163,184,0.2)',
                              borderRadius: '12px',
                              padding: '20px',
                              cursor: 'pointer',
                              textAlign: 'left',
                              transition: 'all 0.2s',
                              fontFamily: 'inherit'
                            }}
                            onMouseOver={(e) => { e.currentTarget.style.borderColor = 'rgba(20,184,166,0.5)'; e.currentTarget.style.transform = 'translateY(-2px)'; }}
                            onMouseOut={(e) => { e.currentTarget.style.borderColor = 'rgba(148,163,184,0.2)'; e.currentTarget.style.transform = 'translateY(0)'; }}
                          >
                            <div style={{ fontSize: '24px', marginBottom: '8px' }}>{doc.icon}</div>
                            <div style={{ fontSize: '15px', fontWeight: '700', color: '#f1f5f9', marginBottom: '6px' }}>{doc.title}</div>
                            <div style={{ fontSize: '13px', color: '#94a3b8', lineHeight: '1.5' }}>{doc.desc}</div>
                          </button>
                        ))}
                      </div>
                      
                      {/* Document Output Area */}
                      <div id="toolkit-output" style={{ display: 'none', scrollMarginTop: '80px' }}>
                        <div style={{
                          background: '#0f172a',
                          border: '1px solid rgba(20,184,166,0.3)',
                          borderRadius: '12px',
                          padding: '24px',
                          position: 'relative'
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                            <h3 id="toolkit-output-title" style={{ fontSize: '18px', fontWeight: '700', color: '#14b8a6', margin: 0 }}></h3>
                            <button
                              onClick={() => {
                                const text = document.getElementById('toolkit-output-content').textContent;
                                navigator.clipboard.writeText(text).then(() => {
                                  const btn = event.target;
                                  btn.textContent = 'âœ… Copied!';
                                  setTimeout(() => { btn.textContent = 'ğŸ“‹ Copy'; }, 2000);
                                });
                              }}
                              style={{
                                padding: '6px 14px',
                                background: 'rgba(20,184,166,0.15)',
                                color: '#14b8a6',
                                border: '1px solid rgba(20,184,166,0.3)',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: '600',
                                fontFamily: 'inherit'
                              }}
                            >
                              ğŸ“‹ Copy
                            </button>
                          </div>
                          <pre id="toolkit-output-content" style={{
                            whiteSpace: 'pre-wrap',
                            wordWrap: 'break-word',
                            fontFamily: "'DM Mono', monospace",
                            fontSize: '13px',
                            lineHeight: '1.7',
                            color: '#cbd5e1',
                            margin: 0,
                            maxHeight: '500px',
                            overflowY: 'auto',
                            padding: '16px',
                            background: 'rgba(15, 23, 42, 0.5)',
                            borderRadius: '8px'
                          }}></pre>
                        </div>
                      </div>
                    </div>
                    
                    {/* LEGAL DISCLAIMER - CRITICAL LIABILITY PROTECTION */}
                    <div style={{
                      marginTop: '60px',
                      padding: '32px',
                      background: 'rgba(15, 23, 42, 0.6)',
                      border: '2px solid #334155',
                      borderRadius: '16px',
                      maxWidth: '1200px',
                      margin: '60px auto 40px'
                    }}>
                      <h3 style={{
                        fontSize: '18px',
                        fontWeight: '700',
                        color: '#f59e0b',
                        marginBottom: '20px',
                        textAlign: 'center'
                      }}>
                        âš–ï¸ IMPORTANT LEGAL DISCLAIMER
                      </h3>
                      
                      <div style={{
                        fontSize: '13px',
                        lineHeight: '1.8',
                        color: '#94a3b8',
                        textAlign: 'left'
                      }}>
                        <p style={{ marginBottom: '16px', fontWeight: '600', color: '#cbd5e1' }}>
                          THIS ANALYSIS IS PROVIDED FOR INFORMATIONAL PURPOSES ONLY AND DOES NOT CONSTITUTE PROFESSIONAL ADVICE.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>No Professional Relationship:</strong> This analysis does not create any attorney-client, contractor-client, inspector-client, real estate agent-client, or any other professional relationship. OfferWise is a technology platform providing automated analysis tools, not professional services.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Not Professional Advice:</strong> This analysis is NOT a substitute for professional inspection, legal advice, financial advice, tax advice, real estate advice, or any other professional service. You should always consult with licensed professionals including but not limited to: home inspectors, structural engineers, contractors, real estate attorneys, real estate agents, financial advisors, and tax professionals before making any real estate decisions.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Accuracy Not Guaranteed:</strong> While we strive for accuracy, we make NO WARRANTIES OR GUARANTEES regarding the accuracy, completeness, reliability, or timeliness of this analysis. The analysis is based on documents you provided, which may be incomplete, outdated, or inaccurate. We are not responsible for errors in source documents.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Use At Your Own Risk:</strong> You assume ALL RISK associated with using this analysis. OfferWise, its owners, employees, contractors, and affiliates shall NOT BE LIABLE for any direct, indirect, incidental, consequential, special, exemplary, or punitive damages arising from your use of this analysis, including but not limited to: property damage, financial losses, lost profits, lost opportunities, legal fees, repair costs, or any other damages whatsoever.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Independent Verification Required:</strong> You MUST independently verify all information in this analysis before making any decisions. Conduct your own inspections, obtain multiple professional opinions, review all documents personally, and perform your own due diligence.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Limitation of Liability:</strong> TO THE MAXIMUM EXTENT PERMITTED BY LAW, our total liability for any claims related to this analysis SHALL NOT EXCEED the amount you paid for this specific analysis. IN NO EVENT SHALL WE BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>No Real Estate Transaction Advice:</strong> This analysis does not recommend whether you should purchase, sell, or make an offer on any property. All real estate decisions are solely your responsibility. We do not provide guidance on offer amounts, negotiation strategies, or investment decisions.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Technology Limitations:</strong> This analysis is generated using artificial intelligence and automated algorithms. AI can make mistakes, miss important issues, or draw incorrect conclusions. The analysis may not identify all problems with a property.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Jurisdictional Issues:</strong> Real estate laws vary by state, county, and municipality. This analysis does not account for local laws, regulations, ordinances, or requirements. Consult local real estate professionals and attorneys familiar with your jurisdiction.
                        </p>
                        
                        <p style={{ marginBottom: '12px' }}>
                          <strong style={{color: '#e2e8f0'}}>Document Analysis Limitations:</strong> This analysis is only as good as the documents provided. If documents are incomplete, illegible, outdated, or inaccurate, the analysis will be similarly flawed. We are not responsible for document quality or completeness.
                        </p>
                        
                        <p style={{ marginBottom: '16px' }}>
                          <strong style={{color: '#e2e8f0'}}>Agreement to Terms:</strong> By using this analysis, you acknowledge that you have read, understood, and agree to be bound by these disclaimers and our complete Terms of Service and Privacy Policy. If you do not agree, do not use this analysis.
                        </p>
                        
                        <p style={{ 
                          textAlign: 'center', 
                          fontWeight: '700', 
                          color: '#f59e0b',
                          fontSize: '14px',
                          padding: '12px',
                          background: 'rgba(245, 158, 11, 0.1)',
                          borderRadius: '8px'
                        }}>
                          âš ï¸ ALWAYS CONSULT QUALIFIED PROFESSIONALS BEFORE MAKING ANY REAL ESTATE DECISIONS âš ï¸
                        </p>
                        
                        <p style={{ 
                          textAlign: 'center', 
                          marginTop: '16px',
                          fontSize: '12px',
                          color: '#64748b'
                        }}>
                          By proceeding with this analysis, you acknowledge and accept these terms and limitations.
                        </p>
                      </div>
                    </div>
                    
                    {/* ğŸ§ª TURK TESTING - Complete Button (v5.54.11) - Pure JS, no React state */}
                    {window.turkTracker && window.turkTracker.isActive && (
                      <div style={{
                        marginTop: '40px',
                        padding: '32px',
                        background: 'linear-gradient(135deg, #4f46e5, #7c3aed)',
                        borderRadius: '16px',
                        textAlign: 'center',
                        maxWidth: '600px',
                        margin: '40px auto'
                      }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ§ª</div>
                        <h3 style={{ fontSize: '24px', fontWeight: '700', color: 'white', marginBottom: '12px' }}>
                          Testing Complete?
                        </h3>
                        <p style={{ color: 'rgba(255,255,255,0.9)', marginBottom: '24px', lineHeight: '1.6' }}>
                          Click below to finish your test session and receive your completion code for payment.
                        </p>
                        <button
                          onClick={() => window.turkTracker.complete()}
                          style={{
                            padding: '16px 48px',
                            background: 'white',
                            color: '#4f46e5',
                            border: 'none',
                            borderRadius: '12px',
                            fontSize: '18px',
                            fontWeight: '700',
                            cursor: 'pointer',
                            boxShadow: '0 4px 12px rgba(0,0,0,0.2)'
                          }}
                        >
                          âœ… Complete Test & Get Code
                        </button>
                      </div>
                    )}
                    
                  </div>
                </div>
              );
            } catch (err) {
              console.error('Error rendering results:', err);
              return (
                <div style={styles.container}>
                  <h2>Rendering Error</h2>
                  <p style={{color: 'red'}}>{err.message}</p>
                  <button onClick={() => checkCreditsAndStartAnalysis()} style={styles.button}>
                    Start New Analysis
                  </button>
                </div>
              );
            }
          };
          
          // Navigation component
          const Navigation = () => (
            <div style={{
              background: 'rgba(30, 41, 59, 0.8)',
              borderBottom: '1px solid rgba(96, 165, 250, 0.2)',
              padding: '20px 40px',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              backdropFilter: 'blur(10px)',
              position: 'sticky',
              top: 0,
              zIndex: 1000
            }}>
              <a href="/settings" style={{ textDecoration: 'none' }}>
                <div style={{
                  fontSize: '24px',
                  fontWeight: '800',
                  background: 'linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%)',
                  WebkitBackgroundClip: 'text',
                  WebkitTextFillColor: 'transparent',
                  cursor: 'pointer'
                }}>OfferWise AI</div>
              </a>
              <div style={{ display: 'flex', gap: '24px', alignItems: 'center' }}>
                <a href="/pricing" style={{ color: '#94a3b8', textDecoration: 'none', fontWeight: '600' }}>Pricing</a>
                <a href="/settings" style={{ color: '#94a3b8', textDecoration: 'none', fontWeight: '600' }}>My Account</a>
                <button 
                  onClick={() => checkCreditsAndStartAnalysis()} 
                  style={{ 
                    color: '#60a5fa', 
                    textDecoration: 'none', 
                    fontWeight: '600',
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: 'inherit',
                    fontFamily: 'inherit',
                    padding: 0
                  }}
                >
                  New Analysis
                </button>
                <a href="/logout" style={{ 
                  background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', 
                  color: 'white', 
                  padding: '10px 20px', 
                  borderRadius: '8px', 
                  textDecoration: 'none',
                  fontWeight: '600',
                  marginLeft: '16px'
                }}>Logout</a>
              </div>
            </div>
          );
          
          // Render current step with navigation
          return (
            <>
              {currentStep === 'loading' && (
                <div style={styles.container}>
                  <h2 style={styles.subtitle}>Loading...</h2>
                  <div style={{
                    width: '40px',
                    height: '40px',
                    border: '3px solid rgba(59, 130, 246, 0.2)',
                    borderTopColor: '#3b82f6',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite',
                    margin: '40px auto'
                  }}></div>
                </div>
              )}
              {/* REMOVED: Old inline profile setup - now uses /onboarding wizard */}
              {/* {currentStep === 'first-time-profile' && <FirstTimeProfileStep />} */}
              {currentStep === 'property' && (
                <>
                  <Navigation />
                  <PropertyDocumentsStep />
                </>
              )}
              {currentStep === 'analysis' && (
                <>
                  <Navigation />
                  <AnalyzeStep />
                </>
              )}
              {currentStep === 'results' && (
                <>
                  <Navigation />
                  <ResultsStep />
                </>
              )}
              
              {/* ğŸ¯ PMF Survey Components (v5.54.50) */}
              <PMFToast />
              <PMFModal />
              
              {/* Terms of Service Modal */}
              
              {/* ğŸ›¡ï¸ Analysis Disclaimer Consent Modal */}
              {showConsentModal && (
                <div style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundColor: 'rgba(0, 0, 0, 0.95)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10001,
                  padding: '20px',
                  overflow: 'auto'
                }}>
                  <div style={{
                    backgroundColor: '#1e293b',
                    padding: '32px',
                    borderRadius: '16px',
                    maxWidth: '800px',
                    width: '100%',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    border: '2px solid #ef4444',
                    boxShadow: '0 20px 60px rgba(239, 68, 68, 0.3)'
                  }}>
                    {/* Header */}
                    <div style={{ marginBottom: '24px', textAlign: 'center' }}>
                      <div style={{ fontSize: '48px', marginBottom: '12px' }}>âš–ï¸</div>
                      <h2 style={{ 
                        color: '#ef4444', 
                        fontSize: '28px', 
                        marginBottom: '8px',
                        fontWeight: '800'
                      }}>
                        CRITICAL LEGAL DISCLAIMER
                      </h2>
                      <p style={{ color: '#94a3b8', fontSize: '14px' }}>
                        Required before analysis - Version {consentVersion}
                      </p>
                    </div>
                    
                    {/* Disclaimer Text */}
                    <div style={{
                      backgroundColor: '#0f172a',
                      padding: '24px',
                      borderRadius: '12px',
                      marginBottom: '24px',
                      maxHeight: '400px',
                      overflow: 'auto',
                      border: '1px solid #334155'
                    }}>
                      <pre style={{
                        color: '#e2e8f0',
                        fontSize: '13px',
                        lineHeight: '1.8',
                        whiteSpace: 'pre-wrap',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        margin: 0
                      }}>
                        {consentText}
                      </pre>
                    </div>
                    
                    {/* Important Notice */}
                    <div style={{
                      background: 'rgba(239, 68, 68, 0.1)',
                      border: '2px solid #ef4444',
                      borderRadius: '12px',
                      padding: '16px',
                      marginBottom: '24px'
                    }}>
                      <p style={{ color: '#fca5a5', fontSize: '14px', fontWeight: '600', marginBottom: '8px' }}>
                        âš ï¸ READ CAREFULLY BEFORE PROCEEDING
                      </p>
                      <p style={{ color: '#cbd5e1', fontSize: '13px', lineHeight: '1.6', margin: 0 }}>
                        By clicking "I Accept and Agree", you acknowledge that:
                      </p>
                      <ul style={{ color: '#cbd5e1', fontSize: '13px', lineHeight: '1.6', marginTop: '8px', marginBottom: 0 }}>
                        <li>This analysis is NOT professional advice</li>
                        <li>You MUST verify all information independently</li>
                        <li>You MUST consult licensed professionals</li>
                        <li>You assume ALL RISK for your decisions</li>
                        <li>Our liability is limited to the amount you paid</li>
                      </ul>
                    </div>
                    
                    {/* Buttons */}
                    <div style={{ display: 'flex', gap: '16px', justifyContent: 'flex-end' }}>
                      <button
                        onClick={cancelConsent}
                        disabled={consentPending}
                        style={{
                          padding: '14px 28px',
                          backgroundColor: 'transparent',
                          color: '#94a3b8',
                          border: '2px solid #334155',
                          borderRadius: '8px',
                          fontSize: '16px',
                          fontWeight: '600',
                          cursor: consentPending ? 'not-allowed' : 'pointer',
                          opacity: consentPending ? 0.5 : 1
                        }}
                      >
                        Cancel
                      </button>
                      
                      <button
                        onClick={recordConsent}
                        disabled={consentPending}
                        style={{
                          padding: '14px 32px',
                          background: consentPending ? '#64748b' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '16px',
                          fontWeight: '700',
                          cursor: consentPending ? 'not-allowed' : 'pointer',
                          boxShadow: consentPending ? 'none' : '0 4px 12px rgba(239, 68, 68, 0.4)'
                        }}
                      >
                        {consentPending ? 'Recording...' : 'I Accept and Agree âœ“'}
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ğŸ“¸ Screenshot Evidence Modal (v5.52.2) - With Zoom */}
              {showScreenshotModal && (
                <div style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundColor: 'rgba(0, 0, 0, 0.95)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10002,
                  padding: '20px',
                  overflow: 'auto'
                }}>
                  <div style={{
                    backgroundColor: '#1e293b',
                    padding: '24px',
                    borderRadius: '16px',
                    maxWidth: '95vw',
                    width: '100%',
                    maxHeight: '95vh',
                    overflow: 'hidden',
                    display: 'flex',
                    flexDirection: 'column',
                    border: '2px solid #3b82f6',
                    boxShadow: '0 20px 60px rgba(59, 130, 246, 0.3)'
                  }}>
                    {/* Header with zoom controls */}
                    <div style={{ 
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      alignItems: 'center',
                      marginBottom: '16px',
                      paddingBottom: '12px',
                      borderBottom: '1px solid #334155',
                      flexShrink: 0
                    }}>
                      <div>
                        <h3 style={{ 
                          color: '#fff', 
                          fontSize: '18px', 
                          margin: 0
                        }}>
                          ğŸ“„ {screenshotInfo.title || 'Document Source'}
                        </h3>
                        <p style={{ color: '#94a3b8', fontSize: '13px', margin: '4px 0 0 0' }}>
                          {screenshotInfo.docType === 'disclosure' ? 'Seller Disclosure' : 'Inspection Report'} â€” Page {screenshotInfo.pageNum}
                        </p>
                      </div>
                      
                      {/* Zoom controls + Close */}
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        {/* Zoom buttons */}
                        <div style={{ 
                          display: 'flex', 
                          alignItems: 'center', 
                          background: 'rgba(255,255,255,0.1)', 
                          borderRadius: '8px',
                          padding: '4px 8px',
                          gap: '4px'
                        }}>
                          <button
                            onClick={() => setScreenshotZoom(Math.max(0.5, screenshotZoom - 0.25))}
                            style={{
                              background: 'transparent',
                              border: 'none',
                              color: '#e2e8f0',
                              width: '28px',
                              height: '28px',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '18px',
                              fontWeight: 'bold'
                            }}
                          >âˆ’</button>
                          <span style={{ 
                            color: '#e2e8f0', 
                            fontSize: '12px', 
                            minWidth: '45px', 
                            textAlign: 'center',
                            fontWeight: '500'
                          }}>
                            {Math.round(screenshotZoom * 100)}%
                          </span>
                          <button
                            onClick={() => setScreenshotZoom(Math.min(3, screenshotZoom + 0.25))}
                            style={{
                              background: 'transparent',
                              border: 'none',
                              color: '#e2e8f0',
                              width: '28px',
                              height: '28px',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '18px',
                              fontWeight: 'bold'
                            }}
                          >+</button>
                        </div>
                        
                        {/* Reset zoom */}
                        <button
                          onClick={() => setScreenshotZoom(1)}
                          style={{
                            background: 'rgba(59, 130, 246, 0.2)',
                            border: '1px solid rgba(59, 130, 246, 0.4)',
                            color: '#60a5fa',
                            padding: '6px 12px',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >Reset</button>
                        
                        {/* Close */}
                        <button
                          onClick={() => {
                            setShowScreenshotModal(false);
                            setScreenshotZoom(1);
                          }}
                          style={{
                            background: 'rgba(239, 68, 68, 0.2)',
                            border: 'none',
                            color: '#f87171',
                            width: '32px',
                            height: '32px',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '18px'
                          }}
                        >Ã—</button>
                      </div>
                    </div>
                    
                    {/* Scrollable image container */}
                    <div style={{
                      backgroundColor: '#0f172a',
                      borderRadius: '12px',
                      padding: '16px',
                      flex: 1,
                      overflow: 'auto',
                      minHeight: '300px'
                    }}>
                      {screenshotLoading && (
                        <div style={{ textAlign: 'center', color: '#94a3b8', paddingTop: '100px' }}>
                          <div style={{ fontSize: '32px', marginBottom: '12px' }}>ğŸ“¸</div>
                          <div>Rendering page with highlights...</div>
                        </div>
                      )}
                      
                      {screenshotError && !screenshotLoading && (
                        <div style={{ textAlign: 'center', color: '#fbbf24', paddingTop: '60px', maxWidth: '500px', margin: '0 auto' }}>
                          <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ“„</div>
                          <div style={{ fontSize: '18px', fontWeight: '600', marginBottom: '12px', color: '#f87171' }}>
                            PDF Not Available
                          </div>
                          <div style={{ fontSize: '14px', color: '#94a3b8', lineHeight: '1.6', whiteSpace: 'pre-line' }}>
                            View Source only works for analyses created in your current browser session.
                            
                            If you're viewing a saved analysis from "My Analyses", the original PDF files are not stored for privacy reasons.
                          </div>
                          <div style={{ 
                            marginTop: '20px', 
                            padding: '12px', 
                            background: 'rgba(59, 130, 246, 0.1)', 
                            borderRadius: '8px',
                            fontSize: '13px',
                            color: '#60a5fa'
                          }}>
                            ğŸ’¡ <strong>Tip:</strong> Run a new analysis to use View Source with zoom
                          </div>
                        </div>
                      )}
                      
                      {screenshotImage && !screenshotLoading && (
                        <div style={{ 
                          display: 'flex', 
                          justifyContent: 'center',
                          minWidth: screenshotZoom > 1 ? `${screenshotZoom * 100}%` : '100%'
                        }}>
                          <img 
                            src={screenshotImage} 
                            alt={`Document page ${screenshotInfo.pageNum}`}
                            style={{
                              width: `${screenshotZoom * 100}%`,
                              maxWidth: screenshotZoom > 1 ? 'none' : '100%',
                              borderRadius: '8px',
                              boxShadow: '0 4px 20px rgba(0, 0, 0, 0.5)',
                              cursor: screenshotZoom < 2 ? 'zoom-in' : 'zoom-out'
                            }}
                            onClick={() => {
                              if (screenshotZoom < 2) {
                                setScreenshotZoom(2);
                              } else {
                                setScreenshotZoom(1);
                              }
                            }}
                          />
                        </div>
                      )}
                    </div>
                    
                    {/* Footer with quote */}
                    <div style={{
                      marginTop: '12px',
                      padding: '10px 14px',
                      background: 'rgba(59, 130, 246, 0.1)',
                      borderRadius: '8px',
                      flexShrink: 0
                    }}>
                      <div style={{ color: '#94a3b8', fontSize: '12px' }}>
                        ğŸ” <strong style={{ color: '#60a5fa' }}>View Source:</strong> Actual page from your document. Click image to zoom in/out.
                      </div>
                      
                      {screenshotInfo.quote && (
                        <div style={{
                          marginTop: '8px',
                          padding: '8px 10px',
                          background: 'rgba(251, 191, 36, 0.1)',
                          border: '1px solid rgba(251, 191, 36, 0.3)',
                          borderRadius: '6px',
                          fontSize: '11px'
                        }}>
                          <span style={{ color: '#fbbf24', fontWeight: '600' }}>ğŸ“ Look for: </span>
                          <span style={{ color: '#e2e8f0', fontStyle: 'italic' }}>
                            "{screenshotInfo.quote.length > 150 ? screenshotInfo.quote.substring(0, 150) + '...' : screenshotInfo.quote}"
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </>
          );
        };
        
        // Styles
        const styles = {
          container: {
            maxWidth: '800px',
            margin: '0 auto',
            padding: '60px 40px',
            fontFamily: 'system-ui, sans-serif',
            backgroundColor: '#0f172a',
            minHeight: 'calc(100vh - 80px)',
            color: '#e2e8f0'
          },
          title: {
            fontSize: '32px',
            marginBottom: '8px',
            fontWeight: '600',
            color: '#fff',
            cursor: 'pointer'
          },
          subtitle: {
            fontSize: '24px',
            marginBottom: '24px',
            fontWeight: '500',
            color: '#94a3b8'
          },
          input: {
            width: '100%',
            padding: '12px',
            fontSize: '16px',
            border: '1px solid #334155',
            borderRadius: '4px',
            marginBottom: '16px',
            boxSizing: 'border-box',
            backgroundColor: '#1e293b',
            color: '#e2e8f0'
          },
          button: {
            width: '100%',
            padding: '14px',
            fontSize: '16px',
            fontWeight: '600',
            backgroundColor: '#3b82f6',
            color: '#fff',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            marginTop: '8px'
          },
          backButton: {
            background: 'none',
            border: 'none',
            fontSize: '16px',
            cursor: 'pointer',
            marginBottom: '16px',
            color: '#94a3b8'
          },
          uploadSection: {
            marginBottom: '24px'
          },
          section: {
            marginBottom: '32px',
            padding: '24px',
            backgroundColor: '#1e293b',
            borderRadius: '12px',
            border: '1px solid #334155'
          },
          sectionTitle: {
            fontSize: '18px',
            fontWeight: '700',
            marginBottom: '16px',
            color: '#f1f5f9'
          },
          helpText: {
            marginTop: '24px',
            padding: '16px',
            backgroundColor: '#1e3a5f',
            borderRadius: '8px',
            fontSize: '14px',
            color: '#93c5fd',
            lineHeight: '1.6'
          },
          spinner: {
            display: 'inline-block',
            width: '20px',
            height: '20px',
            border: '3px solid #334155',
            borderTop: '3px solid #3b82f6',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            marginRight: '12px',
            verticalAlign: 'middle'
          },
          label: {
            display: 'block',
            fontSize: '14px',
            fontWeight: '600',
            marginBottom: '8px',
            color: '#cbd5e1'
          },
          fileInput: {
            width: '100%',
            padding: '12px',
            fontSize: '14px',
            border: '1px solid #334155',
            borderRadius: '4px',
            cursor: 'pointer'
          },
          success: {
            marginTop: '8px',
            padding: '8px',
            backgroundColor: '#d4edda',
            color: '#155724',
            borderRadius: '4px',
            fontSize: '14px'
          },
          error: {
            padding: '12px',
            backgroundColor: '#f8d7da',
            color: '#721c24',
            borderRadius: '4px',
            marginBottom: '16px'
          },
          loading: {
            textAlign: 'center',
            padding: '16px',
            color: '#666'
          },
          summary: {
            padding: '16px',
            backgroundColor: '#f5f5f5',
            borderRadius: '4px',
            marginBottom: '16px'
          },
          resultBox: {
            padding: '20px',
            backgroundColor: '#f9f9f9',
            borderRadius: '4px'
          },
          warning: {
            padding: '12px',
            backgroundColor: '#fff3cd',
            borderRadius: '4px',
            marginTop: '16px'
          },
          recommendation: {
            padding: '16px',
            backgroundColor: '#d1ecf1',
            borderRadius: '4px',
            marginTop: '16px'
          }
        };
        
        // Error Boundary Component
        class ErrorBoundary extends React.Component {
          constructor(props) {
            super(props);
            this.state = { hasError: false, error: null, errorInfo: null };
          }
          
          static getDerivedStateFromError(error) {
            return { hasError: true };
          }
          
          componentDidCatch(error, errorInfo) {
            console.error('React Error Boundary caught:', error, errorInfo);
            this.setState({ error, errorInfo });
          }
          
          render() {
            if (this.state.hasError) {
              return (
                <div style={{
                  maxWidth: '600px',
                  margin: '40px auto',
                  padding: '20px',
                  fontFamily: 'system-ui, sans-serif'
                }}>
                  <h1 style={{color: '#d32f2f'}}>Something went wrong</h1>
                  <p>The app encountered an error. Please refresh the page and try again.</p>
                  <details style={{marginTop: '20px', fontSize: '14px'}}>
                    <summary style={{cursor: 'pointer'}}>Error Details</summary>
                    <pre style={{
                      backgroundColor: '#f5f5f5',
                      padding: '12px',
                      borderRadius: '4px',
                      overflow: 'auto',
                      fontSize: '12px',
                      marginTop: '12px'
                    }}>
                      {this.state.error && this.state.error.toString()}
                      {'\n\n'}
                      {this.state.errorInfo && this.state.errorInfo.componentStack}
                    </pre>
                  </details>
                  <button
                    onClick={() => window.location.reload()}
                    style={{
                      marginTop: '20px',
                      padding: '12px 24px',
                      backgroundColor: '#000',
                      color: '#fff',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '16px'
                    }}
                  >
                    Refresh Page
                  </button>
                </div>
              );
            }
            
            return this.props.children;
          }
        }
        
        // Global error handlers
        window.addEventListener('error', (event) => {
          console.error('Global error:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
          console.error('Unhandled promise rejection:', event.reason);
        });
        
        // Sharing functions for analysis results
        window.shareAnalysisTwitter = function(savings) {
            const text = encodeURIComponent(
                `Just saved $${savings} on a home purchase using @OfferWiseAI! Their AI-powered analysis caught issues before I made an offer. ğŸ¡ğŸ’°`
            );
            const url = encodeURIComponent('https://www.getofferwise.ai');
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=600,height=400');
        };
        
        window.shareAnalysisFacebook = function() {
            const url = encodeURIComponent('https://www.getofferwise.ai');
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
        };
        
        window.shareAnalysisLinkedIn = function(savings) {
            const url = encodeURIComponent('https://www.getofferwise.ai');
            const title = encodeURIComponent('Smart Home Buying with OfferWise AI');
            const summary = encodeURIComponent(`I saved $${savings} using AI-powered property analysis. Check it out!`);
            window.open(
                `https://www.linkedin.com/sharing/share-offsite/?url=${url}`,
                '_blank',
                'width=600,height=400'
            );
        };
        
        // === SECOND OPINION SHARING (v5.58.0) ===
        window.openSecondOpinionModal = function(result) {
            // Try multiple sources for the result data
            const data = result || window.currentAnalysisResult;
            if (!data) {
                alert('No analysis data available.');
                return;
            }
            
            // Resilient property_id lookup: check result, window global, and URL
            const propertyId = data.property_id 
                || (window.currentAnalysisResult && window.currentAnalysisResult.property_id)
                || null;
            
            if (!propertyId) {
                console.warn('property_id not found in:', Object.keys(data));
                alert('Unable to share â€” property ID not found. Try reloading this analysis from your dashboard.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'second-opinion-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px);padding:16px;';
            
            modal.innerHTML = `
              <div style="background:#111827;border-radius:20px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid rgba(148,163,184,0.15);">
                <div style="padding:28px 24px 0;">
                  <div style="display:flex;justify-content:space-between;align-items:start;gap:16px;margin-bottom:20px;">
                    <div style="flex:1;min-width:0;">
                      <h2 style="font-size:20px;font-weight:700;color:#f1f5f9;margin:0 0 6px;">Get a Second Opinion</h2>
                      <p style="font-size:14px;color:#94a3b8;margin:0;line-height:1.5;">Share a summary with someone you trust. They'll see the score, top findings, and offer range.</p>
                    </div>
                    <button onclick="document.getElementById('second-opinion-modal').remove()" style="background:rgba(255,255,255,0.1);border:none;color:#94a3b8;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">âœ•</button>
                  </div>
                  
                  <div style="display:flex;flex-direction:column;gap:14px;margin-bottom:20px;">
                    <div>
                      <label style="display:block;font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Your name</label>
                      <input id="share-sharer-name" type="text" placeholder="Francis" maxlength="100" style="width:100%;padding:12px 14px;background:#1a2236;border:1px solid rgba(148,163,184,0.2);border-radius:10px;color:#f1f5f9;font-size:15px;font-family:inherit;outline:none;box-sizing:border-box;" />
                    </div>
                    <div>
                      <label style="display:block;font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Add a note <span style="font-weight:400;text-transform:none;">(optional)</span></label>
                      <textarea id="share-personal-note" placeholder="What do you think of this one?" maxlength="280" rows="2" style="width:100%;padding:12px 14px;background:#1a2236;border:1px solid rgba(148,163,184,0.2);border-radius:10px;color:#f1f5f9;font-size:15px;font-family:inherit;outline:none;resize:none;box-sizing:border-box;"></textarea>
                    </div>
                  </div>
                </div>
                
                <div id="share-link-result" style="display:none;padding:0 24px;">
                  <div style="background:rgba(20,184,166,0.08);border:1px solid rgba(20,184,166,0.2);border-radius:12px;padding:16px;margin-bottom:16px;">
                    <div style="font-size:12px;font-weight:600;color:#14b8a6;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Share link ready</div>
                    <div id="share-url-display" style="font-family:monospace;font-size:13px;color:#f1f5f9;word-break:break-all;line-height:1.5;"></div>
                  </div>
                  
                  <!-- Primary actions -->
                  <div style="display:flex;gap:10px;margin-bottom:12px;">
                    <button id="share-native-btn" onclick="window.nativeShareOpinion()" style="flex:1;padding:14px;background:linear-gradient(135deg,#14b8a6,#0d9488);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;display:none;align-items:center;justify-content:center;gap:8px;">
                      ğŸ“¤ Share
                    </button>
                    <button onclick="window.copyShareLink()" style="flex:1;padding:14px;background:rgba(59,130,246,0.15);color:#60a5fa;border:2px solid rgba(59,130,246,0.3);border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;" id="copy-link-btn">
                      ğŸ“‹ Copy Link
                    </button>
                  </div>
                  
                  <!-- Messaging apps -->
                  <div style="font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Send via</div>
                  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
                    <button onclick="window.shareViaText()" style="padding:10px 6px;background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.2);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                      ğŸ’¬ iMessage
                    </button>
                    <button onclick="window.shareViaWhatsApp()" style="padding:10px 6px;background:rgba(37,211,102,0.1);color:#25D366;border:1px solid rgba(37,211,102,0.2);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                      WhatsApp
                    </button>
                    <button onclick="window.shareViaMessenger()" style="padding:10px 6px;background:rgba(0,132,255,0.1);color:#0084FF;border:1px solid rgba(0,132,255,0.2);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                      Messenger
                    </button>
                  </div>
                  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px;">
                    <button onclick="window.shareViaTelegram()" style="padding:10px 6px;background:rgba(38,165,224,0.1);color:#26A5E0;border:1px solid rgba(38,165,224,0.2);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                      Telegram
                    </button>
                    <button onclick="window.shareViaTwitter()" style="padding:10px 6px;background:rgba(148,163,184,0.1);color:#94a3b8;border:1px solid rgba(148,163,184,0.2);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                      ğ• Post
                    </button>
                    <button onclick="window.shareViaEmail()" style="padding:10px 6px;background:rgba(96,165,250,0.1);color:#60a5fa;border:1px solid rgba(96,165,250,0.2);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;">
                      âœ‰ï¸ Email
                    </button>
                  </div>
                </div>
                
                <div style="padding:0 24px 24px;">
                  <button id="generate-share-btn" onclick="window.generateShareLink(${propertyId})" style="width:100%;padding:16px;background:linear-gradient(135deg,#14b8a6,#0d9488);color:white;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;">
                    ğŸ”— Generate Share Link
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        };
        
        // Generate the share link via API
        window._shareUrl = null;
        window._shareText = null;
        
        window.generateShareLink = async function(propertyId) {
            const btn = document.getElementById('generate-share-btn');
            const sharerName = document.getElementById('share-sharer-name').value.trim();
            const personalNote = document.getElementById('share-personal-note').value.trim();
            
            btn.textContent = 'Generating...';
            btn.style.opacity = '0.7';
            btn.style.pointerEvents = 'none';
            
            try {
                const res = await fetch('/api/share/create', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        property_id: propertyId,
                        sharer_name: sharerName,
                        personal_note: personalNote
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok || !data.success) {
                    throw new Error(data.error || `Server error ${res.status}`);
                }
                
                window._shareUrl = data.share_url;
                window._shareText = `${sharerName ? sharerName + ' wants' : 'I want'} your opinion on a property: ${data.share_url}`;
                
                // Show the link result section
                document.getElementById('share-url-display').textContent = data.share_url;
                document.getElementById('share-link-result').style.display = 'block';
                btn.style.display = 'none';
                
                // Show native share button on mobile
                if (navigator.share) {
                    document.getElementById('share-native-btn').style.display = 'flex';
                }
                
            } catch (err) {
                console.error('Share link error:', err);
                btn.textContent = 'âŒ ' + (err.message || 'Error â€” try again');
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
                setTimeout(() => { btn.textContent = 'ğŸ”— Generate Share Link'; }, 4000);
            }
        };
        
        // Native Web Share API (opens system share sheet on mobile)
        window.nativeShareOpinion = async function() {
            if (!window._shareUrl) return;
            try {
                await navigator.share({
                    title: 'What do you think of this property?',
                    text: window._shareText,
                    url: window._shareUrl
                });
            } catch (err) {
                if (err.name !== 'AbortError') console.error('Share failed:', err);
            }
        };
        
        // Copy link to clipboard
        window.copyShareLink = function() {
            if (!window._shareUrl) return;
            navigator.clipboard.writeText(window._shareUrl).then(() => {
                const btn = document.getElementById('copy-link-btn');
                btn.textContent = 'âœ… Copied!';
                setTimeout(() => { btn.textContent = 'ğŸ“‹ Copy Link'; }, 2000);
            });
        };
        
        // Share via iMessage/SMS
        window.shareViaText = function() {
            if (!window._shareUrl) return;
            const body = encodeURIComponent(window._shareText);
            window.open(`sms:?&body=${body}`, '_self');
        };
        
        // Share via WhatsApp
        window.shareViaWhatsApp = function() {
            if (!window._shareUrl) return;
            const text = encodeURIComponent(window._shareText);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        };
        
        // Share via Email
        window.shareViaEmail = function() {
            if (!window._shareUrl) return;
            const subject = encodeURIComponent('What do you think of this property?');
            const body = encodeURIComponent(`Hey,\n\nI'm looking at a property and would love your opinion. Here's the AI analysis:\n\n${window._shareUrl}\n\nLet me know what you think!`);
            window.open(`mailto:?subject=${subject}&body=${body}`, '_self');
        };
        
        // Share via Facebook Messenger
        window.shareViaMessenger = function() {
            if (!window._shareUrl) return;
            const url = encodeURIComponent(window._shareUrl);
            // Try mobile deep link first, fall back to messenger.com
            const messengerUrl = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)
                ? `fb-messenger://share/?link=${url}`
                : `https://www.messenger.com/new`;
            window.open(messengerUrl, '_blank');
        };
        
        // Share via Telegram
        window.shareViaTelegram = function() {
            if (!window._shareUrl) return;
            const text = encodeURIComponent(window._shareText);
            const url = encodeURIComponent(window._shareUrl);
            window.open(`https://t.me/share/url?url=${url}&text=${text}`, '_blank');
        };
        
        // Share via X/Twitter
        window.shareViaTwitter = function() {
            if (!window._shareUrl) return;
            const text = encodeURIComponent(window._shareText);
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank', 'width=600,height=400');
        };
        
        // Professional Print Report Generator (v5.58.7)
        window.generatePrintReport = function() {
            const result = window.currentAnalysisResult;
            if (!result) {
                alert('No analysis data available. Please run an analysis first.');
                return;
            }
            
            // === DERIVE ALL VALUES MATCHING MAIN ANALYSIS ===
            const askingPrice = result.property_price || 0;
            const offerStrategy = result.offer_strategy || {};
            const recommendedOffer = offerStrategy.recommended_offer || 0;
            const savings = Math.max(0, askingPrice - recommendedOffer);
            const discountPct = offerStrategy.discount_percentage || 0;
            const riskScore = result.risk_score || {};
            const riskDna = result.risk_dna || {};
            const transparency = result.transparency_report || {};
            
            // OfferScore = 100 - composite_score (quality score, higher = better)
            const compositeScore = riskDna.composite_score || 0;
            const offerScoreValue = Math.round(100 - compositeScore);
            
            // Risk tier from composite (matching frontend getRiskTierFromComposite)
            let riskTier, riskColor, riskBg;
            if (compositeScore >= 90) { riskTier = 'CRITICAL'; riskColor = '#ef4444'; riskBg = '#fee2e2'; }
            else if (compositeScore >= 75) { riskTier = 'HIGH'; riskColor = '#f97316'; riskBg = '#ffedd5'; }
            else if (compositeScore >= 60) { riskTier = 'ELEVATED'; riskColor = '#f59e0b'; riskBg = '#fef3c7'; }
            else if (compositeScore >= 40) { riskTier = 'MODERATE'; riskColor = '#fbbf24'; riskBg = '#fef9c3'; }
            else if (compositeScore >= 20) { riskTier = 'LOW'; riskColor = '#22c55e'; riskBg = '#dcfce7'; }
            else { riskTier = 'MINIMAL'; riskColor = '#10b981'; riskBg = '#d1fae5'; }
            
            // Repair costs from risk_score
            const repairLow = riskScore.total_repair_cost_low || 0;
            const repairHigh = riskScore.total_repair_cost_high || 0;
            
            // Deal breakers
            const dealBreakers = riskScore.deal_breakers || [];
            
            // Red flags from transparency report
            const redFlags = transparency.red_flags || [];
            
            // Category scores
            const categoryScores = riskScore.category_scores || [];
            
            // Transparency score
            const transparencyScore = transparency.transparency_score;
            const transparencyGrade = transparency.grade || '';
            
            // Format date
            const reportDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // === BUILD DEAL BREAKERS SECTION ===
            let dealBreakersHtml = '';
            if (dealBreakers.length > 0) {
                dealBreakersHtml = dealBreakers.map(db => {
                    const text = typeof db === 'string' ? db : (db.issue || db.title || db.description || 'Critical issue');
                    return `<div style="padding: 12px 16px; background: #fef2f2; border-left: 4px solid #ef4444; margin-bottom: 8px; border-radius: 0 8px 8px 0;">
                        <div style="font-weight: 600; color: #991b1b; font-size: 14px;">â›” ${text}</div>
                    </div>`;
                }).join('');
            }
            
            // === BUILD RED FLAGS SECTION ===
            let redFlagsHtml = '';
            if (redFlags.length > 0) {
                redFlagsHtml = redFlags.map(flag => {
                    const desc = flag.description || flag.flag || 'Issue detected';
                    const evidence = flag.evidence || [];
                    const evidenceHtml = evidence.slice(0, 3).map(e => 
                        `<div style="font-size: 12px; color: #7f1d1d; padding-left: 16px;">â€¢ ${typeof e === 'string' ? e : (e.description || '')}</div>`
                    ).join('');
                    return `<div style="padding: 12px 16px; background: #fef2f2; border-left: 4px solid #f59e0b; margin-bottom: 8px; border-radius: 0 8px 8px 0;">
                        <div style="font-weight: 600; color: #92400e; font-size: 14px;">ğŸš¨ ${desc}</div>
                        ${evidenceHtml}
                        ${flag.recommendation ? `<div style="font-size: 12px; color: #1e40af; margin-top: 6px; font-style: italic;">ğŸ’¡ ${flag.recommendation}</div>` : ''}
                    </div>`;
                }).join('');
            }
            
            // === BUILD RISK DNA BARS ===
            let riskDnaHtml = '';
            if (riskDna) {
                const scores = [
                    { name: 'Structural', score: riskDna.structural_score || 0, icon: 'ğŸ—ï¸' },
                    { name: 'Systems', score: riskDna.systems_score || 0, icon: 'âš¡' },
                    { name: 'Transparency', score: riskDna.transparency_score || 0, icon: 'ğŸ”' },
                    { name: 'Temporal', score: riskDna.temporal_score || 0, icon: 'â³' },
                    { name: 'Financial', score: riskDna.financial_score || 0, icon: 'ğŸ’°' }
                ];
                riskDnaHtml = scores.map(s => {
                    const barColor = s.score > 60 ? '#ef4444' : s.score > 30 ? '#f59e0b' : '#22c55e';
                    return `<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <div style="width: 120px; font-size: 13px; color: #475569;">${s.icon} ${s.name}</div>
                        <div style="flex: 1; background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="width: ${Math.round(s.score)}%; height: 100%; background: ${barColor}; border-radius: 5px;"></div>
                        </div>
                        <div style="width: 40px; text-align: right; font-weight: 700; color: #334155; font-size: 14px;">${Math.round(s.score)}</div>
                    </div>`;
                }).join('');
            }
            
            // === BUILD CATEGORY SCORES ===
            let categoryHtml = '';
            if (categoryScores.length > 0) {
                const sorted = [...categoryScores].sort((a, b) => (b.score || 0) - (a.score || 0));
                categoryHtml = sorted.slice(0, 8).map(cat => {
                    const score = Math.round(cat.score || 0);
                    const costLow = cat.estimated_cost_low || 0;
                    const costHigh = cat.estimated_cost_high || 0;
                    const catName = typeof cat.category === 'object' ? (cat.category.value || 'Unknown') : (cat.category || 'Unknown');
                    const barColor = score > 60 ? '#ef4444' : score > 30 ? '#f59e0b' : '#22c55e';
                    return `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 13px;">
                        <div style="width: 100px; color: #475569; font-weight: 500;">${catName}</div>
                        <div style="flex: 1; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${score}%; height: 100%; background: ${barColor}; border-radius: 4px;"></div>
                        </div>
                        <div style="width: 30px; text-align: right; font-weight: 700; color: #334155;">${score}</div>
                        ${costLow > 0 ? `<div style="width: 120px; text-align: right; color: #64748b; font-size: 12px;">$${(costLow/1000).toFixed(0)}Kâ€“$${(costHigh/1000).toFixed(0)}K</div>` : '<div style="width: 120px;"></div>'}
                    </div>`;
                }).join('');
            }
            
            // === BUILD STRATEGIC OPTIONS ===
            let strategicHtml = '';
            if (offerStrategy.strategic_options && Array.isArray(offerStrategy.strategic_options)) {
                strategicHtml = offerStrategy.strategic_options.map((opt, i) => {
                    const colors = ['#22c55e', '#3b82f6', '#f59e0b'];
                    return `<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${colors[i] || '#94a3b8'};">
                        <div style="font-weight: 700; color: #0f172a; font-size: 15px; margin-bottom: 6px;">${opt.label || 'Option ' + (i+1)}</div>
                        ${opt.offer_amount ? `<div style="font-size: 20px; font-weight: 800; color: ${colors[i] || '#334155'}; margin-bottom: 6px;">$${Math.round(opt.offer_amount).toLocaleString()}</div>` : ''}
                        <div style="font-size: 13px; color: #475569; line-height: 1.5;">${opt.rationale || ''}</div>
                    </div>`;
                }).join('');
            }
            
            // === GENERATE REPORT HTML ===
            const reportHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Property Analysis Report - ${result.property_address || 'Property'}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white; color: #1e293b; line-height: 1.6;
            padding: 40px; max-width: 850px; margin: 0 auto;
        }
        @media print {
            body { padding: 20px; }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            @page { margin: 0.5in; }
        }
        .print-buttons { position: fixed; top: 20px; right: 20px; display: flex; gap: 12px; z-index: 100; }
        .print-btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .print-btn-primary { background: #3b82f6; color: white; }
        .print-btn-secondary { background: #e2e8f0; color: #334155; }
        .section { margin-bottom: 28px; }
        .section-title { font-size: 17px; font-weight: 700; color: #334155; margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="print-buttons no-print">
        <button class="print-btn print-btn-secondary" onclick="window.close()">âœ• Close</button>
        <button class="print-btn print-btn-primary" onclick="window.print()">ğŸ–¨ï¸ Print / Save PDF</button>
    </div>

    <!-- HEADER -->
    <div style="display: flex; justify-content: space-between; align-items: start; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; margin-bottom: 28px;">
        <div>
            <div style="font-size: 26px; font-weight: 800; color: #3b82f6;">Offer<span style="color: #8b5cf6;">Wise</span></div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">AI-Powered Property Analysis â€¢ Patent Pending</div>
        </div>
        <div style="text-align: right;">
            <div style="color: #64748b; font-size: 13px;">${reportDate}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">Report ID: ${Date.now().toString(36).toUpperCase()}</div>
        </div>
    </div>

    <!-- PROPERTY + OFFERSCORE HERO -->
    <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 24px; border-radius: 12px; margin-bottom: 28px; border: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <div style="font-size: 22px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">${result.property_address || 'Property Analysis'}</div>
                <div style="font-size: 16px; color: #64748b;">Asking Price: $${askingPrice.toLocaleString()}</div>
            </div>
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; border-radius: 50%; border: 6px solid ${riskColor}; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white;">
                    <div style="font-size: 28px; font-weight: 900; color: ${riskColor}; line-height: 1;">${offerScoreValue}</div>
                    <div style="font-size: 9px; color: #94a3b8; font-weight: 600;">/100</div>
                </div>
                <div style="font-size: 10px; color: #64748b; margin-top: 4px; font-weight: 600;">OfferScoreâ„¢</div>
            </div>
            <div style="display: inline-block; padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 14px; background: ${riskBg}; color: ${riskColor};">
                ${riskTier} RISK
            </div>
        </div>
    </div>

    <!-- RECOMMENDED OFFER -->
    ${recommendedOffer > 0 ? `
    <div class="section">
        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 24px; text-align: center;">
            <div style="font-size: 13px; color: #166534; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Recommended Offer</div>
            <div style="font-size: 36px; font-weight: 800; color: #15803d;">$${recommendedOffer.toLocaleString()}</div>
            ${savings > 0 ? `<div style="font-size: 14px; color: #166534; margin-top: 6px;">Save $${savings.toLocaleString()} (${discountPct > 0 ? Math.round(discountPct) : ((savings / askingPrice) * 100).toFixed(1)}% below asking)</div>` : ''}
        </div>
    </div>
    ` : ''}

    <!-- KEY METRICS -->
    <div class="section">
        <div class="section-title">ğŸ“Š Key Metrics</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;">
            <div style="background: #f8fafc; padding: 16px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0;">
                <div style="font-size: 26px; font-weight: 700; color: ${riskColor};">${offerScoreValue}</div>
                <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">OfferScoreâ„¢</div>
            </div>
            <div style="background: #f8fafc; padding: 16px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0;">
                <div style="font-size: 26px; font-weight: 700; color: #ef4444;">${dealBreakers.length}</div>
                <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Deal Breakers</div>
            </div>
            <div style="background: #f8fafc; padding: 16px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0;">
                <div style="font-size: 26px; font-weight: 700; color: #334155;">$${repairLow > 0 ? (repairLow/1000).toFixed(0) + 'Kâ€“$' + (repairHigh/1000).toFixed(0) + 'K' : '0'}</div>
                <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Est. Repairs</div>
            </div>
        </div>
    </div>

    <!-- DEAL BREAKERS -->
    ${dealBreakers.length > 0 ? `
    <div class="section">
        <div class="section-title">â›” Deal Breakers (${dealBreakers.length})</div>
        ${dealBreakersHtml}
    </div>
    ` : ''}

    <!-- RISK DNA -->
    ${riskDnaHtml ? `
    <div class="section">
        <div class="section-title">ğŸ§¬ Property Risk DNAâ„¢</div>
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
            ${riskDnaHtml}
            <div style="font-size: 11px; color: #94a3b8; margin-top: 10px; text-align: center;">Higher score = higher risk in that dimension. Composite: ${Math.round(compositeScore)}/100</div>
        </div>
    </div>
    ` : ''}

    <!-- CATEGORY BREAKDOWN -->
    ${categoryHtml ? `
    <div class="section">
        <div class="section-title">ğŸ“‹ Category Breakdown</div>
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
            ${categoryHtml}
        </div>
    </div>
    ` : ''}

    <!-- SELLER TRANSPARENCY -->
    ${transparencyScore !== undefined && transparencyScore !== null ? `
    <div class="section page-break">
        <div class="section-title">ğŸ” Seller Transparency Reportâ„¢</div>
        <div style="display: flex; align-items: center; gap: 24px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 12px;">
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 900; color: ${transparencyScore >= 70 ? '#22c55e' : transparencyScore >= 40 ? '#f59e0b' : '#ef4444'};">${Math.round(transparencyScore)}</div>
                <div style="font-size: 11px; color: #64748b;">/100</div>
            </div>
            ${transparencyGrade ? `<div style="font-size: 48px; font-weight: 900; color: ${transparencyScore >= 70 ? '#22c55e' : transparencyScore >= 40 ? '#f59e0b' : '#ef4444'};">${typeof transparencyGrade === 'object' ? (transparencyGrade.value || '') : transparencyGrade}</div>` : ''}
            <div style="flex: 1;">
                ${transparency.trust_level ? `<div style="font-size: 14px; color: #475569;"><strong>Trust Level:</strong> ${transparency.trust_level}</div>` : ''}
                ${transparency.omission_score !== undefined ? `<div style="font-size: 13px; color: #64748b; margin-top: 4px;">Omission: ${transparency.omission_score}/100 Â· Minimization: ${transparency.minimization_score || 0}/100 Â· Consistency: ${transparency.consistency_score || 0}/100</div>` : ''}
            </div>
        </div>
    </div>
    ` : ''}

    <!-- RED FLAGS -->
    ${redFlags.length > 0 ? `
    <div class="section">
        <div class="section-title">ğŸš¨ Red Flags (${redFlags.length})</div>
        ${redFlagsHtml}
    </div>
    ` : ''}

    <!-- STRATEGIC OPTIONS -->
    ${strategicHtml ? `
    <div class="section">
        <div class="section-title">ğŸ’¡ Your Decision Options</div>
        ${strategicHtml}
    </div>
    ` : `
    ${offerStrategy.reasoning ? `
    <div class="section">
        <div class="section-title">ğŸ’¡ Strategy</div>
        <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; font-size: 14px; color: #0c4a6e; line-height: 1.6;">
            ${offerStrategy.reasoning}
        </div>
    </div>
    ` : ''}
    `}

    <!-- DISCLAIMER -->
    <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px; font-size: 11px; color: #92400e; margin-top: 24px; line-height: 1.5;">
        <strong>âš–ï¸ IMPORTANT LEGAL DISCLAIMER:</strong> This analysis is provided for informational purposes only and does not constitute professional advice. 
        It does not create any professional relationship. Always consult with licensed professionals including home inspectors, structural engineers, contractors, 
        real estate attorneys, and financial advisors before making any real estate decisions. We make no warranties regarding accuracy, completeness, or reliability. 
        You assume all risk associated with using this analysis. To the maximum extent permitted by law, our total liability shall not exceed the amount you paid for this analysis.
    </div>

    <!-- FOOTER -->
    <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #94a3b8; font-size: 11px;">
        <div style="margin-bottom: 6px;">Generated by OfferWiseâ„¢ Â· www.getofferwise.ai</div>
        <div>OfferScoreâ„¢, Property Risk DNAâ„¢, and Seller Transparency Reportâ„¢ are patent-pending technologies.</div>
    </div>
</body>
</html>
            `;
            
            // Open in new window
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(reportHtml);
            printWindow.document.close();
        };
        
        // ================================================================
        // NEGOTIATION HUB (v5.54.68)
        // Unified negotiation system: AI strategy + professional documents
        // ================================================================
        
        window.openNegotiationCoach = function() {
            const result = window.currentAnalysisResult;
            if (!result) {
                alert('No analysis data available. Please run an analysis first.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'negotiation-hub-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px); overflow-y: auto; padding: 20px;';
            
            const askingPrice = result?.property_price || 0;
            const recommendedOffer = result?.offer_strategy?.recommended_offer || 0;
            const savings = Math.max(0, askingPrice - recommendedOffer);
            const savingsPct = askingPrice > 0 ? ((savings / askingPrice) * 100).toFixed(1) : 0;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 1px solid rgba(245, 158, 11, 0.3);">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 24px 32px; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="font-size: 24px; font-weight: 700; color: white; margin: 0 0 4px 0;">ğŸ¯ Negotiation Hub</h2>
                                <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin: 0;">${result.property_address || 'Your Property'} â€¢ Potential savings: $${savings.toLocaleString()} (${savingsPct}%)</p>
                            </div>
                            <button onclick="document.getElementById('negotiation-hub-modal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px;">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div style="display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                        <button onclick="showNegotiationTab('strategy')" id="tab-strategy" class="neg-tab active" style="flex: 1; padding: 16px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: none; cursor: pointer; font-weight: 600; border-bottom: 2px solid #f59e0b;">
                            ğŸ¤– AI Strategy
                        </button>
                        <button onclick="showNegotiationTab('documents')" id="tab-documents" class="neg-tab" style="flex: 1; padding: 16px; background: transparent; color: #94a3b8; border: none; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent;">
                            ğŸ“„ Documents
                        </button>
                        <button onclick="showNegotiationTab('tips')" id="tab-tips" class="neg-tab" style="flex: 1; padding: 16px; background: transparent; color: #94a3b8; border: none; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent;">
                            ğŸ’¡ Quick Tips
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div style="padding: 32px;">
                        <!-- AI Strategy Tab -->
                        <div id="content-strategy" class="neg-content">
                            <!-- Style Selection -->
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; font-weight: 600; color: #e2e8f0; margin-bottom: 12px;">Negotiation Style:</label>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <button id="style-aggressive" onclick="selectNegotiationStyle('aggressive')" style="flex: 1; min-width: 100px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                        ğŸ”¥ Aggressive
                                    </button>
                                    <button id="style-balanced" onclick="selectNegotiationStyle('balanced')" style="flex: 1; min-width: 100px; padding: 12px 16px; background: rgba(59, 130, 246, 0.4); color: #60a5fa; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; font-weight: 600; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                                        âš–ï¸ Balanced
                                    </button>
                                    <button id="style-collaborative" onclick="selectNegotiationStyle('collaborative')" style="flex: 1; min-width: 100px; padding: 12px 16px; background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 2px solid #22c55e; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                        ğŸ¤ Collaborative
                                    </button>
                                </div>
                            </div>
                            
                            <button id="generate-full-btn" onclick="generateFullPackage()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 16px;">
                                ğŸš€ Generate âš–ï¸ Balanced Strategy
                            </button>
                            
                            <p style="color: #64748b; font-size: 13px; text-align: center; margin-bottom: 24px;">
                                AI-powered analysis takes 30-60 seconds
                            </p>
                            
                            <div id="strategy-results" style="display: none;"></div>
                        </div>
                        
                        <!-- Documents Tab -->
                        <div id="content-documents" class="neg-content" style="display: none;">
                            <p style="color: #94a3b8; margin-bottom: 24px;">Generate professional documents instantly (no AI wait time):</p>
                            
                            <div style="display: grid; gap: 16px;">
                                <button onclick="generateDocument('offer_letter')" class="doc-btn" style="padding: 20px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; cursor: pointer; text-align: left;">
                                    <div style="font-weight: 600; color: #22c55e; margin-bottom: 4px;">âœ‰ï¸ Offer Letter</div>
                                    <div style="color: #94a3b8; font-size: 13px;">Professional letter justifying your offer price</div>
                                </button>
                                
                                <button onclick="generateDocument('talking_points')" class="doc-btn" style="padding: 20px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; cursor: pointer; text-align: left;">
                                    <div style="font-weight: 600; color: #60a5fa; margin-bottom: 4px;">ğŸ’¬ Talking Points</div>
                                    <div style="color: #94a3b8; font-size: 13px;">Key points to raise during negotiation</div>
                                </button>
                                
                                <button onclick="generateDocument('agent_email')" class="doc-btn" style="padding: 20px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; cursor: pointer; text-align: left;">
                                    <div style="font-weight: 600; color: #a78bfa; margin-bottom: 4px;">ğŸ“§ Agent Email</div>
                                    <div style="color: #94a3b8; font-size: 13px;">Email template to send with your offer</div>
                                </button>
                            </div>
                            
                            <div id="document-result" style="margin-top: 24px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 id="document-title" style="color: #e2e8f0; margin: 0;"></h3>
                                    <button onclick="copyDocumentContent()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">ğŸ“‹ Copy</button>
                                </div>
                                <div id="document-content" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; color: #e2e8f0; white-space: pre-wrap; font-size: 14px; line-height: 1.6;"></div>
                            </div>
                        </div>
                        
                        <!-- Quick Tips Tab -->
                        <div id="content-tips" class="neg-content" style="display: none;">
                            <div id="tips-container" style="color: #94a3b8;">Loading tips...</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.selectedNegotiationStyle = 'balanced';
            loadQuickTips();
        };
        
        window.showNegotiationTab = function(tab) {
            // Update tab buttons
            document.querySelectorAll('.neg-tab').forEach(t => {
                t.style.background = 'transparent';
                t.style.color = '#94a3b8';
                t.style.borderBottom = '2px solid transparent';
            });
            const activeTab = document.getElementById('tab-' + tab);
            if (activeTab) {
                activeTab.style.background = 'rgba(245, 158, 11, 0.2)';
                activeTab.style.color = '#f59e0b';
                activeTab.style.borderBottom = '2px solid #f59e0b';
            }
            
            // Update content
            document.querySelectorAll('.neg-content').forEach(c => c.style.display = 'none');
            const content = document.getElementById('content-' + tab);
            if (content) content.style.display = 'block';
            
            // Load tips if switching to tips tab
            if (tab === 'tips') loadQuickTips();
        };
        
        window.selectedNegotiationStyle = 'balanced';
        
        window.selectNegotiationStyle = function(style) {
            window.selectedNegotiationStyle = style;
            
            // Update button states
            ['aggressive', 'balanced', 'collaborative'].forEach(s => {
                const btn = document.getElementById('style-' + s);
                if (btn) {
                    const isActive = s === style;
                    if (isActive) {
                        // Active state - more prominent
                        btn.style.background = s === 'aggressive' ? 'rgba(239, 68, 68, 0.4)' : 
                                               s === 'balanced' ? 'rgba(59, 130, 246, 0.4)' : 'rgba(34, 197, 94, 0.4)';
                        btn.style.transform = 'scale(1.05)';
                        btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                    } else {
                        // Inactive state
                        btn.style.background = s === 'aggressive' ? 'rgba(239, 68, 68, 0.1)' : 
                                               s === 'balanced' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(34, 197, 94, 0.1)';
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update generate button text to show selected style
            const genBtn = document.getElementById('generate-full-btn');
            if (genBtn) {
                const styleEmoji = style === 'aggressive' ? 'ğŸ”¥' : style === 'collaborative' ? 'ğŸ¤' : 'âš–ï¸';
                genBtn.innerHTML = `ğŸš€ Generate ${styleEmoji} ${style.charAt(0).toUpperCase() + style.slice(1)} Strategy`;
            }
        };
        
        async function loadQuickTips() {
            try {
                const response = await fetch('/api/negotiation/tips', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ analysis: window.currentAnalysisResult })
                });
                const data = await response.json();
                const container = document.getElementById('tips-container');
                if (container && data.success && data.tips) {
                    container.innerHTML = data.tips.map(tip => `
                        <div style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 16px; margin-bottom: 12px; border-radius: 0 8px 8px 0;">
                            ${tip}
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Tips error:', e);
            }
        }
        
        async function generateFullPackage() {
            const btn = document.getElementById('generate-full-btn');
            const resultsDiv = document.getElementById('strategy-results');
            const style = window.selectedNegotiationStyle || 'balanced';
            const styleEmoji = style === 'aggressive' ? 'ğŸ”¥' : style === 'collaborative' ? 'ğŸ¤' : 'âš–ï¸';
            
            btn.disabled = true;
            btn.innerHTML = `â³ Generating ${styleEmoji} ${style.charAt(0).toUpperCase() + style.slice(1)} Strategy...`;
            
            try {
                const response = await fetch('/api/negotiation/full-package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis: window.currentAnalysisResult,
                        style: window.selectedNegotiationStyle
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = formatFullPackageResults(data);
                    resultsDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Package error:', e);
                alert('Failed to generate. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `ğŸš€ Generate ${styleEmoji} ${style.charAt(0).toUpperCase() + style.slice(1)} Strategy`;
            }
        }
        
        async function generateDocument(docType) {
            const resultDiv = document.getElementById('document-result');
            const titleEl = document.getElementById('document-title');
            const contentEl = document.getElementById('document-content');
            
            // Show loading
            resultDiv.style.display = 'block';
            titleEl.textContent = 'Generating...';
            contentEl.textContent = 'Please wait...';
            
            try {
                const response = await fetch('/api/negotiation/document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis: window.currentAnalysisResult,
                        document_type: docType
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.document) {
                    titleEl.textContent = data.document.title;
                    contentEl.textContent = data.document.content;
                } else {
                    titleEl.textContent = 'Error';
                    contentEl.textContent = data.error || 'Failed to generate document';
                }
            } catch (e) {
                titleEl.textContent = 'Error';
                contentEl.textContent = 'Failed to generate document';
            }
        }
        
        function copyDocumentContent() {
            const content = document.getElementById('document-content')?.innerText;
            if (content) {
                navigator.clipboard.writeText(content).then(() => alert('Copied to clipboard!'));
            }
        }
        
        function formatFullPackageResults(data) {
            const strategy = data.strategy || {};
            const confidenceColor = strategy.confidence_level === 'HIGH' ? '#22c55e' : 
                                   strategy.confidence_level === 'LOW' ? '#ef4444' : '#f59e0b';
            
            // Helper to strip markdown formatting
            const stripMarkdown = (text) => text ? String(text).replace(/\*\*/g, '').replace(/\*/g, '').trim() : '';
            
            // Style display
            const styleInfo = {
                'aggressive': { emoji: 'ğŸ”¥', label: 'Aggressive', color: '#ef4444' },
                'balanced': { emoji: 'âš–ï¸', label: 'Balanced', color: '#3b82f6' },
                'collaborative': { emoji: 'ğŸ¤', label: 'Collaborative', color: '#22c55e' }
            };
            const selectedStyle = window.selectedNegotiationStyle || 'balanced';
            const styleData = styleInfo[selectedStyle] || styleInfo['balanced'];
            
            let html = `
                <!-- Style + Confidence Badges -->
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <span style="background: ${styleData.color}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 13px;">
                            ${styleData.emoji} ${styleData.label} Strategy
                        </span>
                        <span style="background: ${confidenceColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 13px;">
                            ${strategy.confidence_level || 'MEDIUM'} CONFIDENCE
                        </span>
                    </div>
                    <div style="color: #94a3b8; font-size: 13px;">
                        Savings: $${(data.potential_savings || 0).toLocaleString()} (${data.savings_percentage || 0}% below asking)
                    </div>
                </div>
            `;
            
            // Recommended Approach
            if (strategy.recommended_approach) {
                html += `
                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="color: #f59e0b; margin: 0 0 12px 0; font-size: 16px;">ğŸ“‹ Recommended Approach</h3>
                        <p style="color: #e2e8f0; margin: 0; line-height: 1.6;">${stripMarkdown(strategy.recommended_approach)}</p>
                    </div>
                `;
            }
            
            // Opening Script
            if (strategy.opening_script) {
                // Clean up the script text for display
                const cleanScript = strategy.opening_script
                    .replace(/\*\*/g, '')  // Remove markdown bold
                    .replace(/\n/g, ' ')   // Replace newlines with spaces
                    .trim();
                
                // Store script text in a global array for safe copy access
                if (!window._negotiationScripts) window._negotiationScripts = [];
                const scriptIdx = window._negotiationScripts.length;
                window._negotiationScripts.push(cleanScript);
                
                html += `
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="color: #a78bfa; margin: 0 0 12px 0; font-size: 16px;">ğŸ¤ Opening Script</h3>
                        <p style="color: #e2e8f0; margin: 0; line-height: 1.6; font-style: italic;">"${cleanScript.replace(/</g, '&lt;').replace(/>/g, '&gt;')}"</p>
                        <button onclick="navigator.clipboard.writeText(window._negotiationScripts[${scriptIdx}]).then(() => { this.textContent = 'âœ… Copied!'; setTimeout(() => this.textContent = 'ğŸ“‹ Copy', 2000); })" style="margin-top: 12px; padding: 8px 16px; background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid #a78bfa; border-radius: 6px; cursor: pointer; font-size: 12px;">ğŸ“‹ Copy</button>
                    </div>
                `;
            }
            
            // Leverage Points
            if (strategy.leverage_points?.length > 0) {
                html += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #60a5fa; margin: 0 0 16px 0; font-size: 16px;">ğŸ’ª Your Leverage Points</h3>
                        ${strategy.leverage_points.map((pt, i) => `
                            <div style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 16px; margin-bottom: 12px; border-radius: 0 8px 8px 0;">
                                <div style="font-weight: 600; color: #e2e8f0; margin-bottom: 8px;">${i + 1}. ${stripMarkdown(pt.point || pt)}</div>
                                ${pt.how_to_use ? `<div style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">ğŸ’¬ ${stripMarkdown(pt.how_to_use)}</div>` : ''}
                                ${pt.potential_value ? `<div style="color: #22c55e; font-size: 13px;">ğŸ’° ${stripMarkdown(pt.potential_value)}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Talking Points
            if (strategy.talking_points?.length > 0) {
                html += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #22c55e; margin: 0 0 16px 0; font-size: 16px;">ğŸ’¬ Talking Points</h3>
                        <ul style="color: #e2e8f0; margin: 0; padding-left: 20px; line-height: 2;">
                            ${strategy.talking_points.map(pt => `<li>${stripMarkdown(pt)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Counter Strategies
            if (strategy.counter_strategies?.length > 0) {
                html += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #f59e0b; margin: 0 0 16px 0; font-size: 16px;">ğŸ›¡ï¸ Counter Their Objections</h3>
                        ${strategy.counter_strategies.map(cs => `
                            <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                                <div style="color: #ef4444; font-size: 13px; margin-bottom: 8px;">âŒ "${stripMarkdown(cs.objection)}"</div>
                                <div style="color: #22c55e; font-size: 13px;">âœ… "${stripMarkdown(cs.response)}"</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Risk Warnings
            if (strategy.risk_warnings?.length > 0) {
                html += `
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="color: #ef4444; margin: 0 0 12px 0; font-size: 16px;">âš ï¸ Watch Out For</h3>
                        <ul style="color: #fca5a5; margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${strategy.risk_warnings.map(w => `<li>${stripMarkdown(w)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Documents Section
            html += `
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 24px; margin-top: 24px;">
                    <h3 style="color: #e2e8f0; margin: 0 0 16px 0; font-size: 16px;">ğŸ“„ Generated Documents</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            `;
            
            // Offer Letter
            if (data.offer_letter) {
                html += `
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 16px;">
                        <div style="font-weight: 600; color: #22c55e; margin-bottom: 8px;">âœ‰ï¸ Offer Letter</div>
                        <button onclick="showDocumentModal('Offer Letter', \`${data.offer_letter.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" style="padding: 8px 12px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; width: 100%;">View & Copy</button>
                    </div>
                `;
            }
            
            // Talking Points Doc
            if (data.talking_points) {
                html += `
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 16px;">
                        <div style="font-weight: 600; color: #60a5fa; margin-bottom: 8px;">ğŸ’¬ Talking Points</div>
                        <button onclick="showDocumentModal('Talking Points', \`${data.talking_points.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; width: 100%;">View & Copy</button>
                    </div>
                `;
            }
            
            // Agent Email
            if (data.agent_email) {
                html += `
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 16px;">
                        <div style="font-weight: 600; color: #a78bfa; margin-bottom: 8px;">ğŸ“§ Agent Email</div>
                        <button onclick="showDocumentModal('Agent Email', \`${data.agent_email.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" style="padding: 8px 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; width: 100%;">View & Copy</button>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            
            return html;
        }
        
        window.showDocumentModal = function(title, content) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10001; padding: 20px;';
            modal.innerHTML = `
                <div style="background: #1e293b; border-radius: 16px; max-width: 600px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #e2e8f0;">${title}</h3>
                        <div>
                            <button onclick="navigator.clipboard.writeText(this.closest('div').parentElement.querySelector('.doc-content').innerText).then(() => this.textContent = 'âœ… Copied!')" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">ğŸ“‹ Copy</button>
                            <button onclick="this.closest('div').parentElement.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #475569; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                        </div>
                    </div>
                    <div class="doc-content" style="padding: 20px; overflow-y: auto; color: #e2e8f0; white-space: pre-wrap; line-height: 1.6;">${content}</div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
        };
        
        // Render with error boundary
        console.log('Rendering OfferWise app...');
        ReactDOM.render(
          <ErrorBoundary>
            <OfferWise />
          </ErrorBoundary>,
          document.getElementById('root')
        );
        console.log('App rendered successfully');
    </script>
    
    <!-- Async Upload Manager - Handles PDF uploads with real-time progress -->
    <script src="/static/async-upload-manager.js"></script>
    
    <!-- Floating Support Button -->
    <a href="/contact" id="support-button" style="
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        padding: 12px 18px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        font-size: 13px;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        display: flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.2s, box-shadow 0.2s;
        z-index: 1000;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(59, 130, 246, 0.5)';"
       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(59, 130, 246, 0.4)';">
        <span style="font-size: 16px;">ğŸ’¬</span>
        Help
    </a>
</body>
</html>
